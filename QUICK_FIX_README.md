# Quick Start: Fix Login Issues

## What Was Wrong?

After 40+ commits, the login flow still wasn't working because:

1. **Missing Environment Variables** - render.yaml didn't include critical variables like REDIS_URL, DATABASE_URL, and SUPABASE credentials
2. **Duplicate Code** - Database had duplicate method definitions causing unpredictable behavior
3. **Inconsistent User IDs** - OAuth and email/password login used different ID strategies

## What Was Fixed?

✅ Added all required environment variables to render.yaml  
✅ Removed duplicate database methods  
✅ Made User ID handling consistent across all login methods  
✅ Fixed code quality issues identified in review  

## What You Need to Do Now

### 1. Set Up Required Services (One Time)

**Create Upstash Redis (for sessions):**
1. Go to https://upstash.com
2. Create a database (Regional, TLS enabled)
3. Copy the Redis URL (starts with `rediss://`)

**Set Up Supabase (for database + OAuth):**
1. Go to https://app.supabase.com
2. Create a project
3. Copy: Project URL, anon key, and database connection string
4. Enable Google OAuth provider in Authentication settings

**Optional: Gmail App Password (for email verification):**
1. Go to Google Account → Security → 2-Step Verification
2. Create App Password for "Mail"
3. Copy the generated password

### 2. Configure Render Environment Variables

Go to your Render service → Environment tab → Add these variables:

**REQUIRED (app won't start without these):**
```
REDIS_URL=rediss://default:XXXXX@upstash.io:6379
DATABASE_URL=postgresql://postgres:XXXXX@db.supabase.co:5432/postgres
SUPABASE_URL=https://XXXXX.supabase.co
SUPABASE_ANON_KEY=eyJhbGci...
```

**OPTIONAL (but recommended):**
```
SUPABASE_REDIRECT_URL=https://your-app.onrender.com/auth/callback
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-gmail-app-password
GEMINI_API_KEY=your-gemini-key
```

**Note:** `SECRET_KEY` and `FLASK_SECRET_KEY` are now auto-generated by Render.

### 3. Configure Supabase OAuth Redirect URLs

1. In Supabase dashboard: Authentication → URL Configuration
2. Add redirect URL: `https://your-app.onrender.com/auth/callback`
3. Also add for local testing: `http://localhost:5000/auth/callback`
4. Save

### 4. Deploy and Test

**Deploy:**
1. Render will auto-deploy when you merge this PR
2. OR manually deploy: Render dashboard → Manual Deploy

**Check logs for success:**
```
✅ Environment loaded
✅ Flask secret key configured
✅ Redis connection successful
✅ Database connected successfully
✅ Flask app initialized and ready to serve requests
```

**Test login:**
1. Go to your app URL
2. Click "Sign in with Google"
3. Should redirect to Google (not 404)
4. Complete OAuth → Should redirect back and show "Welcome!"
5. Refresh page → Should stay logged in (session persists)

### 5. Troubleshooting

**Error: "REDIS_URL not set"**
→ Add REDIS_URL to Render environment variables

**Error: Google OAuth 404**
→ Add redirect URL to Supabase whitelist

**Error: Session lost on refresh**
→ Check REDIS_URL is correct and Redis is accessible
→ Check browser DevTools → Application → Cookies for `resell_rebel_session`

**Still having issues?**
1. Enable debug mode: Add `DEBUG_SESSIONS=true` to environment variables
2. Check Render logs during login attempt
3. Share logs in GitHub issues

## Files Changed

- **render.yaml** - Added all required environment variables with comments
- **DEPLOYMENT_SETUP_GUIDE.md** - Comprehensive step-by-step deployment guide
- **.env.example** - Updated with all required variables for local development
- **src/database/db.py** - Removed duplicate method definition
- **routes_auth.py** - Fixed User ID consistency between login methods

## Next Steps

1. Merge this PR
2. Set up required services (Upstash Redis, Supabase)
3. Configure environment variables in Render
4. Add OAuth redirect URL to Supabase
5. Deploy and test

That's it! Your login flow should now work correctly.

---

**Need help?** See DEPLOYMENT_SETUP_GUIDE.md for detailed instructions.
