<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Flow - Standalone</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <style>
        .image-zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: zoom-out;
        }

        .image-zoom-container {
            position: relative;
            max-width: 95%;
            max-height: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
            border: 2px solid white;
        }

        #zoomImage {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            cursor: zoom-in;
        }

        .zoom-hint {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .photo-preview {
            cursor: pointer;
            transition: transform 0.2s;
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin: 5px;
        }

        .photo-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .photo-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .photo-editor-modal.show {
            display: flex;
        }

        .photo-editor-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }

        .photo-editor-image {
            max-width: 100%;
            max-height: 60vh;
            display: block;
            margin: 0 auto;
        }

        .photo-editor-toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            justify-content: center;
        }

        .photo-preview-container {
            position: relative;
            display: inline-block;
            margin: 5px;
        }

        .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4"><i class="fas fa-camera"></i> Image Flow - Standalone</h2>

        <!-- Photo Upload Section -->
        <div class="card mb-3">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-camera"></i> Photos
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-primary w-100" onclick="document.getElementById('cameraInput').click()">
                            <i class="fas fa-camera"></i><br>Take Photo
                        </button>
                        <input type="file" class="d-none" id="cameraInput" name="photos" accept="image/*" capture="environment" onchange="handlePhotoSelect(event)">
                    </div>
                    <div class="col-6">
                        <button type="button" class="btn btn-outline-secondary w-100" onclick="document.getElementById('photoInput').click()">
                            <i class="fas fa-upload"></i><br>Upload Files
                        </button>
                        <input type="file" class="d-none" id="photoInput" name="photos" multiple accept="image/*" onchange="handlePhotoSelect(event)">
                    </div>
                </div>
                <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
                <button type="button" class="btn btn-secondary mt-2" id="analyzeBtn" style="display:none;">
                    <i class="fas fa-magic"></i> Analyze with AI
                </button>
            </div>
        </div>

        <!-- Analysis Results Area -->
        <div id="analysisResults"></div>

        <!-- Simple Form for Testing (Optional) -->
        <div class="card mb-3" id="testForm" style="display:none;">
            <div class="card-header">
                <i class="fas fa-edit"></i> Form Fields (for testing auto-fill)
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="title" name="title" maxlength="80">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                </div>
                <div class="row">
                    <div class="col-6">
                        <label class="form-label">Price ($)</label>
                        <input type="number" class="form-control" id="price" name="price" step="0.01">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Condition</label>
                        <select class="form-select" id="condition" name="condition">
                            <option value="new">New</option>
                            <option value="like_new">Like New</option>
                            <option value="excellent" selected>Excellent</option>
                            <option value="good">Good</option>
                            <option value="fair">Fair</option>
                            <option value="poor">Poor</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-4">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" id="brand" name="brand">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Size</label>
                        <input type="text" class="form-control" id="size" name="size">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Color</label>
                        <input type="text" class="form-control" id="color" name="color">
                    </div>
                </div>
                <div class="mb-3 mt-3">
                    <label class="form-label">Item Type</label>
                    <select class="form-select" id="item_type" name="item_type">
                        <option value="general" selected>General Item</option>
                        <option value="clothing">Clothing & Accessories</option>
                        <option value="electronics">Electronics</option>
                        <option value="trading_card">Trading Cards (TCG/Sports)</option>
                        <option value="collectible">Collectibles</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Storage Location</label>
                    <input type="text" class="form-control" id="storage_location" name="storage_location" placeholder="B1, C2, Shelf-3, etc.">
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 10001; max-width: 400px;"></div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10002; align-items: center; justify-content: center; color: white; font-size: 24px;">
            <div class="text-center">
                <div class="spinner-border mb-3" role="status"></div>
                <div id="loadingText">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Photo Editor Modal -->
    <div id="photoEditorModal" class="photo-editor-modal">
        <div class="photo-editor-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-magic"></i> Edit Photo (FREE!)</h4>
                <button class="btn btn-outline-danger" onclick="closePhotoEditor()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>

            <div class="text-center mb-3">
                <img id="photoEditorImage" class="photo-editor-image" src="">
            </div>

            <div class="photo-editor-toolbar">
                <button class="btn btn-primary" onclick="enableCrop()">
                    <i class="fas fa-crop"></i> Crop
                </button>
                <button class="btn btn-success" id="cropBtn" onclick="applyCrop()" style="display:none;">
                    <i class="fas fa-check"></i> Apply Crop
                </button>
                <button class="btn btn-danger" id="cancelCropBtn" onclick="cancelCrop()" style="display:none;">
                    <i class="fas fa-times"></i> Cancel Crop
                </button>
                <button class="btn btn-warning" onclick="removeBackground()">
                    <i class="fas fa-magic"></i> Remove Background
                </button>
                <button class="btn btn-secondary" onclick="resetPhoto()">
                    <i class="fas fa-undo"></i> Reset
                </button>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fas fa-gift"></i> <strong>FREE Feature!</strong> Other apps charge $5-20/month for background removal. We give it to you free!
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="imageZoomModal" class="image-zoom-modal" onclick="closeImageZoom()" style="display: none;">
        <div class="image-zoom-container">
            <button class="btn btn-outline-light zoom-close-btn" onclick="closeImageZoom()">
                <i class="fas fa-times"></i>
            </button>
            <img id="zoomImage" src="" alt="Zoomed image">
            <div class="zoom-hint">Click image to zoom | Right-click to see details</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script>
        let uploadedPhotos = [];
        let cropper = null;
        let currentEditingPhotoIndex = null;
        let currentEditingPhotoSrc = null;
        let originalPhotoSrc = null;

        // ========================================
        // PHOTO UPLOAD HANDLING
        // ========================================
        async function handlePhotoSelect(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            // For standalone version, we'll use local previews
            // In real app, you'd upload to server here
            const previewDiv = document.getElementById('photoPreview');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const photoIndex = uploadedPhotos.length;

                // Create blob URL for preview
                const blobUrl = URL.createObjectURL(file);
                uploadedPhotos.push(blobUrl);

                // Create container for photo + delete button
                const container = document.createElement('div');
                container.className = 'photo-preview-container';
                container.style.position = 'relative';
                container.style.display = 'inline-block';
                container.style.margin = '5px';

                // Create image
                const img = document.createElement('img');
                img.src = blobUrl;
                img.className = 'photo-preview';
                img.title = 'Click to edit | Right-click to zoom';

                // Make photo clickable to open editor
                img.onclick = function(e) {
                    e.preventDefault();
                    openPhotoEditor(photoIndex, this.src);
                };

                // Right-click to zoom
                img.oncontextmenu = function(e) {
                    e.preventDefault();
                    openImageZoom(blobUrl);
                };

                // Create delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.style.padding = '2px 6px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.title = 'Remove photo';
                deleteBtn.onclick = function(e) {
                    e.preventDefault();
                    removePhoto(photoIndex);
                };

                container.appendChild(img);
                container.appendChild(deleteBtn);
                previewDiv.appendChild(container);
            }

            document.getElementById('analyzeBtn').style.display = 'block';
            showAlert(`${files.length} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');

            // Reset input so same file can be selected again
            e.target.value = '';
        }

        // ========================================
        // PHOTO EDITOR FUNCTIONS
        // ========================================
        async function openPhotoEditor(photoIndex, photoSrc) {
            currentEditingPhotoIndex = photoIndex;
            originalPhotoSrc = photoSrc;

            const modal = document.getElementById('photoEditorModal');
            const img = document.getElementById('photoEditorImage');

            // Convert blob URL to base64 data URL
            try {
                if (photoSrc.startsWith('blob:')) {
                    // Fetch the blob and convert to base64
                    const response = await fetch(photoSrc);
                    const blob = await response.blob();

                    // Convert blob to base64 using FileReader
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        currentEditingPhotoSrc = reader.result; // This is the base64 data URL
                        img.src = currentEditingPhotoSrc;
                    };
                    reader.readAsDataURL(blob);
                } else {
                    // Already a data URL or regular URL
                    currentEditingPhotoSrc = photoSrc;
                    img.src = photoSrc;
                }
            } catch (error) {
                console.error('Error converting image:', error);
                currentEditingPhotoSrc = photoSrc;
                img.src = photoSrc;
            }

            modal.classList.add('show');

            // Destroy existing cropper if any
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            // Reset buttons
            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        }

        function closePhotoEditor() {
            const modal = document.getElementById('photoEditorModal');
            modal.classList.remove('show');

            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
        }

        function enableCrop() {
            const img = document.getElementById('photoEditorImage');

            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(img, {
                aspectRatio: NaN, // Free aspect ratio
                viewMode: 1,
                responsive: true,
                autoCropArea: 0.8,
                background: false,
                ready: function() {
                    showAlert('Drag to select crop area', 'info');
                }
            });

            // Show crop action buttons
            document.getElementById('cropBtn').style.display = 'inline-block';
            document.getElementById('cancelCropBtn').style.display = 'inline-block';
        }

        async function applyCrop() {
            if (!cropper) return;

            try {
                const canvas = cropper.getCroppedCanvas();
                const croppedImage = canvas.toDataURL('image/png');

                // Update the photo
                updatePhotoAfterEdit(croppedImage, null);
                showAlert('Photo cropped successfully!', 'success');

                // Cleanup cropper
                cropper.destroy();
                cropper = null;
                document.getElementById('cropBtn').style.display = 'none';
                document.getElementById('cancelCropBtn').style.display = 'none';
            } catch (error) {
                showAlert('Crop failed: ' + error.message, 'danger');
            }
        }

        function cancelCrop() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        }

        async function removeBackground() {
            if (!currentEditingPhotoSrc) return;

            showLoading();
            showAlert('Removing background... This may take 10-15 seconds', 'info');

            try {
                // Create abort controller for timeout
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

                const response = await fetch('/api/edit-photo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        image: uploadedPhotos[currentEditingPhotoIndex],
                        operation: 'remove-bg'
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeout);

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Update the photo in uploadedPhotos array
                    uploadedPhotos[currentEditingPhotoIndex] = data.filepath;
                    // Update the editor image
                    document.getElementById('photoEditorImage').src = data.filepath;
                    currentEditingPhotoSrc = data.filepath;
                    showAlert('Background removed! (FREE feature worth $5-20/mo)', 'success');
                } else {
                    showAlert('Background removal failed: ' + (data.error || 'Unknown error'), 'danger');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    showAlert('Background removal timed out. The image may be too large. Try a smaller image or crop it first.', 'warning');
                } else {
                    showAlert('Background removal failed: ' + error.message, 'danger');
                }
            } finally {
                hideLoading();
            }
        }

        function resetPhoto() {
            if (!originalPhotoSrc) return;

            const img = document.getElementById('photoEditorImage');
            img.src = originalPhotoSrc;
            currentEditingPhotoSrc = originalPhotoSrc;

            // Update the preview thumbnail
            const previews = document.querySelectorAll('.photo-preview');
            if (previews[currentEditingPhotoIndex]) {
                previews[currentEditingPhotoIndex].src = originalPhotoSrc;
            }

            if (cropper) {
                cropper.destroy();
                cropper = null;
            }

            showAlert('Photo reset to original', 'info');
        }

        // ========================================
        // REMOVE PHOTO
        // ========================================
        function removePhoto(index) {
            if (confirm('Remove this photo?')) {
                // Remove from uploadedPhotos array
                uploadedPhotos.splice(index, 1);

                // Rebuild preview display
                const previewDiv = document.getElementById('photoPreview');
                previewDiv.innerHTML = '';

                // Re-render all photos with updated indices
                for (let i = 0; i < uploadedPhotos.length; i++) {
                    const photoPath = uploadedPhotos[i];

                    // Create container
                    const container = document.createElement('div');
                    container.className = 'photo-preview-container';
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';
                    container.style.margin = '5px';

                    // Create image
                    const img = document.createElement('img');
                    img.src = photoPath;
                    img.className = 'photo-preview';
                    img.title = 'Click to edit | Right-click to zoom';

                    // Click to edit
                    const photoIndex = i;
                    img.onclick = function(e) {
                        e.preventDefault();
                        openPhotoEditor(photoIndex, this.src);
                    };

                    // Right-click to zoom
                    img.oncontextmenu = function(e) {
                        e.preventDefault();
                        openImageZoom(photoPath);
                    };

                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '5px';
                    deleteBtn.style.right = '5px';
                    deleteBtn.style.padding = '2px 6px';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.title = 'Remove photo';
                    deleteBtn.onclick = function(e) {
                        e.preventDefault();
                        removePhoto(photoIndex);
                    };

                    container.appendChild(img);
                    container.appendChild(deleteBtn);
                    previewDiv.appendChild(container);
                }

                showAlert('Photo removed', 'info');

                // Hide analyze button if no photos left
                if (uploadedPhotos.length === 0) {
                    document.getElementById('analyzeBtn').style.display = 'none';
                }
            }
        }

        // ========================================
        // IMAGE ZOOM MODAL
        // ========================================
        function openImageZoom(imageSrc) {
            const modal = document.getElementById('imageZoomModal');
            const zoomImage = document.getElementById('zoomImage');
            zoomImage.src = imageSrc;
            modal.style.display = 'flex';

            // Prevent body scroll when modal is open
            document.body.style.overflow = 'hidden';
        }

        function closeImageZoom(event) {
            // Prevent closing if clicking on the close button (handled by button's onclick)
            if (event && event.target.classList.contains('zoom-close-btn')) {
                return;
            }

            const modal = document.getElementById('imageZoomModal');
            modal.style.display = 'none';

            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Close zoom modal on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeImageZoom();
            }
        });

        // ========================================
        // UPDATE PHOTO AFTER EDIT
        // ========================================
        function updatePhotoAfterEdit(newImageData, newFilepath) {
            // Update the modal image
            const img = document.getElementById('photoEditorImage');
            img.src = newImageData;
            currentEditingPhotoSrc = newImageData;

            // Update the preview thumbnail
            const previews = document.querySelectorAll('.photo-preview');
            if (previews[currentEditingPhotoIndex]) {
                previews[currentEditingPhotoIndex].src = newImageData;
            }

            // Update the uploaded photos array with new filepath
            if (newFilepath) {
                uploadedPhotos[currentEditingPhotoIndex] = newFilepath;
            } else {
                // If no filepath provided, update with data URL
                uploadedPhotos[currentEditingPhotoIndex] = newImageData;
            }
        }

        // ========================================
        // HELPER FUNCTIONS
        // ========================================
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" onclick="document.getElementById('${alertId}').remove()"></button>
            `;
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const el = document.getElementById(alertId);
                if (el) el.remove();
            }, 5000);
        }

        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // ========================================
        // AI ANALYSIS - TWO-TIER SYSTEM
        // ========================================
        let detectedCardData = null;
        let detectedCollectibleData = null;
        let enhancedScanData = null;

        // TIER 1: Quick Analysis (Gemini - Fast & Cheap)
        document.getElementById('analyzeBtn').addEventListener('click', async function() {
            showLoading('Running quick analysis...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        photos: uploadedPhotos
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    showAlert(data.error || 'Analysis failed', 'danger');
                    hideLoading();
                    return;
                }

                const analysis = data.analysis;

                // Show test form if it exists
                const testForm = document.getElementById('testForm');
                if (testForm) {
                    testForm.style.display = 'block';
                }

                // Fill form with basic info
                if (analysis.suggested_title && document.getElementById('title')) {
                    document.getElementById('title').value = analysis.suggested_title;
                }
                if (analysis.description && document.getElementById('description')) {
                    document.getElementById('description').value = analysis.description;
                }
                if (analysis.brand && document.getElementById('brand')) {
                    document.getElementById('brand').value = analysis.brand;
                }
                if (analysis.size && document.getElementById('size')) {
                    document.getElementById('size').value = analysis.size;
                }
                if (analysis.color && document.getElementById('color')) {
                    document.getElementById('color').value = analysis.color;
                }
                if (analysis.suggested_price && document.getElementById('price')) {
                    document.getElementById('price').value = analysis.suggested_price;
                }
                if (analysis.condition && document.getElementById('condition')) {
                    const condition = analysis.condition.replace(' ', '_').toLowerCase();
                    document.getElementById('condition').value = condition;
                }

                // Check if Enhanced Scan would be helpful
                const isCard = analysis.category === 'Trading Cards' || analysis.category === 'Sports Cards';
                const isCollectible = analysis.collectible === true;

                if (isCard || isCollectible) {
                    showEnhancedScanOption(isCard, isCollectible, analysis);
                }

                // Show market analysis if available
                if (analysis.market_analysis) {
                    showMarketAnalysis(analysis.market_analysis);
                }

                showAlert('Quick analysis complete!', 'success');

            } catch (error) {
                showAlert('Analysis failed: ' + error, 'danger');
            } finally {
                hideLoading();
            }
        });

        // Show subtle Enhanced Scan option
        function showEnhancedScanOption(isCard, isCollectible, analysis) {
            // Remove existing if present
            document.getElementById('enhancedScanCard')?.remove();

            let scanType = isCard ? 'card' : 'collectible';
            let icon = isCard ? 'fa-id-card' : 'fa-star';
            let message = isCard 
                ? 'Get detailed card analysis, TCGPlayer prices, and authentication'
                : 'Get rarity info, franchise history, and authentication markers';

            const enhancedScanCard = `
                <div class="card border-primary mb-3" id="enhancedScanCard">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">
                                    <i class="fas ${icon} text-primary"></i> 
                                    Enhanced Scanner Available
                                </h6>
                                <small class="text-muted">${message}</small>
                            </div>
                            <button class="btn btn-primary" onclick="runEnhancedScan()">
                                <i class="fas fa-microscope"></i> Enhanced Scan
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Insert after photo card
            const resultsArea = document.getElementById('analysisResults');
            resultsArea.innerHTML = enhancedScanCard;
        }

        // Show market analysis
        function showMarketAnalysis(market) {
            // Remove existing if present
            document.getElementById('marketAnalysisCard')?.remove();

            let demandColor = market.demand_level === 'High' ? 'success' :
                             market.demand_level === 'Low' ? 'danger' : 'warning';

            let marketCard = `
                <div class="card border-info mb-3" id="marketAnalysisCard">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-chart-line"></i> Market Analysis
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Sell-Through Rate:</strong><br>
                                <span class="h4">${market.sell_through_rate}%</span> ${getDemandEmoji(market.demand_level)}
                            </div>
                            <div class="col-md-3">
                                <strong>Demand:</strong><br>
                                <span class="badge bg-${demandColor} fs-6">${market.demand_level}</span>
                            </div>
                            <div class="col-md-3">
                                <strong>Est. Days to Sell:</strong><br>
                                <span class="h5">${market.days_to_sell_estimate}</span> days
                            </div>
                            <div class="col-md-3">
                                <strong>Avg Sold Price:</strong><br>
                                <span class="h5 text-success">$${market.average_sold_price?.toFixed(2) || 'N/A'}</span>
                            </div>
                        </div>
                        ${market.market_insights?.length > 0 ? `
                            <hr>
                            <small class="text-muted">${market.market_insights.join(' ‚Ä¢ ')}</small>
                        ` : ''}
                    </div>
                </div>
            `;

            const resultsArea = document.getElementById('analysisResults');
            const enhancedScanCard = document.getElementById('enhancedScanCard');
            if (enhancedScanCard) {
                enhancedScanCard.insertAdjacentHTML('afterend', marketCard);
            } else {
                resultsArea.insertAdjacentHTML('beforeend', marketCard);
            }
        }

        function getDemandEmoji(demand) {
            if (demand === 'High') return 'üî•';
            if (demand === 'Low') return 'üêå';
            return 'üìà';
        }

        // TIER 2: Enhanced Scanner (Claude - Deep Dive)
        async function runEnhancedScan() {
            showLoading('Running enhanced scan... This may take 10-20 seconds');

            try {
                const response = await fetch('/api/enhanced-scan', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        photos: uploadedPhotos
                    })
                });

                const data = await response.json();

                if (!data.success) {
                    if (data.type === 'standard_item') {
                        showAlert('Not a collectible. Quick analysis is sufficient for this item.', 'info');
                    } else {
                        showAlert(data.error || data.message || 'Enhanced scan failed', 'danger');
                    }
                    hideLoading();
                    return;
                }

                // Store enhanced scan data
                enhancedScanData = data;

                // Remove the "run enhanced scan" card
                document.getElementById('enhancedScanCard')?.remove();

                // Display results based on type
                if (data.type === 'card') {
                    detectedCardData = data.data;
                    showCardResults(data);
                } else if (data.type === 'collectible') {
                    detectedCollectibleData = data.data;
                    showCollectibleResults(data);
                }

                showAlert('Enhanced scan complete!', 'success');

            } catch (error) {
                showAlert('Enhanced scan failed: ' + error, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Display Card Results
        function showCardResults(data) {
            const cardData = data.data;
            const prices = data.market_prices || {};

            const statsCard = `
                <div class="card border-success mb-3" id="enhancedResultsCard">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-id-card"></i> Card Analysis Complete
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>${cardData.card_name || cardData.player_name || 'Unknown Card'}</h5>
                                ${cardData.set_name ? `<p class="mb-1"><strong>Set:</strong> ${cardData.set_name}</p>` : ''}
                                ${cardData.card_number ? `<p class="mb-1"><strong>Number:</strong> #${cardData.card_number}</p>` : ''}
                                ${cardData.rarity ? `<p class="mb-1"><strong>Rarity:</strong> ${cardData.rarity}</p>` : ''}
                                ${cardData.year ? `<p class="mb-1"><strong>Year:</strong> ${cardData.year}</p>` : ''}
                                ${cardData.brand ? `<p class="mb-1"><strong>Brand:</strong> ${cardData.brand}</p>` : ''}
                                ${cardData.is_rookie_card ? `<p class="mb-1"><span class="badge bg-warning">ROOKIE CARD</span></p>` : ''}
                                ${cardData.is_graded ? `<p class="mb-1"><strong>Graded:</strong> ${cardData.grading_company} ${cardData.grading_score}</p>` : ''}
                            </div>
                            <div class="col-md-6">
                                <h6>Market Prices</h6>
                                ${prices.tcgplayer ? `<p class="mb-1"><strong>TCGPlayer:</strong> $${prices.tcgplayer.market || 'N/A'}</p>` : ''}
                                ${prices.ebay ? `<p class="mb-1"><strong>eBay Sold Avg:</strong> $${prices.ebay.avg || 'N/A'}</p>` : ''}
                                ${prices.actual_selling ? `<p class="mb-1 text-success"><strong>Actual Selling:</strong> $${prices.actual_selling}</p>` : ''}
                                ${prices.quick_sale ? `<p class="mb-1 text-warning"><strong>Quick Sale:</strong> $${prices.quick_sale}</p>` : ''}
                                ${cardData.estimated_value_low && cardData.estimated_value_high ? `
                                    <p class="mb-1"><strong>Est. Range:</strong> $${cardData.estimated_value_low} - $${cardData.estimated_value_high}</p>
                                ` : ''}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="storeCardOnly()">
                                <i class="fas fa-box"></i> Store in Collection
                            </button>
                            <button class="btn btn-outline-success" onclick="storeAndList()">
                                <i class="fas fa-plus-circle"></i> Store + Create Listing
                            </button>
                            ${data.public_db_id ? `
                                <button class="btn btn-outline-info" onclick="window.open('/collectibles-database/${data.public_db_id}', '_blank')">
                                    <i class="fas fa-database"></i> View in Database
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Remove existing results
            document.getElementById('enhancedResultsCard')?.remove();
            
            // Insert after market analysis or in results area
            const insertAfter = document.getElementById('marketAnalysisCard') || document.getElementById('analysisResults');
            insertAfter.insertAdjacentHTML('beforeend', statsCard);

            // Fill form with detailed card info
            fillFormFromCardData(cardData, prices);
        }

        // Display Collectible Results
        function showCollectibleResults(data) {
            const collectibleData = data.data;
            const prices = data.market_prices || {};

            const collectibleCard = `
                <div class="card border-warning mb-3" id="enhancedResultsCard">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-star"></i> Collectible Analysis Complete
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>${collectibleData.item_name || 'Unknown Collectible'}</h5>
                                <p class="mb-2"><strong>Franchise:</strong> ${collectibleData.franchise}</p>
                                
                                ${collectibleData.item_significance ? `
                                    <h6 class="mt-3">About This Item</h6>
                                    <p class="small">${collectibleData.item_significance}</p>
                                ` : ''}
                                
                                ${collectibleData.rarity_info ? `
                                    <h6 class="mt-3">Rarity Analysis</h6>
                                    <p class="small">${collectibleData.rarity_info}</p>
                                ` : ''}
                                
                                ${collectibleData.authentication_markers?.length > 0 ? `
                                    <h6 class="mt-3">Authentication Markers</h6>
                                    <ul class="small">
                                        ${collectibleData.authentication_markers.map(m => `<li>${m}</li>`).join('')}
                                    </ul>
                                ` : ''}
                            </div>
                            <div class="col-md-4">
                                <h6>Market Analysis</h6>
                                ${prices.retail ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Retail Price</small>
                                        <div class="h5">$${prices.retail}</div>
                                    </div>
                                ` : ''}
                                ${prices.actual_selling ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Actual Selling</small>
                                        <div class="h5 text-success">$${prices.actual_selling}</div>
                                    </div>
                                ` : ''}
                                ${prices.quick_sale ? `
                                    <div class="mb-2">
                                        <small class="text-muted">Quick Sale</small>
                                        <div class="h5 text-warning">$${prices.quick_sale}</div>
                                    </div>
                                ` : ''}
                                
                                ${collectibleData.rarity_score ? `
                                    <div class="mt-3">
                                        <small class="text-muted">Rarity Score</small>
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" style="width: ${collectibleData.rarity_score}%">
                                                ${collectibleData.rarity_score}/100
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-warning" onclick="storeCollectibleOnly()">
                                <i class="fas fa-archive"></i> Add to Collection
                            </button>
                            <button class="btn btn-outline-warning" onclick="storeCollectibleAndList()">
                                <i class="fas fa-plus-circle"></i> Store + Create Listing
                            </button>
                            ${data.public_db_id ? `
                                <button class="btn btn-outline-info" onclick="window.open('/collectibles-database/${data.public_db_id}', '_blank')">
                                    <i class="fas fa-database"></i> View in Database
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Remove existing results
            document.getElementById('enhancedResultsCard')?.remove();
            
            // Insert after market analysis or in results area
            const insertAfter = document.getElementById('marketAnalysisCard') || document.getElementById('analysisResults');
            insertAfter.insertAdjacentHTML('beforeend', collectibleCard);

            // Fill form with collectible info
            fillFormFromCollectible(collectibleData, prices);
        }

        // Fill form from card data
        function fillFormFromCardData(cardData, prices) {
            // Build title
            let title = '';
            if (cardData.player_name) {
                // Sports card
                title = cardData.player_name;
                if (cardData.year) title = `${cardData.year} ${title}`;
                if (cardData.brand) title = `${title} ${cardData.brand}`;
                if (cardData.series) title = `${title} ${cardData.series}`;
                if (cardData.card_number) title = `${title} #${cardData.card_number}`;
                if (cardData.is_rookie_card) title = `${title} RC`;
            } else {
                // TCG card
                title = cardData.card_name || 'Unknown Card';
                if (cardData.card_number) title = `${title} #${cardData.card_number}`;
            }

            if (document.getElementById('title')) {
                document.getElementById('title').value = title.substring(0, 80);
            }

            // Build description
            let description = '';
            if (cardData.set_name) description += `Set: ${cardData.set_name}\n`;
            if (cardData.rarity) description += `Rarity: ${cardData.rarity}\n`;
            if (cardData.is_graded && cardData.grading_company) {
                description += `Graded: ${cardData.grading_company} ${cardData.grading_score || ''}\n`;
            }
            if (cardData.parallel) description += `Parallel: ${cardData.parallel}\n`;

            if (document.getElementById('description')) {
                document.getElementById('description').value = description;
            }

            // Set brand
            if (cardData.brand && document.getElementById('brand')) {
                document.getElementById('brand').value = cardData.brand;
            }

            // Set price from market data
            if (document.getElementById('price')) {
                if (prices.actual_selling) {
                    document.getElementById('price').value = prices.actual_selling;
                } else if (cardData.estimated_value_low && cardData.estimated_value_high) {
                    const avgValue = (cardData.estimated_value_low + cardData.estimated_value_high) / 2;
                    document.getElementById('price').value = avgValue.toFixed(2);
                }
            }

            // Set item type
            if (document.getElementById('item_type')) {
                document.getElementById('item_type').value = 'trading_card';
            }

            // Set condition
            if (cardData.is_graded && cardData.grading_score && document.getElementById('condition')) {
                if (cardData.grading_score >= 9) {
                    document.getElementById('condition').value = 'excellent';
                } else if (cardData.grading_score >= 7) {
                    document.getElementById('condition').value = 'good';
                } else {
                    document.getElementById('condition').value = 'fair';
                }
            }
        }

        // Fill form from collectible data
        function fillFormFromCollectible(collectibleData, prices) {
            // Set title
            if (collectibleData.item_name && document.getElementById('title')) {
                document.getElementById('title').value = collectibleData.item_name.substring(0, 80);
            }

            // Set description
            let description = '';
            if (collectibleData.franchise) description += `Franchise: ${collectibleData.franchise}\n\n`;
            if (collectibleData.item_significance) description += `${collectibleData.item_significance}\n\n`;
            if (collectibleData.rarity_info) description += `Rarity: ${collectibleData.rarity_info}\n`;

            if (document.getElementById('description')) {
                document.getElementById('description').value = description;
            }

            // Set brand
            if (collectibleData.brand && document.getElementById('brand')) {
                document.getElementById('brand').value = collectibleData.brand;
            }

            // Set price
            if (document.getElementById('price')) {
                if (prices.actual_selling) {
                    document.getElementById('price').value = prices.actual_selling;
                } else if (prices.retail) {
                    document.getElementById('price').value = prices.retail;
                }
            }

            // Set item type
            if (document.getElementById('item_type')) {
                document.getElementById('item_type').value = 'collectible';
            }
        }

        // Store card only (no listing)
        async function storeCardOnly() {
            if (!detectedCardData) {
                showAlert('No card data available', 'danger');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/cards/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ai_result: detectedCardData,
                        photos: uploadedPhotos,
                        storage_location: document.getElementById('storage_location')?.value || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Card stored in your collection! Redirecting...', 'success');
                    setTimeout(() => {
                        if (window.location.pathname !== '/cards') {
                            showAlert('Would redirect to /cards in real app', 'info');
                        }
                    }, 1500);
                } else {
                    showAlert(data.error || 'Failed to add card', 'danger');
                    hideLoading();
                }
            } catch (error) {
                showAlert('Failed to add card: ' + error, 'danger');
                hideLoading();
            }
        }

        // Store card + create listing
        async function storeAndList() {
            if (!detectedCardData) {
                showAlert('No card data available', 'danger');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/cards/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ai_result: detectedCardData,
                        photos: uploadedPhotos,
                        storage_location: document.getElementById('storage_location')?.value || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Card added! Continue filling out the form to create a listing.', 'success');
                    
                    // Update the results card
                    const resultsCard = document.getElementById('enhancedResultsCard');
                    if (resultsCard) {
                        resultsCard.classList.remove('border-success');
                        resultsCard.classList.add('border-info');
                        resultsCard.querySelector('.card-header').classList.remove('bg-success');
                        resultsCard.querySelector('.card-header').classList.add('bg-info');
                        resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Card Stored - Create Listing Below';
                    }
                } else {
                    showAlert(data.error || 'Failed to add card', 'danger');
                }
            } catch (error) {
                showAlert('Failed to add card: ' + error, 'danger');
            } finally {
                hideLoading();
            }
        }

        // Store collectible only (no listing)
        async function storeCollectibleOnly() {
            if (!detectedCollectibleData) {
                showAlert('No collectible data available', 'danger');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/collectibles/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ai_result: detectedCollectibleData,
                        photos: uploadedPhotos,
                        storage_location: document.getElementById('storage_location')?.value || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Collectible stored! Redirecting...', 'success');
                    setTimeout(() => {
                        if (window.location.pathname !== '/my-collection') {
                            showAlert('Would redirect to /my-collection in real app', 'info');
                        }
                    }, 1500);
                } else {
                    showAlert(data.error || 'Failed to add collectible', 'danger');
                    hideLoading();
                }
            } catch (error) {
                showAlert('Failed to add collectible: ' + error, 'danger');
                hideLoading();
            }
        }

        // Store collectible + create listing
        async function storeCollectibleAndList() {
            if (!detectedCollectibleData) {
                showAlert('No collectible data available', 'danger');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/collectibles/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ai_result: detectedCollectibleData,
                        photos: uploadedPhotos,
                        storage_location: document.getElementById('storage_location')?.value || null
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showAlert('Collectible added! Continue filling out the form to create a listing.', 'success');
                    
                    // Update the results card
                    const resultsCard = document.getElementById('enhancedResultsCard');
                    if (resultsCard) {
                        resultsCard.classList.remove('border-warning');
                        resultsCard.classList.add('border-info');
                        resultsCard.querySelector('.card-header').classList.remove('bg-warning');
                        resultsCard.querySelector('.card-header').classList.add('bg-info');
                        resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Collectible Stored - Create Listing Below';
                    }
                } else {
                    showAlert(data.error || 'Failed to add collectible', 'danger');
                }
            } catch (error) {
                showAlert('Failed to add collectible: ' + error, 'danger');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>

