========================================
FRONTEND IMAGE FLOW - JAVASCRIPT
========================================
File: templates/create.html (lines 295-739)
Purpose: Photo upload, editing, and management JavaScript

========================================
⚠️  NON-NEGOTIABLE RULES ⚠️
========================================

1. **TEMPLATE VARIABLES IN JAVASCRIPT - CRITICAL**

   ❌ NEVER DO THIS:
   ```javascript
   const value = {{ some_variable }};  // If None in Python, breaks JavaScript!
   ```

   ✅ ALWAYS DO THIS:
   ```jinja
   {% if some_variable is not none %}
   const value = {{ some_variable }};
   {% endif %}
   ```

2. **GUEST USER HANDLING - EXACT PATTERN REQUIRED**

   When using guest_uses_remaining or any guest-specific variables:

   ❌ WRONG - Missing is_guest check:
   ```jinja
   {% if guest_uses_remaining is not none %}
   const newRemaining = Math.max(0, {{ guest_uses_remaining }} - 1);
   {% endif %}
   ```

   ❌ WRONG - Duplicate if statements:
   ```jinja
   {% if is_guest and guest_uses_remaining is not none %}
     {% if guest_uses_remaining is not none %}  <!-- DUPLICATE! -->
       const newRemaining = ...
     {% endif %}
   {% endif %}
   ```

   ✅ CORRECT - Check BOTH conditions in ONE if:
   ```jinja
   {% if is_guest and guest_uses_remaining is not none %}
   const newRemaining = Math.max(0, {{ guest_uses_remaining }} - 1);
   // ... rest of guest-specific code
   {% endif %}
   ```

3. **EVENT HANDLERS - USE INLINE HANDLERS**

   ✅ CORRECT - Inline handlers:
   ```html
   <button onclick="document.getElementById('cameraInput').click()">
   <input onchange="handlePhotoSelect(event)">
   ```

   ❌ WRONG - addEventListener (timing issues, overcomplicated):
   ```javascript
   button.addEventListener('click', function() { ... });
   ```

4. **WHEN CODE BREAKS**

   a) Check browser console for ALL errors (not just the obvious one)
   b) Look for "Illegal return statement" or "SyntaxError"
   c) Search for template variables: `grep -n "{{" templates/create.html`
   d) If user says "check this working branch" - DO IT IMMEDIATELY
   e) Copy working code EXACTLY - don't "improve" it

5. **TESTING REQUIREMENTS**

   MUST test with BOTH:
   - Guest users (is_guest=True, guest_uses_remaining=0-8)
   - Logged-in users (is_guest=False, guest_uses_remaining=None)

   If it works for one but not the other, it's a template variable issue.

6. **REFERENCE BRANCH**

   The working reference implementation is in:
   `claude/update-website-logo-vfdYM`

   Before making changes, ALWAYS check this branch first.
   If your code doesn't match it, you're probably doing it wrong.

========================================
// VARIABLES
========================================
let uploadedPhotos = [];
let editingDraftId = null;
let editingListingUuid = null;

let cropper = null;
let currentEditingPhotoIndex = null;
let currentEditingPhotoSrc = null;
let originalPhotoSrc = null;

let detectedCardData = null;
let detectedCollectibleData = null;
let enhancedScanData = null;

// ========================================
// PHOTO UPLOAD HANDLER
// ========================================
async function handlePhotoSelect(e) {
    const files = e.target.files;
    if (files.length === 0) return;

    const formData = new FormData();
    for (let file of files) {
        formData.append('photos', file);
    }

    showLoading();

    try {
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Append to existing photos instead of replacing
            uploadedPhotos = uploadedPhotos.concat(data.paths);

            // Show previews (append to existing)
            const previewDiv = document.getElementById('photoPreview');
            for (let i = 0; i < files.length; i++) {
                const photoIndex = uploadedPhotos.length - data.paths.length + i;

                // Create container for photo + delete button
                const container = document.createElement('div');
                container.className = 'photo-preview-container';
                container.style.position = 'relative';
                container.style.display = 'inline-block';
                container.style.margin = '5px';

                // Create image
                const img = document.createElement('img');
                img.src = URL.createObjectURL(files[i]);
                img.className = 'photo-preview';
                img.title = 'Click to edit | Right-click to zoom';

                // Make photo clickable to open editor
                img.onclick = function(e) {
                    e.preventDefault();
                    openPhotoEditor(photoIndex, this.src);
                };

                // Right-click to zoom
                img.oncontextmenu = function(e) {
                    e.preventDefault();
                    openImageZoom(data.paths[i]);
                };

                // Create delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.style.padding = '2px 6px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.title = 'Remove photo';
                deleteBtn.onclick = function(e) {
                    e.preventDefault();
                    removePhoto(photoIndex);
                };

                container.appendChild(img);
                container.appendChild(deleteBtn);
                previewDiv.appendChild(container);
            }

            document.getElementById('analyzeBtn').style.display = 'block';
            showAlert(`${data.count} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }

    // Reset input so same file can be selected again
    e.target.value = '';
}

// ========================================
// PHOTO EDITOR FUNCTIONS
// ========================================
async function openPhotoEditor(photoIndex, photoSrc) {
    currentEditingPhotoIndex = photoIndex;
    originalPhotoSrc = photoSrc;

    const modal = document.getElementById('photoEditorModal');
    const img = document.getElementById('photoEditorImage');

    // Convert blob URL to base64 data URL
    try {
        if (photoSrc.startsWith('blob:')) {
            // Fetch the blob and convert to base64
            const response = await fetch(photoSrc);
            const blob = await response.blob();

            // Convert blob to base64 using FileReader
            const reader = new FileReader();
            reader.onloadend = function() {
                currentEditingPhotoSrc = reader.result; // This is the base64 data URL
                img.src = currentEditingPhotoSrc;
            };
            reader.readAsDataURL(blob);
        } else {
            // Already a data URL or regular URL
            currentEditingPhotoSrc = photoSrc;
            img.src = photoSrc;
        }
    } catch (error) {
        console.error('Error converting image:', error);
        currentEditingPhotoSrc = photoSrc;
        img.src = photoSrc;
    }

    modal.classList.add('show');

    // Destroy existing cropper if any
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    // Reset buttons
    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('show');

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function enableCrop() {
    const img = document.getElementById('photoEditorImage');

    if (cropper) {
        cropper.destroy();
    }

    cropper = new Cropper(img, {
        aspectRatio: NaN, // Free aspect ratio
        viewMode: 1,
        responsive: true,
        autoCropArea: 0.8,
        background: false,
        ready: function() {
            showAlert('Drag to select crop area', 'info');
        }
    });

    // Show crop action buttons
    document.getElementById('cropBtn').style.display = 'inline-block';
    document.getElementById('cancelCropBtn').style.display = 'inline-block';
}

async function applyCrop() {
    if (!cropper) return;

    showLoading();

    try {
        const canvas = cropper.getCroppedCanvas();
        const croppedImage = canvas.toDataURL('image/png');

        // Get crop coordinates for API call
        const cropData = cropper.getData();

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'crop',
                crop: {
                    x: Math.round(cropData.x),
                    y: Math.round(cropData.y),
                    width: Math.round(cropData.width),
                    height: Math.round(cropData.height)
                }
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo cropped successfully!', 'success');

            // Cleanup cropper
            cropper.destroy();
            cropper = null;
            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        } else {
            showAlert('Crop failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Crop timed out. Please try again.', 'warning');
        } else {
            showAlert('Crop failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function cancelCrop() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

async function removeBackground() {
    if (!currentEditingPhotoSrc) return;

    showLoading();
    showAlert('Removing background... This may take 10-15 seconds', 'info');

    try {
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: uploadedPhotos[currentEditingPhotoIndex],
                operation: 'remove-bg'
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo in uploadedPhotos array
            uploadedPhotos[currentEditingPhotoIndex] = data.filepath;
            // Update the editor image
            document.getElementById('photoEditorImage').src = data.filepath;
            currentEditingPhotoSrc = data.filepath;
            showAlert('Background removed! (FREE feature worth $5-20/mo)', 'success');
        } else {
            showAlert('Background removal failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Background removal timed out. The image may be too large. Try a smaller image or crop it first.', 'warning');
        } else {
            showAlert('Background removal failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function resetPhoto() {
    if (!originalPhotoSrc) return;

    const img = document.getElementById('photoEditorImage');
    img.src = originalPhotoSrc;
    currentEditingPhotoSrc = originalPhotoSrc;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = originalPhotoSrc;
    }

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    showAlert('Photo reset to original', 'info');
}

// Remove photo function
function removePhoto(index) {
    if (confirm('Remove this photo?')) {
        // Remove from uploadedPhotos array
        uploadedPhotos.splice(index, 1);

        // Rebuild preview display
        const previewDiv = document.getElementById('photoPreview');
        previewDiv.innerHTML = '';

        // Re-render all photos with updated indices
        for (let i = 0; i < uploadedPhotos.length; i++) {
            const photoPath = uploadedPhotos[i];

            // Create container
            const container = document.createElement('div');
            container.className = 'photo-preview-container';
            container.style.position = 'relative';
            container.style.display = 'inline-block';
            container.style.margin = '5px';

            // Create image
            const img = document.createElement('img');
            img.src = photoPath;
            img.className = 'photo-preview';
            img.title = 'Click to edit | Right-click to zoom';

            // Click to edit
            const photoIndex = i;
            img.onclick = function(e) {
                e.preventDefault();
                openPhotoEditor(photoIndex, this.src);
            };

            // Right-click to zoom
            img.oncontextmenu = function(e) {
                e.preventDefault();
                openImageZoom(photoPath);
            };

            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.style.fontSize = '12px';
            deleteBtn.title = 'Remove photo';
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                removePhoto(photoIndex);
            };

            container.appendChild(img);
            container.appendChild(deleteBtn);
            previewDiv.appendChild(container);
        }

        showAlert('Photo removed', 'info');

        // Hide analyze button if no photos left
        if (uploadedPhotos.length === 0) {
            document.getElementById('analyzeBtn').style.display = 'none';
        }
    }
}

// Zoom modal functions
function openImageZoom(imageSrc) {
    const modal = document.getElementById('imageZoomModal');
    const zoomImage = document.getElementById('zoomImage');
    zoomImage.src = imageSrc;
    modal.style.display = 'flex';

    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

function closeImageZoom(event) {
    // Prevent closing if clicking on the close button (handled by button's onclick)
    if (event && event.target.classList.contains('zoom-close-btn')) {
        return;
    }

    const modal = document.getElementById('imageZoomModal');
    modal.style.display = 'none';

    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Close zoom modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageZoom();
    }
});

function updatePhotoAfterEdit(newImageData, newFilepath) {
    // Update the modal image
    const img = document.getElementById('photoEditorImage');
    img.src = newImageData;
    currentEditingPhotoSrc = newImageData;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = newImageData;
    }

    // Update the uploaded photos array with new filepath
    if (newFilepath) {
        uploadedPhotos[currentEditingPhotoIndex] = newFilepath;
    }
}

