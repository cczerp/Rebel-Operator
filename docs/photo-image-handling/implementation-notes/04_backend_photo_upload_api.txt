========================================
BACKEND PHOTO UPLOAD API
========================================
File: routes_main.py (lines 56-158)
Purpose: Handle photo uploads with compression

ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp', 'heic'}

def allowed_file(filename):
    """Check if file extension is allowed"""
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def compress_image(image_file, max_size_mb=2, quality=85):
    """Compress image to reduce file size"""
    try:
        # Read image
        img = Image.open(image_file)

        # Convert RGBA to RGB if needed
        if img.mode in ('RGBA', 'LA', 'P'):
            background = Image.new('RGB', img.size, (255, 255, 255))
            if img.mode == 'P':
                img = img.convert('RGBA')
            background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
            img = background

        # Resize if too large (max 2048px on longest side)
        max_dimension = 2048
        if max(img.size) > max_dimension:
            ratio = max_dimension / max(img.size)
            new_size = tuple(int(dim * ratio) for dim in img.size)
            img = img.resize(new_size, Image.Resampling.LANCZOS)

        # Save compressed image to bytes
        output = io.BytesIO()
        img.save(output, format='JPEG', quality=quality, optimize=True)
        output.seek(0)

        # If still too large, reduce quality
        if len(output.getvalue()) > max_size_mb * 1024 * 1024 and quality > 60:
            output = io.BytesIO()
            img.save(output, format='JPEG', quality=60, optimize=True)
            output.seek(0)

        return output, 'jpg'
    except Exception as e:
        print(f"Compression error: {e}")
        # Return original if compression fails
        image_file.seek(0)
        return image_file, image_file.filename.rsplit('.', 1)[1].lower()


@main_bp.route("/api/upload-photos", methods=["POST"])
@login_required
def api_upload_photos():
    """Handle photo uploads for listings with compression"""
    try:
        if 'photos' not in request.files:
            return jsonify({"error": "No photos provided"}), 400

        files = request.files.getlist('photos')
        if not files or files[0].filename == '':
            return jsonify({"error": "No files selected"}), 400

        # Create uploads directory if it doesn't exist
        upload_dir = Path('./data/uploads')
        upload_dir.mkdir(parents=True, exist_ok=True)

        uploaded_paths = []
        for file in files:
            if file and allowed_file(file.filename):
                # Compress image before saving
                compressed_file, ext = compress_image(file)

                # Generate unique filename
                filename = f"{uuid.uuid4().hex}.{ext}"
                filepath = upload_dir / filename

                # Save compressed file
                with open(filepath, 'wb') as f:
                    f.write(compressed_file.read())

                # Return web-accessible path
                uploaded_paths.append(f"/uploads/{filename}")

        if not uploaded_paths:
            return jsonify({"error": "No valid images uploaded"}), 400

        return jsonify({
            "success": True,
            "paths": uploaded_paths,
            "count": len(uploaded_paths)
        })

    except Exception as e:
        print(f"Upload error: {e}")
        return jsonify({"error": str(e)}), 500


@main_bp.route("/uploads/<filename>")
def serve_upload(filename):
    """Serve uploaded files"""
    try:
        from flask import send_from_directory
        upload_dir = Path('./data/uploads')
        return send_from_directory(upload_dir, filename)
    except Exception as e:
        return jsonify({"error": "File not found"}), 404

