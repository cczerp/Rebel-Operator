========================================
BACKEND ENHANCED SCAN API (TIER 2 - CLAUDE)
========================================
File: routes_main.py (lines 644-748)
Purpose: Deep collectible analysis using Claude

@main_bp.route("/api/enhanced-scan", methods=["POST"])
@login_required
def api_enhanced_scan():
    """
    Enhanced scanner for deep collectible analysis.
    Auto-detects: Card vs Collectible vs Standard Item
    Routes to appropriate analyzer and saves to databases.
    """
    try:
        from src.collectibles.enhanced_scanner import EnhancedScanner
        from src.schema.unified_listing import Photo
        
        data = request.json
        photo_paths = data.get('photos', [])
        
        if not photo_paths:
            return jsonify({'error': 'No photos provided'}), 400

        # Create Photo objects
        photos = [Photo(url=p, local_path=f"./data{p}") for p in photo_paths]

        # Run enhanced scanner
        scanner = EnhancedScanner.from_env()
        result = scanner.scan(photos)
        
        # Check if standard item (not collectible)
        if result.get('type') == 'standard_item':
            return jsonify({
                'success': False,
                'type': 'standard_item',
                'message': 'Not a collectible. Use quick analysis for listing.',
                'classification': result.get('classification')
            })
        
        # Check for errors
        if result.get('error'):
            return jsonify({
                'success': False,
                'error': result['error'],
                'raw_response': result.get('raw_response'),
                'type': result.get('type')
            }), 500
        
        # Save to public database
        public_db_id = None
        try:
            public_db_id = db.add_to_public_collectibles(
                item_type=result['type'],
                data=result['data'],
                scanned_by=current_user.id
            )
        except Exception as e:
            print(f"Warning: Failed to save to public database: {e}")
        
        # Save to user's personal collection
        user_collection_id = None
        try:
            if result['type'] == 'card':
                # Save to cards collection
                from src.cards import add_card_to_collection
                user_collection_id = add_card_to_collection(
                    result['data'],
                    current_user.id,
                    photos=photo_paths,
                    storage_location=data.get('storage_location')
                )
            else:
                # Save to collectibles collection
                user_collection_id = db.add_to_user_collectibles(
                    current_user.id,
                    result['data'],
                    photos=photo_paths
                )
        except Exception as e:
            print(f"Warning: Failed to save to user collection: {e}")
        
        # Log activity
        db.log_activity(
            action="enhanced_scan",
            user_id=current_user.id,
            resource_type=result['type'],
            resource_id=user_collection_id,
            ip_address=request.remote_addr,
            user_agent=request.headers.get("User-Agent")
        )
        
        return jsonify({
            'success': True,
            'type': result['type'],
            'data': result['data'],
            'market_prices': result.get('market_prices'),
            'ai_provider': result.get('ai_provider', 'claude'),
            'public_db_id': public_db_id,
            'user_collection_id': user_collection_id
        })
        
    except Exception as e:
        import traceback
        print(f"Enhanced scan error: {e}")
        print(traceback.format_exc())
        return jsonify({
            'error': str(e),
            'traceback': traceback.format_exc()
        }), 500

