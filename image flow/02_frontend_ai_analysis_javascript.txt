========================================
FRONTEND AI ANALYSIS - JAVASCRIPT
========================================
File: templates/create.html (lines 740-1339)
Purpose: Two-tier AI analysis system (Gemini quick scan + Claude deep scan)

// ========================================
// AI ANALYSIS - TWO-TIER SYSTEM
// ========================================

let detectedCardData = null;
let detectedCollectibleData = null;
let enhancedScanData = null;

// TIER 1: Quick Analysis (Gemini - Fast & Cheap)
document.getElementById('analyzeBtn').addEventListener('click', async function() {
    showLoading('Running quick analysis...');

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (!data.success) {
            showAlert(data.error || 'Analysis failed', 'danger');
            hideLoading();
            return;
        }

        const analysis = data.analysis;

        // Fill form with basic info
        if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
        if (analysis.description) document.getElementById('description').value = analysis.description;
        if (analysis.brand) document.getElementById('brand').value = analysis.brand;
        if (analysis.size) document.getElementById('size').value = analysis.size;
        if (analysis.color) document.getElementById('color').value = analysis.color;
        if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
        if (analysis.condition) {
            const condition = analysis.condition.replace(' ', '_').toLowerCase();
            document.getElementById('condition').value = condition;
        }

        // Check if Enhanced Scan would be helpful
        const isCard = analysis.category === 'Trading Cards' || analysis.category === 'Sports Cards';
        const isCollectible = analysis.collectible === true;

        if (isCard || isCollectible) {
            showEnhancedScanOption(isCard, isCollectible, analysis);
        }

        // Show market analysis if available
        if (analysis.market_analysis) {
            showMarketAnalysis(analysis.market_analysis);
        }

        showAlert('Quick analysis complete!', 'success');

    } catch (error) {
        showAlert('Analysis failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// Show subtle Enhanced Scan option
function showEnhancedScanOption(isCard, isCollectible, analysis) {
    // Remove existing if present
    document.getElementById('enhancedScanCard')?.remove();

    let scanType = isCard ? 'card' : 'collectible';
    let icon = isCard ? 'fa-id-card' : 'fa-star';
    let message = isCard 
        ? 'Get detailed card analysis, TCGPlayer prices, and authentication'
        : 'Get rarity info, franchise history, and authentication markers';

    const enhancedScanCard = `
        <div class="card border-primary mb-3" id="enhancedScanCard">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="fas ${icon} text-primary"></i> 
                            Enhanced Scanner Available
                        </h6>
                        <small class="text-muted">${message}</small>
                    </div>
                    <button class="btn btn-primary" onclick="runEnhancedScan()">
                        <i class="fas fa-microscope"></i> Enhanced Scan
                    </button>
                </div>
            </div>
        </div>
    `;

    // Insert after photo card
    document.querySelector('.card-header').closest('.card').insertAdjacentHTML('afterend', enhancedScanCard);
}

// Show market analysis
function showMarketAnalysis(market) {
    // Remove existing if present
    document.getElementById('marketAnalysisCard')?.remove();

    let demandColor = market.demand_level === 'High' ? 'success' :
                     market.demand_level === 'Low' ? 'danger' : 'warning';

    let marketCard = `
        <div class="card border-info mb-3" id="marketAnalysisCard">
            <div class="card-header bg-info text-white">
                <i class="fas fa-chart-line"></i> Market Analysis
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Sell-Through Rate:</strong><br>
                        <span class="h4">${market.sell_through_rate}%</span> ${getDemandEmoji(market.demand_level)}
                    </div>
                    <div class="col-md-3">
                        <strong>Demand:</strong><br>
                        <span class="badge bg-${demandColor} fs-6">${market.demand_level}</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Est. Days to Sell:</strong><br>
                        <span class="h5">${market.days_to_sell_estimate}</span> days
                    </div>
                    <div class="col-md-3">
                        <strong>Avg Sold Price:</strong><br>
                        <span class="h5 text-success">$${market.average_sold_price?.toFixed(2) || 'N/A'}</span>
                    </div>
                </div>
                ${market.market_insights?.length > 0 ? `
                    <hr>
                    <small class="text-muted">${market.market_insights.join(' ‚Ä¢ ')}</small>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('enhancedScanCard')?.insertAdjacentHTML('afterend', marketCard);
}

function getDemandEmoji(demand) {
    if (demand === 'High') return 'üî•';
    if (demand === 'Low') return 'üêå';
    return 'üìà';
}

// TIER 2: Enhanced Scanner (Claude - Deep Dive)
async function runEnhancedScan() {
    showLoading('Running enhanced scan... This may take 10-20 seconds');

    try {
        const response = await fetch('/api/enhanced-scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (!data.success) {
            if (data.type === 'standard_item') {
                showAlert('Not a collectible. Quick analysis is sufficient for this item.', 'info');
            } else {
                showAlert(data.error || data.message || 'Enhanced scan failed', 'danger');
            }
            hideLoading();
            return;
        }

        // Store enhanced scan data
        enhancedScanData = data;

        // Remove the "run enhanced scan" card
        document.getElementById('enhancedScanCard')?.remove();

        // Display results based on type
        if (data.type === 'card') {
            detectedCardData = data.data;
            showCardResults(data);
        } else if (data.type === 'collectible') {
            detectedCollectibleData = data.data;
            showCollectibleResults(data);
        }

        showAlert('Enhanced scan complete!', 'success');

    } catch (error) {
        showAlert('Enhanced scan failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Display Card Results
function showCardResults(data) {
    const cardData = data.data;
    const prices = data.market_prices || {};

    const statsCard = `
        <div class="card border-success mb-3" id="enhancedResultsCard">
            <div class="card-header bg-success text-white">
                <i class="fas fa-id-card"></i> Card Analysis Complete
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>${cardData.card_name || cardData.player_name || 'Unknown Card'}</h5>
                        ${cardData.set_name ? `<p class="mb-1"><strong>Set:</strong> ${cardData.set_name}</p>` : ''}
                        ${cardData.card_number ? `<p class="mb-1"><strong>Number:</strong> #${cardData.card_number}</p>` : ''}
                        ${cardData.rarity ? `<p class="mb-1"><strong>Rarity:</strong> ${cardData.rarity}</p>` : ''}
                        ${cardData.year ? `<p class="mb-1"><strong>Year:</strong> ${cardData.year}</p>` : ''}
                        ${cardData.brand ? `<p class="mb-1"><strong>Brand:</strong> ${cardData.brand}</p>` : ''}
                        ${cardData.is_rookie_card ? `<p class="mb-1"><span class="badge bg-warning">ROOKIE CARD</span></p>` : ''}
                        ${cardData.is_graded ? `<p class="mb-1"><strong>Graded:</strong> ${cardData.grading_company} ${cardData.grading_score}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>Market Prices</h6>
                        ${prices.tcgplayer ? `<p class="mb-1"><strong>TCGPlayer:</strong> $${prices.tcgplayer.market || 'N/A'}</p>` : ''}
                        ${prices.ebay ? `<p class="mb-1"><strong>eBay Sold Avg:</strong> $${prices.ebay.avg || 'N/A'}</p>` : ''}
                        ${prices.actual_selling ? `<p class="mb-1 text-success"><strong>Actual Selling:</strong> $${prices.actual_selling}</p>` : ''}
                        ${prices.quick_sale ? `<p class="mb-1 text-warning"><strong>Quick Sale:</strong> $${prices.quick_sale}</p>` : ''}
                    </div>
                </div>
                
                <hr>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="storeCardOnly()">
                        <i class="fas fa-box"></i> Store in Collection
                    </button>
                    <button class="btn btn-outline-success" onclick="storeAndList()">
                        <i class="fas fa-plus-circle"></i> Store + Create Listing
                    </button>
                </div>
            </div>
        </div>
    `;

    // Remove existing results
    document.getElementById('enhancedResultsCard')?.remove();
    
    // Insert after market analysis or enhanced scan card
    const insertAfter = document.getElementById('marketAnalysisCard') || document.querySelector('.card');
    insertAfter.insertAdjacentHTML('afterend', statsCard);

    // Fill form with detailed card info
    fillFormFromCardData(cardData, prices);
}

// Display Collectible Results
function showCollectibleResults(data) {
    const collectibleData = data.data;
    const prices = data.market_prices || {};

    const collectibleCard = `
        <div class="card border-warning mb-3" id="enhancedResultsCard">
            <div class="card-header bg-warning text-dark">
                <i class="fas fa-star"></i> Collectible Analysis Complete
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>${collectibleData.item_name || 'Unknown Collectible'}</h5>
                        <p class="mb-2"><strong>Franchise:</strong> ${collectibleData.franchise}</p>
                        
                        ${collectibleData.item_significance ? `
                            <h6 class="mt-3">About This Item</h6>
                            <p class="small">${collectibleData.item_significance}</p>
                        ` : ''}
                        
                        ${collectibleData.rarity_info ? `
                            <h6 class="mt-3">Rarity Analysis</h6>
                            <p class="small">${collectibleData.rarity_info}</p>
                        ` : ''}
                        
                        ${collectibleData.authentication_markers?.length > 0 ? `
                            <h6 class="mt-3">Authentication Markers</h6>
                            <ul class="small">
                                ${collectibleData.authentication_markers.map(m => `<li>${m}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <h6>Market Analysis</h6>
                        ${prices.retail ? `
                            <div class="mb-2">
                                <small class="text-muted">Retail Price</small>
                                <div class="h5">$${prices.retail}</div>
                            </div>
                        ` : ''}
                        ${prices.actual_selling ? `
                            <div class="mb-2">
                                <small class="text-muted">Actual Selling</small>
                                <div class="h5 text-success">$${prices.actual_selling}</div>
                            </div>
                        ` : ''}
                        ${prices.quick_sale ? `
                            <div class="mb-2">
                                <small class="text-muted">Quick Sale</small>
                                <div class="h5 text-warning">$${prices.quick_sale}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <hr>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" onclick="storeCollectibleOnly()">
                        <i class="fas fa-archive"></i> Add to Collection
                    </button>
                    <button class="btn btn-outline-warning" onclick="storeCollectibleAndList()">
                        <i class="fas fa-plus-circle"></i> Store + Create Listing
                    </button>
                </div>
            </div>
        </div>
    `;

    // Remove existing results
    document.getElementById('enhancedResultsCard')?.remove();
    
    // Insert after market analysis or enhanced scan card
    const insertAfter = document.getElementById('marketAnalysisCard') || document.querySelector('.card');
    insertAfter.insertAdjacentHTML('afterend', collectibleCard);

    // Fill form with collectible info
    fillFormFromCollectible(collectibleData, prices);
}

// Fill form from card data
function fillFormFromCardData(cardData, prices) {
    // Build title
    let title = '';
    if (cardData.player_name) {
        // Sports card
        title = cardData.player_name;
        if (cardData.year) title = `${cardData.year} ${title}`;
        if (cardData.brand) title = `${title} ${cardData.brand}`;
        if (cardData.series) title = `${title} ${cardData.series}`;
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
        if (cardData.is_rookie_card) title = `${title} RC`;
    } else {
        // TCG card
        title = cardData.card_name || 'Unknown Card';
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
    }

    document.getElementById('title').value = title.substring(0, 80);

    // Build description
    let description = '';
    if (cardData.set_name) description += `Set: ${cardData.set_name}\n`;
    if (cardData.rarity) description += `Rarity: ${cardData.rarity}\n`;
    if (cardData.is_graded && cardData.grading_company) {
        description += `Graded: ${cardData.grading_company} ${cardData.grading_score || ''}\n`;
    }
    if (cardData.parallel) description += `Parallel: ${cardData.parallel}\n`;

    document.getElementById('description').value = description;

    // Set brand
    if (cardData.brand) document.getElementById('brand').value = cardData.brand;

    // Set price from market data
    if (prices.actual_selling) {
        document.getElementById('price').value = prices.actual_selling;
    } else if (cardData.estimated_value_low && cardData.estimated_value_high) {
        const avgValue = (cardData.estimated_value_low + cardData.estimated_value_high) / 2;
        document.getElementById('price').value = avgValue.toFixed(2);
    }

    // Set item type
    document.getElementById('item_type').value = 'trading_card';

    // Set condition
    if (cardData.is_graded && cardData.grading_score) {
        if (cardData.grading_score >= 9) {
            document.getElementById('condition').value = 'excellent';
        } else if (cardData.grading_score >= 7) {
            document.getElementById('condition').value = 'good';
        } else {
            document.getElementById('condition').value = 'fair';
        }
    }
}

// Fill form from collectible data
function fillFormFromCollectible(collectibleData, prices) {
    // Set title
    if (collectibleData.item_name) {
        document.getElementById('title').value = collectibleData.item_name.substring(0, 80);
    }

    // Set description
    let description = '';
    if (collectibleData.franchise) description += `Franchise: ${collectibleData.franchise}\n\n`;
    if (collectibleData.item_significance) description += `${collectibleData.item_significance}\n\n`;
    if (collectibleData.rarity_info) description += `Rarity: ${collectibleData.rarity_info}\n`;

    document.getElementById('description').value = description;

    // Set brand
    if (collectibleData.brand) document.getElementById('brand').value = collectibleData.brand;

    // Set price
    if (prices.actual_selling) {
        document.getElementById('price').value = prices.actual_selling;
    } else if (prices.retail) {
        document.getElementById('price').value = prices.retail;
    }

    // Set item type
    document.getElementById('item_type').value = 'collectible';
}

// Store card only (no listing)
async function storeCardOnly() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card stored in your collection! Redirecting...', 'success');
            setTimeout(() => window.location.href = '/cards', 1500);
        } else {
            showAlert(data.error || 'Failed to add card', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
        hideLoading();
    }
}

// Store card + create listing
async function storeAndList() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card added! Continue filling out the form to create a listing.', 'success');
            
            // Update the results card
            const resultsCard = document.getElementById('enhancedResultsCard');
            if (resultsCard) {
                resultsCard.classList.remove('border-success');
                resultsCard.classList.add('border-info');
                resultsCard.querySelector('.card-header').classList.remove('bg-success');
                resultsCard.querySelector('.card-header').classList.add('bg-info');
                resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Card Stored - Create Listing Below';
            }
        } else {
            showAlert(data.error || 'Failed to add card', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Store collectible only (no listing)
async function storeCollectibleOnly() {
    if (!detectedCollectibleData) {
        showAlert('No collectible data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/collectibles/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCollectibleData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Collectible stored! Redirecting...', 'success');
            setTimeout(() => window.location.href = '/my-collection', 1500);
        } else {
            showAlert(data.error || 'Failed to add collectible', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add collectible: ' + error, 'danger');
        hideLoading();
    }
}

// Store collectible + create listing
async function storeCollectibleAndList() {
    if (!detectedCollectibleData) {
        showAlert('No collectible data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/collectibles/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCollectibleData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Collectible added! Continue filling out the form to create a listing.', 'success');
            
            // Update the results card
            const resultsCard = document.getElementById('enhancedResultsCard');
            if (resultsCard) {
                resultsCard.classList.remove('border-warning');
                resultsCard.classList.add('border-info');
                resultsCard.querySelector('.card-header').classList.remove('bg-warning');
                resultsCard.querySelector('.card-header').classList.add('bg-info');
                resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Collectible Stored - Create Listing Below';
            }
        } else {
            showAlert(data.error || 'Failed to add collectible', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add collectible: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

