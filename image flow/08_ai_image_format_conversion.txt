========================================
AI IMAGE FORMAT CONVERSION FOR CLAUDE
========================================
File: src/enhancer/ai_enhancer.py, src/collectibles/recognizer.py, etc.
Purpose: Convert images to Claude-compatible formats (JPEG, PNG, GIF only)

NOTE: Claude API only accepts image/jpeg, image/png, or image/gif
WebP and HEIC files must be converted before sending to Claude.

def _convert_to_claude_format(self, image_path: str) -> tuple[bytes, str]:
    """
    Convert image to Claude-compatible format (JPEG, PNG, or GIF).
    Claude only accepts: image/jpeg, image/png, image/gif
    
    Returns:
        (image_bytes, mime_type) tuple
    """
    from PIL import Image
    import io
    
    try:
        img = Image.open(image_path)
        
        # Get original format
        original_format = img.format
        
        # If already in supported format, return as-is
        if original_format in ('JPEG', 'PNG', 'GIF'):
            # Read the file
            with open(image_path, "rb") as f:
                image_bytes = f.read()
            
            mime_type = {
                'JPEG': 'image/jpeg',
                'PNG': 'image/png',
                'GIF': 'image/gif'
            }[original_format]
            
            return image_bytes, mime_type
        
        # Convert unsupported formats (WebP, HEIC, etc.) to JPEG
        # Convert RGBA to RGB if needed
        if img.mode in ('RGBA', 'LA', 'P'):
            background = Image.new('RGB', img.size, (255, 255, 255))
            if img.mode == 'P':
                img = img.convert('RGBA')
            background.paste(img, mask=img.split()[-1] if img.mode == 'RGBA' else None)
            img = background
        elif img.mode != 'RGB':
            img = img.convert('RGB')
        
        # Save as JPEG
        output = io.BytesIO()
        img.save(output, format='JPEG', quality=95, optimize=True)
        image_bytes = output.getvalue()
        
        return image_bytes, 'image/jpeg'
        
    except Exception as e:
        print(f"Warning: Image conversion failed for {image_path}: {e}")
        # Fallback: try to read as-is
        with open(image_path, "rb") as f:
            return f.read(), "image/jpeg"

def _get_image_mime_type(self, image_path: str) -> str:
    """
    Get MIME type for Claude (only JPEG, PNG, GIF supported).
    Images are converted to JPEG if not already in a supported format.
    """
    from PIL import Image
    
    try:
        img = Image.open(image_path)
        original_format = img.format
        
        # Return MIME type for supported formats
        if original_format in ('JPEG', 'PNG', 'GIF'):
            return {
                'JPEG': 'image/jpeg',
                'PNG': 'image/png',
                'GIF': 'image/gif'
            }[original_format]
        
        # Unsupported formats (WebP, HEIC, etc.) will be converted to JPEG
        return 'image/jpeg'
    except Exception:
        # Fallback
        return 'image/jpeg'

# Usage in Claude API calls:
if photo.local_path:
    # Convert to Claude-compatible format and encode
    image_bytes, mime_type = self._convert_to_claude_format(photo.local_path)
    image_b64 = base64.b64encode(image_bytes).decode("utf-8")
    image_dict["source"] = {
        "type": "base64",
        "media_type": mime_type,
        "data": image_b64,
    }

