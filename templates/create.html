{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
{% if is_guest %}
<div class="alert alert-info mb-4">
    <h5 class="alert-heading"><i class="fas fa-magic"></i> Try AI Analyzer FREE!</h5>
    <p class="mb-2">Upload photos and watch AI create your listing instantly. No sign-up required!</p>
    {% if guest_uses_remaining is not none %}
    <p class="mb-0">
        <strong>Free uses remaining: {{ guest_uses_remaining }} / 8</strong>
        {% if guest_uses_remaining == 0 %}
        <br><a href="{{ url_for('auth.register') }}" class="alert-link">Sign up now</a> to continue using AI features!
        {% endif %}
    </p>
    {% endif %}
</div>
{% endif %}

<h2 class="mb-4"><i class="fas fa-plus-circle"></i> Create New Listing</h2>

<form id="listingForm">
    <!-- Photo Upload -->
    <div class="card mb-3">
        <div class="card-header" style="background: var(--carbon-matte-surface); border-bottom: 2px solid var(--alert-crimson);">
            <i class="fas fa-camera" style="color: var(--alert-crimson);"></i> Photos
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-6">
            <button type="button" class="btn btn-outline-primary w-100" id="takePhotoBtn">
                <i class="fas fa-camera"></i><br>Take Photo
            </button>
                    <input type="file" class="d-none" id="cameraInput" name="photos" accept="image/*" capture="environment">
                </div>
                <div class="col-6">
            <button type="button" class="btn btn-outline-secondary w-100" id="uploadFilesBtn">
                <i class="fas fa-upload"></i><br>Upload Files
            </button>
                    <input type="file" class="d-none" id="photoInput" name="photos" multiple accept="image/*">
                </div>
            </div>
            <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
            <div class="mt-3 d-flex gap-2">
                <button type="button" class="btn btn-primary" id="analyzeBtn" disabled title="Upload photos first to enable AI analysis">
                    <i class="fas fa-magic"></i> Analyze with AI
                </button>
                {% if not is_guest %}
                <button type="button" class="btn btn-outline-primary" id="enhancedScanBtn" disabled title="Run quick AI scan first to enable Enhanced Scan" onclick="runEnhancedScan()">
                    <i class="fas fa-microscope"></i> Enhanced Scan
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Listing Details -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-edit"></i> Details
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required maxlength="80">
                <small class="text-muted">Max 80 characters</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">Price ($) *</label>
                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Cost ($)</label>
                    <input type="number" class="form-control" id="cost" name="cost" step="0.01">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-6">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="condition" name="condition">
                        <option value="new">New</option>
                        <option value="like_new">Like New</option>
                        <option value="excellent" selected>Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Item Type</label>
                    <select class="form-select" id="item_type" name="item_type">
                        <option value="general" selected>General Item</option>
                        <option value="clothing">Clothing & Accessories</option>
                        <option value="electronics">Electronics</option>
                        <option value="trading_card">Trading Cards (TCG/Sports)</option>
                        <option value="collectible">Collectibles</option>
                        <option value="home_garden">Home & Garden</option>
                        <option value="toys_games">Toys & Games</option>
                        <option value="books_media">Books & Media</option>
                        <option value="jewelry">Jewelry & Watches</option>
                        <option value="antiques">Antiques & Vintage</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-4">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand">
                </div>
                <div class="col-4">
                    <label class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size">
                </div>
                <div class="col-4">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Shipping Cost ($)</label>
                <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" value="0">
                <small class="text-muted">0 for free shipping</small>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-grid gap-2">
        {% if is_guest %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> <strong>Try the AI for free!</strong> Sign up (free) to save your listings and track inventory.
        </div>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-user-plus"></i> Sign Up Free to Save Listing
        </a>
        <small class="text-muted text-center mt-2">
            You can test the AI photo analysis above without signing up!
        </small>
        {% else %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-lightbulb"></i> <strong>Choose how to save:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>Post as Listing:</strong> Ready to sell now? Post to marketplaces immediately</li>
                <li><strong>Save as Draft:</strong> Not ready yet? Save for later to finish and post</li>
                <li><strong>Save to My Vault:</strong> Just collecting? Store in your personal collection vault</li>
            </ul>
        </div>
        <button type="button" class="btn btn-primary btn-lg" id="postListingBtn">
            <i class="fas fa-rocket"></i> Post as Listing
        </button>
        <button type="button" class="btn btn-secondary btn-lg" id="saveDraftBtn">
            <i class="fas fa-save"></i> Save as Draft
        </button>
        <button type="button" class="btn btn-outline-success btn-lg" id="saveToVaultBtn">
            <i class="fas fa-vault"></i> Save to My Vault
        </button>
        <div class="form-check mt-2" id="storageMapOption" style="display: none;">
            <input class="form-check-input" type="checkbox" id="useStorageMap" checked>
            <label class="form-check-label" for="useStorageMap">
                <i class="fas fa-map-marked-alt"></i> Use storage map guidance (suggests where to place card)
            </label>
        </div>
        {% endif %}
    </div>
</form>

<!-- Photo Editor Modal -->
<div id="photoEditorModal" class="photo-editor-modal">
    <div class="photo-editor-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 style="color: var(--off-white-text);"><i class="fas fa-magic" style="color: var(--alert-crimson);"></i> Edit Photo (FREE!)</h4>
            <button class="btn btn-outline-danger" onclick="closePhotoEditor()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>

        <div class="text-center mb-3">
            <img id="photoEditorImage" class="photo-editor-image" src="">
        </div>

        <div class="photo-editor-toolbar">
            <button class="btn btn-primary" onclick="enableCrop()">
                <i class="fas fa-crop"></i> Crop
            </button>
            <button class="btn btn-success" id="cropBtn" onclick="applyCrop()" style="display:none;">
                <i class="fas fa-check"></i> Apply Crop
            </button>
            <button class="btn btn-danger" id="cancelCropBtn" onclick="cancelCrop()" style="display:none;">
                <i class="fas fa-times"></i> Cancel Crop
            </button>
            <button class="btn btn-warning" onclick="removeBackground()">
                <i class="fas fa-magic"></i> Remove Background
            </button>
            <button class="btn btn-secondary" onclick="resetPhoto()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>

        <div class="alert alert-info mt-3" style="background: rgba(95, 122, 138, 0.15); border-color: var(--cold-steel-accent); color: var(--cold-steel-light);">
            <i class="fas fa-gift"></i> <strong>FREE Feature!</strong> Other apps charge $5-20/month for background removal. We give it to you free!
        </div>
    </div>
</div>

<!-- Image Zoom Modal -->
<div id="imageZoomModal" class="image-zoom-modal" onclick="closeImageZoom()" style="display: none;">
    <div class="image-zoom-container">
        <button class="btn btn-outline-danger zoom-close-btn" onclick="closeImageZoom()">
            <i class="fas fa-times"></i>
        </button>
        <img id="zoomImage" src="" alt="Zoomed image">
        <div class="zoom-hint">Click image to zoom | Right-click to see details</div>
    </div>
</div>

<style>
.image-zoom-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(26, 26, 26, 0.98);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
}

.image-zoom-container {
    position: relative;
    max-width: 95%;
    max-height: 95%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.zoom-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10000;
}

#zoomImage {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    cursor: zoom-in;
}

.zoom-hint {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    color: var(--off-white-text);
    background: var(--carbon-matte-surface);
    border: 1px solid var(--cold-steel-dark);
    padding: 10px 20px;
    border-radius: 5px;
    font-size: 14px;
}

.photo-preview {
    cursor: pointer;
    transition: transform 0.2s;
    width: 150px;
    height: 150px;
    object-fit: cover;
    border-radius: 5px;
    margin: 5px;
}

.photo-preview:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(220, 20, 60, 0.5);
    border: 2px solid var(--alert-crimson);
}

.photo-preview-container {
    position: relative;
    display: inline-block;
    margin: 5px;
}

.photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    padding: 2px 6px;
    font-size: 12px;
    background: var(--alert-crimson) !important;
    border-color: var(--alert-crimson) !important;
    color: white !important;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
let uploadedPhotos = [];
let editingDraftId = {% if draft_id %}{{ draft_id }}{% else %}null{% endif %};
let scanDraftId = {% if scan_draft %}{{ scan_draft }}{% else %}null{% endif %};
let editingListingUuid = null;

// Generic photo handling function for both camera and file upload
async function handlePhotoSelect(e) {
    console.log('[UPLOAD] handlePhotoSelect called', e);

    // Defensive check: ensure event and target exist
    if (!e || !e.target) {
        console.error('[UPLOAD ERROR] Invalid event object:', e);
        showAlert('Error: Invalid file selection event. Please try again.', 'danger');
        return;
    }

    // Defensive check: ensure files property exists
    if (!e.target.files) {
        console.error('[UPLOAD ERROR] No files property on target:', e.target);
        showAlert('Error: Unable to access selected files. Please try again.', 'danger');
        return;
    }

    const files = e.target.files;
    if (files.length === 0) return;

    // Validate files before upload (Gemini requirements)
    const validFiles = [];
    const supportedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    
    for (let file of files) {
        // Quick self-test (as per Gemini requirements)
        const fileCheck = {
            fileExists: !!file,
            type: file?.type,
            size: file?.size,
            instance: file instanceof File
        };
        console.log('[FILE VALIDATION]', fileCheck);
        
        // Validate file is a File instance
        if (!(file instanceof File)) {
            console.error('[UPLOAD ERROR] Not a File object:', file);
            showAlert(`Error: Invalid file object. Please try selecting the file again.`, 'danger');
            continue;
        }
        
        // Validate file type (only safe formats for Gemini)
        if (!file.type || !supportedTypes.includes(file.type)) {
            console.warn(`[FILE VALIDATION] Unsupported type: ${file.type}, will be converted to JPEG on server`);
            // Continue anyway - server will convert it
        }
        
        // Validate file size
        if (!file.size || file.size === 0) {
            console.error('[UPLOAD ERROR] Empty file:', file.name);
            showAlert(`Error: File "${file.name}" is empty. Please select a valid image.`, 'danger');
            continue;
        }
        
        // Check file size limit (20MB for Gemini)
        const maxSize = 20 * 1024 * 1024; // 20MB
        if (file.size > maxSize) {
            console.error('[UPLOAD ERROR] File too large:', file.name, file.size);
            showAlert(`Error: File "${file.name}" exceeds 20MB limit. Please compress or resize the image.`, 'danger');
            continue;
        }
        
        validFiles.push(file);
    }
    
    if (validFiles.length === 0) {
        hideLoading();
        return;
    }
    
    // Create FormData with validated files
    const formData = new FormData();
    for (let file of validFiles) {
        formData.append('photos', file);
    }
    
    console.log(`[UPLOAD] Validated ${validFiles.length} of ${files.length} files`);

    showLoading();

    try {
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Append to existing photos instead of replacing
            uploadedPhotos = uploadedPhotos.concat(data.paths);

            // Show previews (append to existing)
            const previewDiv = document.getElementById('photoPreview');
            for (let i = 0; i < data.paths.length; i++) {
                const photoIndex = uploadedPhotos.length - data.paths.length + i;

                // Create container for photo + delete button
                const container = document.createElement('div');
                container.className = 'photo-preview-container';
                container.style.position = 'relative';
                container.style.display = 'inline-block';
                container.style.margin = '5px';

                // Create image
                const img = document.createElement('img');
                // Use Supabase Storage URL directly (already a full URL)
                // Or use local path if it's not a Supabase URL
                const imageUrl = data.paths[i];
                if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                    // It's a Supabase Storage URL - use directly
                    img.src = imageUrl;
                } else {
                    // It's a local path - prepend '/' for local serving
                    img.src = '/' + imageUrl;
                }
                img.className = 'photo-preview';
                img.title = 'Click to edit | Right-click to zoom';

                // Make photo clickable to open editor
                img.onclick = function(e) {
                    e.preventDefault();
                    openPhotoEditor(photoIndex, this.src);
                };

                // Right-click to zoom
                img.oncontextmenu = function(e) {
                    e.preventDefault();
                    openImageZoom(data.paths[i]);
                };

                // Create delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '5px';
                deleteBtn.style.right = '5px';
                deleteBtn.style.padding = '2px 6px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.title = 'Remove photo';
                deleteBtn.onclick = function(e) {
                    e.preventDefault();
                    removePhoto(photoIndex);
                };

                container.appendChild(img);
                container.appendChild(deleteBtn);
                previewDiv.appendChild(container);
            }

            // Enable Analyze button when photos are uploaded
            document.getElementById('analyzeBtn').disabled = false;
            showAlert(`${data.count} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('Upload failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }

    // Reset input so same file can be selected again
    e.target.value = '';
}

// ========================================
// PHOTO EDITOR FUNCTIONS (FREE!)
// ========================================
let cropper = null;
let currentEditingPhotoIndex = null;
let currentEditingPhotoSrc = null;
let originalPhotoSrc = null;

async function openPhotoEditor(photoIndex, photoSrc) {
    currentEditingPhotoIndex = photoIndex;
    originalPhotoSrc = photoSrc;

    const modal = document.getElementById('photoEditorModal');
    const img = document.getElementById('photoEditorImage');

    // Convert blob URL to base64 data URL
    try {
        if (photoSrc.startsWith('blob:')) {
            // Fetch the blob and convert to base64
            const response = await fetch(photoSrc);
            const blob = await response.blob();

            // Convert blob to base64 using FileReader
            const reader = new FileReader();
            reader.onloadend = function() {
                currentEditingPhotoSrc = reader.result; // This is the base64 data URL
                img.src = currentEditingPhotoSrc;
            };
            reader.readAsDataURL(blob);
        } else {
            // Already a data URL or regular URL
            currentEditingPhotoSrc = photoSrc;
            img.src = photoSrc;
        }
    } catch (error) {
        console.error('Error converting image:', error);
        currentEditingPhotoSrc = photoSrc;
        img.src = photoSrc;
    }

    modal.classList.add('show');

    // Destroy existing cropper if any
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    // Reset buttons
    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('show');

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function enableCrop() {
    const img = document.getElementById('photoEditorImage');

    if (cropper) {
        cropper.destroy();
    }

    cropper = new Cropper(img, {
        aspectRatio: NaN, // Free aspect ratio
        viewMode: 1,
        responsive: true,
        autoCropArea: 0.8,
        background: false,
        ready: function() {
            showAlert('Drag to select crop area', 'info');
        }
    });

    // Show crop action buttons
    document.getElementById('cropBtn').style.display = 'inline-block';
    document.getElementById('cancelCropBtn').style.display = 'inline-block';
}

async function applyCrop() {
    if (!cropper) return;

    showLoading();

    try {
        const canvas = cropper.getCroppedCanvas();
        const croppedImage = canvas.toDataURL('image/png');

        // Get crop coordinates for API call
        const cropData = cropper.getData();

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'crop',
                crop: {
                    x: Math.round(cropData.x),
                    y: Math.round(cropData.y),
                    width: Math.round(cropData.width),
                    height: Math.round(cropData.height)
                }
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo cropped successfully!', 'success');

            // Cleanup cropper
            cropper.destroy();
            cropper = null;
            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        } else {
            showAlert('Crop failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Crop timed out. Please try again.', 'warning');
        } else {
            showAlert('Crop failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function cancelCrop() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

async function removeBackground() {
    if (!currentEditingPhotoSrc) return;

    showLoading();
    showAlert('Removing background... This may take 10-15 seconds', 'info');

    try {
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: uploadedPhotos[currentEditingPhotoIndex],
                operation: 'remove-bg'
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo in uploadedPhotos array
            uploadedPhotos[currentEditingPhotoIndex] = data.filepath;
            // Update the editor image
            document.getElementById('photoEditorImage').src = data.filepath;
            currentEditingPhotoSrc = data.filepath;
            showAlert('Background removed! (FREE feature worth $5-20/mo)', 'success');
        } else {
            showAlert('Background removal failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Background removal timed out. The image may be too large. Try a smaller image or crop it first.', 'warning');
        } else {
            showAlert('Background removal failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function resetPhoto() {
    if (!originalPhotoSrc) return;

    const img = document.getElementById('photoEditorImage');
    img.src = originalPhotoSrc;
    currentEditingPhotoSrc = originalPhotoSrc;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = originalPhotoSrc;
    }

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    showAlert('Photo reset to original', 'info');
}

// Remove photo function
function removePhoto(index) {
    if (confirm('Remove this photo?')) {
        // Remove from uploadedPhotos array
        uploadedPhotos.splice(index, 1);

        // Rebuild preview display
        const previewDiv = document.getElementById('photoPreview');
        previewDiv.innerHTML = '';

        // Re-render all photos with updated indices
        for (let i = 0; i < uploadedPhotos.length; i++) {
            const photoPath = uploadedPhotos[i];

            // Create container
            const container = document.createElement('div');
            container.className = 'photo-preview-container';
            container.style.position = 'relative';
            container.style.display = 'inline-block';
            container.style.margin = '5px';

            // Create image
            const img = document.createElement('img');
            // Handle both Supabase Storage URLs and local paths
            if (photoPath.startsWith('http://') || photoPath.startsWith('https://')) {
                img.src = photoPath;  // Supabase Storage URL
            } else {
                img.src = photoPath.startsWith('/') ? photoPath : '/' + photoPath;  // Local path
            }
            img.className = 'photo-preview';
            img.title = 'Click to edit | Right-click to zoom';

            // Click to edit
            const photoIndex = i;
            img.onclick = function(e) {
                e.preventDefault();
                openPhotoEditor(photoIndex, this.src);
            };

            // Right-click to zoom
            img.oncontextmenu = function(e) {
                e.preventDefault();
                openImageZoom(photoPath);
            };

            // Create delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
            deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.style.fontSize = '12px';
            deleteBtn.title = 'Remove photo';
            deleteBtn.onclick = function(e) {
                e.preventDefault();
                removePhoto(photoIndex);
            };

            container.appendChild(img);
            container.appendChild(deleteBtn);
            previewDiv.appendChild(container);
        }

        showAlert('Photo removed', 'info');

        // Disable analyze button if no photos left
        if (uploadedPhotos.length === 0) {
            document.getElementById('analyzeBtn').disabled = true;
            
            // Also disable Enhanced Scan button when no photos
            const enhancedScanBtn = document.getElementById('enhancedScanBtn');
            if (enhancedScanBtn) {
                enhancedScanBtn.disabled = true;
                enhancedScanBtn.classList.remove('btn-primary');
                enhancedScanBtn.classList.add('btn-outline-primary');
                enhancedScanBtn.title = 'Run quick AI scan first to enable Enhanced Scan';
            }
        }
    }
}

// Zoom modal functions
function openImageZoom(imageSrc) {
    const modal = document.getElementById('imageZoomModal');
    const zoomImage = document.getElementById('zoomImage');
    zoomImage.src = imageSrc;
    modal.style.display = 'flex';

    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
}

function closeImageZoom(event) {
    // Prevent closing if clicking on the close button (handled by button's onclick)
    if (event && event.target.classList.contains('zoom-close-btn')) {
        return;
    }

    const modal = document.getElementById('imageZoomModal');
    modal.style.display = 'none';

    // Restore body scroll
    document.body.style.overflow = 'auto';
}

// Close zoom modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageZoom();
    }
});

function updatePhotoAfterEdit(newImageData, newFilepath) {
    // Update the modal image
    const img = document.getElementById('photoEditorImage');
    img.src = newImageData;
    currentEditingPhotoSrc = newImageData;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = newImageData;
    }

    // Update the uploaded photos array with new filepath
    if (newFilepath) {
        uploadedPhotos[currentEditingPhotoIndex] = newFilepath;
    }
}

// ========================================
// AI ANALYSIS - TWO-TIER SYSTEM
// ========================================

let detectedCardData = null;
let detectedCollectibleData = null;
let enhancedScanData = null;

// TIER 1: Quick Analysis (Gemini - Fast & Cheap)
document.getElementById('analyzeBtn').addEventListener('click', async function() {
    // Check if photos are uploaded (non-negotiable requirement)
    if (!uploadedPhotos || uploadedPhotos.length === 0) {
        showAlert('Please upload photos first before running AI analysis.', 'warning');
        return;
    }
    
    showLoading('Running quick analysis...');

    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (!data.success) {
            // Check if user needs to sign up
            if (data.requires_signup) {
                showAlert(data.error || 'You\'ve used all free analyses. Please sign up to continue!', 'warning');
                // Show signup prompt
                if (confirm(data.error + '\n\nWould you like to sign up now?')) {
                    window.location.href = '{{ url_for("auth.register") }}';
                }
            } else {
                showAlert(data.error || 'Analysis failed', 'danger');
            }
            hideLoading();
            return;
        }
        
        // Update guest usage counter if shown (will be updated on next page load)
        {% if is_guest and guest_uses_remaining is not none %}
        // Note: Counter will be updated on next page load since session is server-side
        // For immediate feedback, we can show a message
        const guestAlert = document.querySelector('.alert-info');
        if (guestAlert) {
            const newRemaining = Math.max(0, {{ guest_uses_remaining }} - 1);
            const usesText = guestAlert.querySelector('strong');
            if (usesText) {
                usesText.textContent = `Free uses remaining: ${newRemaining} / 8`;
                if (newRemaining === 0) {
                    const lastP = guestAlert.querySelector('p:last-child');
                    if (lastP && !lastP.querySelector('a')) {
                        const signupLink = document.createElement('a');
                        signupLink.href = '{{ url_for("auth.register") }}';
                        signupLink.className = 'alert-link';
                        signupLink.textContent = 'Sign up now to continue using AI features!';
                        lastP.appendChild(document.createElement('br'));
                        lastP.appendChild(signupLink);
                    }
                }
            }
        }
        {% endif %}

        const analysis = data.analysis;

        // Fill form with basic info
        if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
        if (analysis.description) document.getElementById('description').value = analysis.description;
        if (analysis.brand) document.getElementById('brand').value = analysis.brand;
        if (analysis.size) document.getElementById('size').value = analysis.size;
        if (analysis.color) document.getElementById('color').value = analysis.color;
        if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
        if (analysis.condition) {
            const condition = analysis.condition.replace(' ', '_').toLowerCase();
            document.getElementById('condition').value = condition;
        }

        // Check if Enhanced Scan would be helpful
        const isCard = analysis.category === 'Trading Cards' || analysis.category === 'Sports Cards';
        const isCollectible = analysis.collectible === true;

        // Enable/Disable Enhanced Scan button based on collectible detection
        const enhancedScanBtn = document.getElementById('enhancedScanBtn');
        if (enhancedScanBtn) {
            if (isCard || isCollectible) {
                enhancedScanBtn.disabled = false;
                enhancedScanBtn.classList.remove('btn-outline-primary');
                enhancedScanBtn.classList.add('btn-primary');
                enhancedScanBtn.title = 'Deep collectible analysis - Create artifact in Hall of Records';
                
                // Show info message
                if (isCard || isCollectible) {
                    showEnhancedScanOption(isCard, isCollectible, analysis);
                }
            } else {
                enhancedScanBtn.disabled = true;
                enhancedScanBtn.classList.remove('btn-primary');
                enhancedScanBtn.classList.add('btn-outline-primary');
                enhancedScanBtn.title = 'Enhanced Scan only available for collectibles - Run quick AI scan first';
            }
        }

        // Show market analysis if available
        if (analysis.market_analysis) {
            showMarketAnalysis(analysis.market_analysis);
        }

        // Store analysis data for vault button
        window.lastQuickAnalysis = analysis;

        showAlert('Quick analysis complete!', 'success');

    } catch (error) {
        showAlert('Analysis failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// Show subtle Enhanced Scan option info card
function showEnhancedScanOption(isCard, isCollectible, analysis) {
    // Remove existing if present
    document.getElementById('enhancedScanCard')?.remove();

    let scanType = isCard ? 'card' : 'collectible';
    let icon = isCard ? 'fa-id-card' : 'fa-star';
    let message = isCard 
        ? 'Collectible detected! Enhanced Scan will create detailed card analysis in Hall of Records'
        : 'Collectible detected! Enhanced Scan will create artifact with franchise history in Hall of Records';

    const enhancedScanCard = `
        <div class="alert alert-info mb-3" id="enhancedScanCard">
            <i class="fas ${icon}"></i> 
            <strong>${message}</strong>
            <br>
            <small class="text-muted">Click the Enhanced Scan button above to proceed.</small>
        </div>
    `;

    // Insert after photo card
    document.querySelector('.card-header').closest('.card').insertAdjacentHTML('afterend', enhancedScanCard);
}

// Show market analysis
function showMarketAnalysis(market) {
    // Remove existing if present
    document.getElementById('marketAnalysisCard')?.remove();

    let demandColor = market.demand_level === 'High' ? 'success' :
                     market.demand_level === 'Low' ? 'danger' : 'warning';

    let marketCard = `
        <div class="card border-info mb-3" id="marketAnalysisCard" style="border-color: var(--cold-steel-accent);">
            <div class="card-header" style="background: var(--carbon-matte-surface); border-bottom: 2px solid var(--cold-steel-accent); color: var(--cold-steel-light);">
                <i class="fas fa-chart-line"></i> Market Analysis
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Sell-Through Rate:</strong><br>
                        <span class="h4">${market.sell_through_rate}%</span> ${getDemandEmoji(market.demand_level)}
                    </div>
                    <div class="col-md-3">
                        <strong>Demand:</strong><br>
                        <span class="badge bg-${demandColor} fs-6">${market.demand_level}</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Est. Days to Sell:</strong><br>
                        <span class="h5">${market.days_to_sell_estimate}</span> days
                    </div>
                    <div class="col-md-3">
                        <strong>Avg Sold Price:</strong><br>
                        <span class="h5 text-success">$${market.average_sold_price?.toFixed(2) || 'N/A'}</span>
                    </div>
                </div>
                ${market.market_insights?.length > 0 ? `
                    <hr>
                    <small class="text-muted">${market.market_insights.join(' â€¢ ')}</small>
                ` : ''}
            </div>
        </div>
    `;

    document.getElementById('enhancedScanCard')?.insertAdjacentHTML('afterend', marketCard);
}

function getDemandEmoji(demand) {
    if (demand === 'High') return 'ðŸ”¥';
    if (demand === 'Low') return 'ðŸŒ';
    return 'ðŸ“ˆ';
}

// TIER 2: Enhanced Scanner (Claude - Deep Dive)
// Creates artifact in Hall of Records and redirects to artifact detail page
async function runEnhancedScan() {
    {% if is_guest %}
    // Enhanced Scan requires authentication
    showAlert('Enhanced Scan is only available for registered users. Please sign up to access this feature!', 'warning');
    if (confirm('Would you like to sign up now?')) {
        window.location.href = '{{ url_for("auth.register") }}';
    }
    return;
    {% endif %}
    
    // Check if button is enabled (collectible detected)
    const btn = document.getElementById('enhancedScanBtn');
    if (btn && btn.disabled) {
        showAlert('Enhanced Scan is only available for collectible items. Run quick AI scan first.', 'warning');
        return;
    }
    
    // Check if photos are uploaded (non-negotiable requirement)
    if (!uploadedPhotos || uploadedPhotos.length === 0) {
        showAlert('Please upload photos first before running Enhanced Scan.', 'warning');
        return;
    }
    
    showLoading('Running enhanced scan... This may take 10-20 seconds');

    try {
        const response = await fetch('/api/enhanced-scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (!data.success) {
            // Check if authentication is required
            if (response.status === 401 || response.status === 403) {
                showAlert('Enhanced Scan requires authentication. Please sign up to access this feature!', 'warning');
                if (confirm('Would you like to sign up now?')) {
                    window.location.href = '{{ url_for("auth.register") }}';
                }
                hideLoading();
                return;
            }
            
            if (data.type === 'standard_item') {
                showAlert('Not a collectible. Quick analysis is sufficient for this item.', 'info');
            } else {
                showAlert(data.error || data.message || 'Enhanced scan failed', 'danger');
            }
            hideLoading();
            return;
        }

        // Artifact has been AUTOMATICALLY created/updated in Hall of Records
        // Database update is automatic (no user choice) - follows merge rules
        // User will select photos and can save to personal collection
        if (data.artifact_id) {
            hideLoading();
            showAlert('Artifact automatically updated in public Hall of Records! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = `/artifact/${data.artifact_id}`;
            }, 1500);
        } else {
            throw new Error('No artifact ID returned from server');
        }

    } catch (error) {
        console.error('Enhanced scan error:', error);
        showAlert('Enhanced scan failed: ' + (error.message || error), 'danger');
        hideLoading();
    }
}

// Display Card Results
function showCardResults(data) {
    const cardData = data.data;
    const prices = data.market_prices || {};
    
    // Extract collector value indicators
    const serialNumber = cardData.serial_number || {};
    const signature = cardData.signature || {};
    const errors = cardData.errors_variations || {};
    const history = cardData.historical_context || {};
    const condition = cardData.condition || {};
    const auth = cardData.authentication || {};

    const statsCard = `
        <div class="card border-success mb-3" id="enhancedResultsCard" style="border-color: #4CAF50;">
            <div class="card-header" style="background: var(--carbon-matte-surface); border-bottom: 2px solid #4CAF50; color: #81C784;">
                <i class="fas fa-id-card"></i> Card Analysis Complete
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>${cardData.card_name || cardData.player_name || 'Unknown Card'}</h5>
                        ${cardData.franchise ? `<p class="mb-1"><strong><i class="fas fa-tag"></i> Franchise:</strong> ${cardData.franchise}</p>` : ''}
                        ${cardData.game_name ? `<p class="mb-1"><strong><i class="fas fa-gamepad"></i> Game:</strong> ${cardData.game_name}</p>` : ''}
                        ${cardData.card_type && cardData.card_type !== 'unknown' ? `<p class="mb-1"><strong><i class="fas fa-id-card"></i> Type:</strong> ${cardData.card_type.replace('_', ' ').toUpperCase()}</p>` : ''}
                        ${cardData.set_name ? `<p class="mb-1"><strong>Set:</strong> ${cardData.set_name}</p>` : ''}
                        ${cardData.card_number ? `<p class="mb-1"><strong>Number:</strong> #${cardData.card_number}</p>` : ''}
                        ${cardData.rarity ? `<p class="mb-1"><strong>Rarity:</strong> ${cardData.rarity}</p>` : ''}
                        ${cardData.year ? `<p class="mb-1"><strong>Year:</strong> ${cardData.year}</p>` : ''}
                        ${cardData.brand ? `<p class="mb-1"><strong>Brand:</strong> ${cardData.brand}</p>` : ''}
                        ${cardData.sport ? `<p class="mb-1"><strong>Sport:</strong> ${cardData.sport}</p>` : ''}
                        ${cardData.is_rookie_card ? `<p class="mb-1"><span class="badge" style="background: #FF9800; color: white;">ROOKIE CARD</span></p>` : ''}
                        ${cardData.is_graded ? `<p class="mb-1"><strong>Graded:</strong> ${cardData.grading_company} ${cardData.grading_score}</p>` : ''}
                        
                        ${history.backstory ? `
                            <div class="mt-3 mb-3" style="background: rgba(76, 175, 80, 0.1); padding: 15px; border-radius: 5px; border-left: 3px solid #4CAF50;">
                                <h6 class="mb-2"><i class="fas fa-book-open"></i> Card History & Backstory</h6>
                                <p class="small mb-0" style="line-height: 1.6;">${history.backstory}</p>
                            </div>
                        ` : ''}
                        
                        <div class="row mt-2">
                            ${serialNumber.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-hashtag"></i> Serial Number</h6>
                                            ${serialNumber.number ? `<p class="mb-1"><strong>Number:</strong> ${serialNumber.number}</p>` : ''}
                                            ${serialNumber.format ? `<p class="mb-1 small"><strong>Format:</strong> ${serialNumber.format}</p>` : ''}
                                            ${serialNumber.significance ? `<p class="mb-0 small text-muted">${serialNumber.significance}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${signature.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-signature"></i> Signature</h6>
                                            ${signature.signer ? `<p class="mb-1"><strong>Signer:</strong> ${signature.signer}</p>` : ''}
                                            ${signature.location ? `<p class="mb-1 small"><strong>Location:</strong> ${signature.location}</p>` : ''}
                                            ${signature.value_impact ? `<p class="mb-0 small text-muted">${signature.value_impact}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${errors.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card" style="background: #fff3cd; border: 2px solid #ffc107;">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-exclamation-triangle"></i> Error / Misprint</h6>
                                            ${errors.error_type ? `<p class="mb-1"><strong>Type:</strong> ${errors.error_type}</p>` : ''}
                                            ${errors.error_description ? `<p class="mb-1 small">${errors.error_description}</p>` : ''}
                                            ${errors.value_impact ? `<p class="mb-0 small text-success"><strong>Value Impact:</strong> ${errors.value_impact}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${condition.overall_grade ? `
                            <div class="mt-2">
                                <h6><i class="fas fa-certificate"></i> Condition</h6>
                                <p class="mb-1"><strong>Grade:</strong> ${condition.overall_grade}</p>
                                ${condition.condition_details ? `<p class="small text-muted mb-0">${condition.condition_details}</p>` : ''}
                            </div>
                        ` : ''}
                        
                        ${auth.authentication_markers?.length > 0 ? `
                            <div class="mt-2">
                                <h6><i class="fas fa-shield-alt"></i> Authentication</h6>
                                <ul class="small mb-0">
                                    ${auth.authentication_markers.map(m => `<li>${m}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${cardData.collector_notes ? `
                            <div class="mt-2">
                                <h6><i class="fas fa-info-circle"></i> Collector Notes</h6>
                                <p class="small mb-0">${cardData.collector_notes}</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <h6>Market Prices</h6>
                        ${prices.tcgplayer ? `<p class="mb-1"><strong>TCGPlayer:</strong> $${prices.tcgplayer.market || 'N/A'}</p>` : ''}
                        ${prices.ebay ? `<p class="mb-1"><strong>eBay Sold Avg:</strong> $${prices.ebay.avg || 'N/A'}</p>` : ''}
                        ${prices.actual_selling ? `<p class="mb-1 text-success"><strong>Actual Selling:</strong> $${prices.actual_selling}</p>` : ''}
                        ${prices.quick_sale ? `<p class="mb-1 text-warning"><strong>Quick Sale:</strong> $${prices.quick_sale}</p>` : ''}
                        ${cardData.estimated_value_low && cardData.estimated_value_high ? `
                            <p class="mb-1"><strong>Est. Range:</strong> $${cardData.estimated_value_low} - $${cardData.estimated_value_high}</p>
                        ` : ''}
                    </div>
                </div>
                
                <hr>
                
                <!-- Storage Map Option -->
                <div class="mb-3" id="cardStorageMapOption">
                    <div class="alert alert-info" style="background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cardUseStorageMap" checked>
                            <label class="form-check-label" for="cardUseStorageMap">
                                <i class="fas fa-map-marked-alt"></i> <strong>Use storage map guidance</strong>
                            </label>
                            <small class="text-muted d-block mt-1">
                                Suggests where to place this card in your collection (front/middle/back) based on franchise and type.
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-success btn-lg" onclick="saveCardToVault()" style="flex: 1; min-width: 200px;">
                        <i class="fas fa-archive"></i> Save to Vault
                    </button>
                    <button class="btn btn-outline-success" onclick="storeCardOnly()">
                        <i class="fas fa-box"></i> Store in Collection
                    </button>
                    <button class="btn btn-outline-primary" onclick="storeAndList()">
                        <i class="fas fa-plus-circle"></i> Store + List
                    </button>
                    ${data.public_db_id ? `
                        <button class="btn btn-outline-info" onclick="window.open('/collectibles-database/${data.public_db_id}', '_blank')">
                            <i class="fas fa-database"></i> View in DB
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    // Remove existing results
    document.getElementById('enhancedResultsCard')?.remove();
    
    // Insert after market analysis or enhanced scan card
    const insertAfter = document.getElementById('marketAnalysisCard') || document.querySelector('.card');
    insertAfter.insertAdjacentHTML('afterend', statsCard);

    // Show storage map option for cards
    const storageMapOption = document.getElementById('cardStorageMapOption');
    if (storageMapOption) {
        storageMapOption.style.display = 'block';
    }

    // Also show the main storage map option
    const mainStorageMapOption = document.getElementById('storageMapOption');
    if (mainStorageMapOption) {
        mainStorageMapOption.style.display = 'block';
    }

    // Store card data globally for vault saving
    window.lastCardData = cardData;
    window.lastCardPrices = prices;
    window.lastEnhancedScanData = { data: cardData, prices: prices };

    // Fill form with detailed card info
    fillFormFromCardData(cardData, prices);
}

// Save card to vault (from card results)
async function saveCardToVault() {
    if (!window.lastCardData) {
        showAlert('No card data available. Please scan a card first.', 'warning');
        return;
    }
    
    const formData = collectFormData();
    
    // Include card data from enhanced scan
    formData.card_data = window.lastCardData;
    
    // Check if storage map guidance is enabled
    const storageMapCheckbox = document.getElementById('cardUseStorageMap');
    if (storageMapCheckbox) {
        formData.use_storage_map = storageMapCheckbox.checked;
    } else {
        // Fallback to main checkbox
        const mainCheckbox = document.getElementById('useStorageMap');
        if (mainCheckbox) {
            formData.use_storage_map = mainCheckbox.checked;
        }
    }
    
    showLoading();

    try {
        const response = await fetch('/api/save-vault', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            let message = 'Card saved to your collection vault!';
            
            // Show storage guidance if provided
            if (data.storage_guidance) {
                message += `<br><br><strong><i class="fas fa-map-marked-alt"></i> Storage Guidance:</strong><br>${data.storage_guidance}`;
            }
            
            showAlert(message, 'success');
            // Clear form and stay on page
            clearForm();
            setTimeout(() => {
                hideLoading();
            }, 1000);
        } else {
            showAlert(data.error || 'Failed to save to vault', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
        hideLoading();
    }
}

// Display Collectible Results
function showCollectibleResults(data) {
    const collectibleData = data.data;
    const prices = data.market_prices || {};
    
    // Extract collector value indicators
    const mintMark = collectibleData.mint_mark || {};
    const serialNumber = collectibleData.serial_number || {};
    const signature = collectibleData.signature || {};
    const errors = collectibleData.errors_variations || {};
    const history = collectibleData.historical_context || {};
    const condition = collectibleData.condition || {};
    const auth = collectibleData.authentication || {};

    const collectibleCard = `
        <div class="card border-warning mb-3" id="enhancedResultsCard" style="border-color: #FF9800;">
            <div class="card-header" style="background: var(--carbon-matte-surface); border-bottom: 2px solid #FF9800; color: #FFB74D;">
                <i class="fas fa-star"></i> Collectible Analysis Complete
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>${collectibleData.item_name || 'Unknown Collectible'}</h5>
                        ${collectibleData.franchise ? `<p class="mb-2"><strong>Franchise:</strong> ${collectibleData.franchise}</p>` : ''}
                        ${collectibleData.brand ? `<p class="mb-2"><strong>Brand:</strong> ${collectibleData.brand}</p>` : ''}
                        
                        ${history.backstory ? `
                            <div class="mt-3 mb-3" style="background: rgba(255, 152, 0, 0.1); padding: 15px; border-radius: 5px; border-left: 3px solid #FF9800;">
                                <h6 class="mb-2"><i class="fas fa-book-open"></i> Item History & Backstory</h6>
                                <p class="small mb-0" style="line-height: 1.6;">${history.backstory}</p>
                            </div>
                        ` : ''}
                        
                        <div class="row mt-3">
                            ${mintMark.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-stamp"></i> Mint Mark</h6>
                                            ${mintMark.mark ? `<p class="mb-1"><strong>Mark:</strong> ${mintMark.mark}</p>` : ''}
                                            ${mintMark.location ? `<p class="mb-1 small"><strong>Location:</strong> ${mintMark.location}</p>` : ''}
                                            ${mintMark.significance ? `<p class="mb-0 small text-muted">${mintMark.significance}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${serialNumber.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-hashtag"></i> Serial Number</h6>
                                            ${serialNumber.number ? `<p class="mb-1"><strong>Number:</strong> ${serialNumber.number}</p>` : ''}
                                            ${serialNumber.format ? `<p class="mb-1 small"><strong>Format:</strong> ${serialNumber.format}</p>` : ''}
                                            ${serialNumber.significance ? `<p class="mb-0 small text-muted">${serialNumber.significance}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${signature.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card bg-light">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-signature"></i> Signature</h6>
                                            ${signature.signer ? `<p class="mb-1"><strong>Signer:</strong> ${signature.signer}</p>` : ''}
                                            ${signature.location ? `<p class="mb-1 small"><strong>Location:</strong> ${signature.location}</p>` : ''}
                                            ${signature.value_impact ? `<p class="mb-0 small text-muted">${signature.value_impact}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${errors.present ? `
                                <div class="col-md-6 mb-3">
                                    <div class="card" style="background: #fff3cd; border: 2px solid #ffc107;">
                                        <div class="card-body p-2">
                                            <h6 class="mb-1"><i class="fas fa-exclamation-triangle"></i> Error / Variation</h6>
                                            ${errors.error_type ? `<p class="mb-1"><strong>Type:</strong> ${errors.error_type}</p>` : ''}
                                            ${errors.error_description ? `<p class="mb-1 small">${errors.error_description}</p>` : ''}
                                            ${errors.value_impact ? `<p class="mb-0 small text-success"><strong>Value Impact:</strong> ${errors.value_impact}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${condition.overall_grade ? `
                            <div class="mt-3">
                                <h6><i class="fas fa-certificate"></i> Condition</h6>
                                <p class="mb-1"><strong>Grade:</strong> ${condition.overall_grade}</p>
                                ${condition.condition_details ? `<p class="small text-muted mb-0">${condition.condition_details}</p>` : ''}
                            </div>
                        ` : ''}
                        
                        ${auth.authentication_markers?.length > 0 ? `
                            <div class="mt-3">
                                <h6><i class="fas fa-shield-alt"></i> Authentication</h6>
                                <ul class="small mb-0">
                                    ${auth.authentication_markers.map(m => `<li>${m}</li>`).join('')}
                                </ul>
                                ${auth.confidence !== undefined ? `<p class="small text-muted mt-1 mb-0">Confidence: ${Math.round(auth.confidence * 100)}%</p>` : ''}
                            </div>
                        ` : ''}
                        
                        ${collectibleData.collector_notes ? `
                            <div class="mt-3">
                                <h6><i class="fas fa-info-circle"></i> Collector Notes</h6>
                                <p class="small mb-0">${collectibleData.collector_notes}</p>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-4">
                        <h6>Market Analysis</h6>
                        ${prices.value_range?.low && prices.value_range?.high ? `
                            <div class="mb-2">
                                <small class="text-muted">Value Range</small>
                                <div class="h5">$${prices.value_range.low} - $${prices.value_range.high}</div>
                            </div>
                        ` : ''}
                        ${prices.actual_selling ? `
                            <div class="mb-2">
                                <small class="text-muted">Estimated Value</small>
                                <div class="h5 text-success">$${prices.actual_selling}</div>
                            </div>
                        ` : ''}
                        ${prices.retail ? `
                            <div class="mb-2">
                                <small class="text-muted">Retail Price</small>
                                <div class="h5">$${prices.retail}</div>
                            </div>
                        ` : ''}
                        ${prices.quick_sale ? `
                            <div class="mb-2">
                                <small class="text-muted">Quick Sale</small>
                                <div class="h5 text-warning">$${prices.quick_sale}</div>
                            </div>
                        ` : ''}
                        
                        ${collectibleData.market_analysis?.market_trend ? `
                            <div class="mt-3">
                                <small class="text-muted">Market Trend</small>
                                <div><span class="badge bg-info">${collectibleData.market_analysis.market_trend}</span></div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <hr>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-warning" onclick="storeCollectibleOnly()">
                        <i class="fas fa-archive"></i> Add to Collection
                    </button>
                    <button class="btn btn-outline-warning" onclick="storeCollectibleAndList()">
                        <i class="fas fa-plus-circle"></i> Store + Create Listing
                    </button>
                    ${data.public_db_id ? `
                        <button class="btn btn-outline-info" onclick="window.open('/collectibles-database/${data.public_db_id}', '_blank')">
                            <i class="fas fa-database"></i> View in Database
                        </button>
                    ` : ''}
                </div>
            </div>
        </div>
    `;

    // Remove existing results
    document.getElementById('enhancedResultsCard')?.remove();
    
    // Insert after market analysis or enhanced scan card
    const insertAfter = document.getElementById('marketAnalysisCard') || document.querySelector('.card');
    insertAfter.insertAdjacentHTML('afterend', collectibleCard);

    // Fill form with collectible info
    fillFormFromCollectible(collectibleData, prices);
}

// Fill form from card data
function fillFormFromCardData(cardData, prices) {
    // Build title
    let title = '';
    if (cardData.player_name) {
        // Sports card
        title = cardData.player_name;
        if (cardData.year) title = `${cardData.year} ${title}`;
        if (cardData.brand) title = `${title} ${cardData.brand}`;
        if (cardData.series) title = `${title} ${cardData.series}`;
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
        if (cardData.is_rookie_card) title = `${title} RC`;
    } else {
        // TCG card
        title = cardData.card_name || 'Unknown Card';
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
    }

    document.getElementById('title').value = title.substring(0, 80);

    // Build description
    let description = '';
    if (cardData.set_name) description += `Set: ${cardData.set_name}\n`;
    if (cardData.rarity) description += `Rarity: ${cardData.rarity}\n`;
    if (cardData.is_graded && cardData.grading_company) {
        description += `Graded: ${cardData.grading_company} ${cardData.grading_score || ''}\n`;
    }
    if (cardData.parallel) description += `Parallel: ${cardData.parallel}\n`;

    document.getElementById('description').value = description;

    // Set brand
    if (cardData.brand) document.getElementById('brand').value = cardData.brand;

    // Set price from market data
    if (prices.actual_selling) {
        document.getElementById('price').value = prices.actual_selling;
    } else if (cardData.estimated_value_low && cardData.estimated_value_high) {
        const avgValue = (cardData.estimated_value_low + cardData.estimated_value_high) / 2;
        document.getElementById('price').value = avgValue.toFixed(2);
    }

    // Set item type
    document.getElementById('item_type').value = 'trading_card';

    // Set condition
    if (cardData.is_graded && cardData.grading_score) {
        if (cardData.grading_score >= 9) {
            document.getElementById('condition').value = 'excellent';
        } else if (cardData.grading_score >= 7) {
            document.getElementById('condition').value = 'good';
        } else {
            document.getElementById('condition').value = 'fair';
        }
    }
}

// Fill form from collectible data
function fillFormFromCollectible(collectibleData, prices) {
    // Set title
    if (collectibleData.item_name) {
        document.getElementById('title').value = collectibleData.item_name.substring(0, 80);
    }

    // Set description
    let description = '';
    if (collectibleData.franchise) description += `Franchise: ${collectibleData.franchise}\n\n`;
    if (collectibleData.item_significance) description += `${collectibleData.item_significance}\n\n`;
    if (collectibleData.rarity_info) description += `Rarity: ${collectibleData.rarity_info}\n`;

    document.getElementById('description').value = description;

    // Set brand
    if (collectibleData.brand) document.getElementById('brand').value = collectibleData.brand;

    // Set price
    if (prices.actual_selling) {
        document.getElementById('price').value = prices.actual_selling;
    } else if (prices.retail) {
        document.getElementById('price').value = prices.retail;
    }

    // Set item type
    document.getElementById('item_type').value = 'collectible';
}

// Store card only (no listing)
async function storeCardOnly() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        // Check if storage map guidance is enabled (check both checkboxes)
        const storageMapCheckbox = document.getElementById('cardUseStorageMap') || document.getElementById('useStorageMap');
        const useStorageMap = storageMapCheckbox ? storageMapCheckbox.checked : false;
        
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                use_storage_map: useStorageMap
            })
        });

        const data = await response.json();

        if (data.success) {
            let message = 'Card stored in your collection!';
            if (data.storage_guidance) {
                message += `<br><br><strong><i class="fas fa-map-marked-alt"></i> Storage Guidance:</strong><br>${data.storage_guidance}`;
            }
            showAlert(message, 'success');
            setTimeout(() => window.location.href = '/cards', 2000);
        } else {
            showAlert(data.error || 'Failed to add card', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
        hideLoading();
    }
}

// Store card + create listing
async function storeAndList() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        // Check if storage map guidance is enabled (check both checkboxes)
        const storageMapCheckbox = document.getElementById('cardUseStorageMap') || document.getElementById('useStorageMap');
        const useStorageMap = storageMapCheckbox ? storageMapCheckbox.checked : false;
        
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                use_storage_map: useStorageMap
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card added! Continue filling out the form to create a listing.', 'success');
            
            // Update the results card
            const resultsCard = document.getElementById('enhancedResultsCard');
            if (resultsCard) {
                resultsCard.classList.remove('border-success');
                resultsCard.classList.add('border-info');
                resultsCard.querySelector('.card-header').style.background = 'var(--carbon-matte-surface)';
                resultsCard.querySelector('.card-header').style.borderBottom = '2px solid var(--cold-steel-accent)';
                resultsCard.querySelector('.card-header').style.color = 'var(--cold-steel-light)';
                resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Card Stored - Create Listing Below';
            }
        } else {
            showAlert(data.error || 'Failed to add card', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Store collectible only (no listing)
async function storeCollectibleOnly() {
    if (!detectedCollectibleData) {
        showAlert('No collectible data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/collectibles/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCollectibleData,
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Collectible stored! Redirecting...', 'success');
            setTimeout(() => window.location.href = '/my-collection', 1500);
        } else {
            showAlert(data.error || 'Failed to add collectible', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add collectible: ' + error, 'danger');
        hideLoading();
    }
}

// Store collectible + create listing
async function storeCollectibleAndList() {
    if (!detectedCollectibleData) {
        showAlert('No collectible data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/collectibles/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCollectibleData,
                photos: uploadedPhotos
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Collectible added! Continue filling out the form to create a listing.', 'success');
            
            // Update the results card
            const resultsCard = document.getElementById('enhancedResultsCard');
            if (resultsCard) {
                resultsCard.classList.remove('border-warning');
                resultsCard.classList.add('border-info');
                resultsCard.querySelector('.card-header').style.background = 'var(--carbon-matte-surface)';
                resultsCard.querySelector('.card-header').style.borderBottom = '2px solid var(--cold-steel-accent)';
                resultsCard.querySelector('.card-header').style.color = 'var(--cold-steel-light)';
                resultsCard.querySelector('.card-header').innerHTML = '<i class="fas fa-check-circle"></i> Collectible Stored - Create Listing Below';
            }
        } else {
            showAlert(data.error || 'Failed to add collectible', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add collectible: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}
// Save Listing Draft - Save to CSV and database
async function saveDraft() {
    const formData = collectFormData();

    // Ensure status is set to 'draft'
    formData.status = 'draft';

    showLoading();

    try {
        const response = await fetch('/api/save-draft-csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Draft saved successfully!', 'success');
            // Clear form and stay on page
            clearForm();
            setTimeout(() => {
                hideLoading();
            }, 1000);
        } else {
            showAlert(data.error || 'Failed to save draft', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
        hideLoading();
    }
}

// Save to Collection Vault - Save card to user's card_collections database
async function saveToVault() {
    const formData = collectFormData();

    // Validation: Ensure title is provided
    if (!formData.title || formData.title.trim() === '') {
        showAlert('Please enter a title for this item before saving to vault', 'warning');
        return;
    }

    // Include card data from AI analysis if available
    const enhancedResultsCard = document.getElementById('enhancedResultsCard');
    if (enhancedResultsCard && window.lastEnhancedScanData) {
        formData.card_data = window.lastEnhancedScanData.data;
    }

    // Also check for quick AI scan card data
    if (window.lastQuickAnalysis && (window.lastQuickAnalysis.category === 'Trading Cards' || window.lastQuickAnalysis.category === 'Sports Cards')) {
        formData.card_data = formData.card_data || window.lastQuickAnalysis;
    }

    // Check if storage map guidance is enabled
    const storageMapCheckbox = document.getElementById('useStorageMap');
    if (storageMapCheckbox) {
        formData.use_storage_map = storageMapCheckbox.checked;
    }

    console.log('[VAULT SAVE] Sending data:', {
        title: formData.title,
        hasCardData: !!formData.card_data,
        photoCount: formData.photos?.length || 0
    });

    showLoading();

    try {
        const response = await fetch('/api/save-vault', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        console.log('[VAULT SAVE] Response status:', response.status);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('[VAULT SAVE] Error response:', errorText);
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();
        console.log('[VAULT SAVE] Response data:', data);

        if (data.success) {
            let message = 'Item saved to your collection vault!';

            // Show storage guidance if provided
            if (data.storage_guidance) {
                message += `<br><br><strong><i class="fas fa-map-marked-alt"></i> Storage Guidance:</strong><br>${data.storage_guidance}`;
            }

            showAlert(message, 'success');
            // Clear form and stay on page
            clearForm();
            setTimeout(() => {
                hideLoading();
            }, 1000);
        } else {
            const errorMsg = data.error || 'Failed to save to vault';
            console.error('[VAULT SAVE] Save failed:', errorMsg);
            showAlert(errorMsg, 'danger');
            hideLoading();
        }
    } catch (error) {
        console.error('[VAULT SAVE] Exception:', error);
        showAlert('Save failed: ' + error.message, 'danger');
        hideLoading();
    }
}

// Post Listing - Show platform selection dropdown/modal
function showPlatformSelection() {
    const platforms = [
        { value: 'ebay', label: 'eBay', icon: 'fab fa-ebay' },
        { value: 'mercari', label: 'Mercari', icon: 'fas fa-store' },
        { value: 'poshmark', label: 'Poshmark', icon: 'fas fa-shopping-bag' },
        { value: 'facebook', label: 'Facebook Marketplace', icon: 'fab fa-facebook' },
        { value: 'other', label: 'Other / Custom', icon: 'fas fa-ellipsis-h' }
    ];

    let html = '<div class="modal fade" id="platformSelectionModal" tabindex="-1">';
    html += '<div class="modal-dialog"><div class="modal-content">';
    html += '<div class="modal-header bg-primary text-white">';
    html += '<h5 class="modal-title"><i class="fas fa-rocket"></i> Choose Platform</h5>';
    html += '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>';
    html += '</div><div class="modal-body">';
    html += '<p>Select where to list this item:</p>';
    
    platforms.forEach(platform => {
        html += `<div class="form-check mb-2">`;
        html += `<input class="form-check-input" type="radio" name="platform" id="platform_${platform.value}" value="${platform.value}">`;
        html += `<label class="form-check-label" for="platform_${platform.value}">`;
        html += `<i class="${platform.icon}"></i> ${platform.label}`;
        html += `</label></div>`;
    });

    html += '</div><div class="modal-footer">';
    html += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>';
    html += '<button type="button" class="btn btn-primary" onclick="confirmPostListing()">';
    html += '<i class="fas fa-check"></i> Continue</button>';
    html += '</div></div></div></div>';

    // Remove existing modal if any
    const existingModal = document.getElementById('platformSelectionModal');
    if (existingModal) existingModal.remove();

    // Add and show modal
    document.body.insertAdjacentHTML('beforeend', html);
    const modal = new bootstrap.Modal(document.getElementById('platformSelectionModal'));
    modal.show();
}

async function confirmPostListing() {
    const selectedPlatform = document.querySelector('input[name="platform"]:checked');
    
    if (!selectedPlatform) {
        showAlert('Please select a platform', 'warning');
        return;
    }

    const platform = selectedPlatform.value;
    const formData = collectFormData();
    formData.platform = platform;

    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('platformSelectionModal'));
    modal.hide();

    showLoading();

    try {
        const response = await fetch('/api/post-listing', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Listing queued for posting!', 'success');
            // Route to placeholder post-listing page
            setTimeout(() => {
                window.location.href = '/post-listing';
            }, 1500);
        } else {
            showAlert(data.error || 'Failed to queue listing', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Post failed: ' + error, 'danger');
        hideLoading();
    }
}

// Clear form function
function clearForm() {
    document.getElementById('listingForm').reset();
    uploadedPhotos = [];
    document.getElementById('photoPreview').innerHTML = '';
    
    // Disable both AI buttons when form is cleared
    document.getElementById('analyzeBtn').disabled = true;
    
    // Reset Enhanced Scan button to disabled state
    const enhancedScanBtn = document.getElementById('enhancedScanBtn');
    if (enhancedScanBtn) {
        enhancedScanBtn.disabled = true;
        enhancedScanBtn.classList.remove('btn-primary');
        enhancedScanBtn.classList.add('btn-outline-primary');
        enhancedScanBtn.title = 'Run quick AI scan first to enable Enhanced Scan';
    }
    
    // Reset any enhanced scan results
    document.getElementById('enhancedScanCard')?.remove();
    document.getElementById('enhancedResultsCard')?.remove();
    document.getElementById('marketAnalysisCard')?.remove();
    detectedCardData = null;
    detectedCollectibleData = null;
    enhancedScanData = null;
}

// Button event listeners
document.getElementById('saveDraftBtn').addEventListener('click', async function() {
    await saveDraft();
});

document.getElementById('saveToVaultBtn').addEventListener('click', async function() {
    await saveToVault();
});

document.getElementById('postListingBtn').addEventListener('click', function() {
    showPlatformSelection();
});

function collectFormData() {
    const data = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        item_type: document.getElementById('item_type').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        photos: uploadedPhotos  // CRITICAL: Include photos array
    };

    // Include draft_id if editing
    if (editingDraftId) {
        data.draft_id = editingDraftId;
        data.listing_uuid = editingListingUuid;
    }

    return data;
}

// Load draft data for editing
async function loadScanDraftData() {
    showLoading();

    try {
        // Load draft data from CSV API
        const response = await fetch('/api/drafts-csv');
        const data = await response.json();

        if (data.success) {
            // Find the draft by row ID
            const draft = data.items.find(item => item.row_id == scanDraftId);
            
            if (draft) {
                // Load photos for enhanced scanning
                if (draft.photos && draft.photos.trim()) {
                    const photoUrls = draft.photos.split(',').filter(url => url.trim());
                    
                    // Display photo previews
                    const previewDiv = document.getElementById('photoPreview');
                    previewDiv.innerHTML = '';

                    for (let i = 0; i < photoUrls.length; i++) {
                        const photoUrl = photoUrls[i].trim();
                        uploadedPhotos.push(photoUrl);

                        // Create container for photo + delete button
                        const container = document.createElement('div');
                        container.className = 'photo-preview-container';
                        container.style.position = 'relative';
                        container.style.display = 'inline-block';
                        container.style.margin = '5px';

                        // Create image
                        const img = document.createElement('img');
                        img.src = photoUrl;
                        img.className = 'photo-preview';
                        img.title = 'Click to edit | Right-click to zoom';

                        // Make photo clickable to open editor
                        img.onclick = function(e) {
                            e.preventDefault();
                            openPhotoEditor(i, this.src);
                        };

                        // Right-click to zoom
                        img.oncontextmenu = function(e) {
                            e.preventDefault();
                            openImageZoom(this.src);
                        };

                        // Create delete button
                        const deleteBtn = document.createElement('button');
                        deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                        deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                        deleteBtn.style.position = 'absolute';
                        deleteBtn.style.top = '5px';
                        deleteBtn.style.right = '5px';
                        deleteBtn.style.padding = '2px 6px';
                        deleteBtn.style.fontSize = '12px';
                        deleteBtn.title = 'Remove photo';
                        deleteBtn.onclick = function(e) {
                            e.preventDefault();
                            removePhoto(i);
                        };

                        container.appendChild(img);
                        container.appendChild(deleteBtn);
                        previewDiv.appendChild(container);
                    }

                    document.getElementById('analyzeBtn').disabled = false;
                    
                    // Show message about enhanced scanning
                    showAlert('Draft photos loaded for enhanced scanning! Use the Enhanced Scan button for detailed AI analysis.', 'info');
                } else {
                    showAlert('No photos found in this draft for scanning.', 'warning');
                }
            } else {
                showAlert('Draft not found.', 'danger');
            }
        } else {
            showAlert('Failed to load draft data.', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load draft for scanning: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}
    if (!editingDraftId) return;

    showLoading();

    try {
        const response = await fetch(`/api/get-draft/${editingDraftId}`);

        // Check if response is OK before parsing JSON
        if (!response.ok) {
            hideLoading();
            showAlert(`Failed to load draft: Server returned ${response.status}`, 'danger');
            return;
        }

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            hideLoading();
            showAlert('Failed to load draft: Invalid response format', 'danger');
            return;
        }

        const data = await response.json();

        if (data.success) {
            const listing = data.listing;
            editingListingUuid = listing.listing_uuid;

            // Populate form fields
            document.getElementById('title').value = listing.title || '';
            document.getElementById('description').value = listing.description || '';
            document.getElementById('price').value = listing.price || '';
            document.getElementById('cost').value = listing.cost || '';
            document.getElementById('condition').value = listing.condition || 'good';
            document.getElementById('item_type').value = listing.item_type || 'general';
            document.getElementById('brand').value = listing.brand || '';
            document.getElementById('size').value = listing.size || '';
            document.getElementById('color').value = listing.color || '';
            document.getElementById('shipping_cost').value = listing.shipping_cost || 0;

            // Load photos
            if (listing.photos && listing.photos.length > 0) {
                uploadedPhotos = listing.photos;

                // Display photo previews
                const previewDiv = document.getElementById('photoPreview');
                previewDiv.innerHTML = '';

                for (let i = 0; i < listing.photos.length; i++) {
                    const photoPath = listing.photos[i];
                    const photoIndex = i;

                    // Create container for photo + delete button
                    const container = document.createElement('div');
                    container.className = 'photo-preview-container';
                    container.style.position = 'relative';
                    container.style.display = 'inline-block';
                    container.style.margin = '5px';

                    // Create image
                    const img = document.createElement('img');
                    // Handle both Supabase Storage URLs and local paths
                    if (photoPath.startsWith('http://') || photoPath.startsWith('https://')) {
                        img.src = photoPath;  // Supabase Storage URL
                    } else {
                        img.src = photoPath.startsWith('/') ? photoPath : '/' + photoPath;  // Local path
                    }
                    img.className = 'photo-preview';
                    img.title = 'Click to edit | Right-click to zoom';

                    // Make photo clickable to open editor
                    img.onclick = function(e) {
                        e.preventDefault();
                        openPhotoEditor(photoIndex, this.src);
                    };

                    // Right-click to zoom
                    img.oncontextmenu = function(e) {
                        e.preventDefault();
                        openImageZoom(this.src);
                    };

                    img.onerror = function() {
                        // Fallback: try different path formats
                        this.src = '/data/draft_photos/' + listing.listing_uuid + '/' + photoPath.split('/').pop();
                    };

                    // Create delete button
                    const deleteBtn = document.createElement('button');
                    deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                    deleteBtn.className = 'btn btn-danger btn-sm photo-delete-btn';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '5px';
                    deleteBtn.style.right = '5px';
                    deleteBtn.style.padding = '2px 6px';
                    deleteBtn.style.fontSize = '12px';
                    deleteBtn.title = 'Remove photo';
                    deleteBtn.onclick = function(e) {
                        e.preventDefault();
                        removePhoto(photoIndex);
                    };

                    container.appendChild(img);
                    container.appendChild(deleteBtn);
                    previewDiv.appendChild(container);
                }

                document.getElementById('analyzeBtn').disabled = false;
            }

            showAlert('Draft loaded for editing', 'info');
        } else {
            showAlert(data.error || 'Failed to load draft', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load draft: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Load draft data when page loads
if (editingDraftId) {
    document.addEventListener('DOMContentLoaded', loadDraftData);
} else if (scanDraftId) {
    document.addEventListener('DOMContentLoaded', loadScanDraftData);
}

// Cleanup temporary photos when user navigates away without saving
// Only cleanup if we're not editing a draft/listing (those photos should persist)
let hasBeenSaved = false;  // Track if user has saved (draft or listing)
let cleanupInProgress = false;  // Prevent multiple cleanup calls

// Function to cleanup temp photos
function cleanupTempPhotos() {
    // Prevent multiple cleanup calls
    if (cleanupInProgress) {
        console.log('[CLEANUP] Cleanup already in progress, skipping');
        return;
    }
    
    // Only cleanup if:
    // 1. There are uploaded photos
    // 2. User hasn't saved yet (not a draft or listing)
    // 3. We're not editing an existing draft/listing
    if (uploadedPhotos.length === 0) {
        console.log('[CLEANUP] No photos to cleanup');
        return;
    }
    
    if (hasBeenSaved) {
        console.log('[CLEANUP] Photos have been saved, skipping cleanup');
        return;
    }
    
    if (editingDraftId || editingListingUuid) {
        console.log('[CLEANUP] Editing existing draft/listing, skipping cleanup');
        return;
    }
    
    console.log('[CLEANUP] Starting cleanup of', uploadedPhotos.length, 'temp photos');
    
    // Filter to only temp-photos bucket URLs (don't cleanup listing-images or draft-images)
    const tempPhotoUrls = uploadedPhotos.filter(url => 
        url.includes('supabase.co') && url.includes('temp-photos')
    );
    
    if (tempPhotoUrls.length === 0) {
        console.log('[CLEANUP] No temp-photos URLs to cleanup');
        return;
    }
    
    console.log('[CLEANUP] Will cleanup', tempPhotoUrls.length, 'photos from temp-photos bucket');
    
    cleanupInProgress = true;
    
    try {
        // Use fetch with keepalive (more reliable than sendBeacon for JSON)
        // keepalive ensures request completes even if page is closing
        fetch('/api/cleanup-temp-photos', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({photos: tempPhotoUrls}),
            keepalive: true  // Critical: ensures request completes even if page closes
        }).then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error(`HTTP ${response.status}`);
        }).then(data => {
            console.log('[CLEANUP] âœ… Cleanup successful:', data.message || 'deleted', data.deleted || 0, 'photos');
        }).catch(error => {
            console.warn('[CLEANUP] âš ï¸ Cleanup request failed (best effort):', error);
        });
    } catch (e) {
        // Ignore errors - cleanup is best effort
        console.warn('[CLEANUP] âš ï¸ Cleanup failed (best effort):', e);
    }
}

// Handle page unload (user closes tab/navigates away)
window.addEventListener('beforeunload', function(e) {
    cleanupTempPhotos();
});

// Handle visibility change (when tab becomes hidden/closed)
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        cleanupTempPhotos();
    }
});

// Also cleanup when user navigates to a different page (pushstate/popstate)
let lastUrl = location.href;
new MutationObserver(() => {
    const url = location.href;
    if (url !== lastUrl) {
        lastUrl = url;
        cleanupTempPhotos();
    }
}).observe(document, {subtree: true, childList: true});

// Mark as saved when listing is saved (saveListing function is called)
// We'll hook into the saveListing function below

// ========================================
// INITIALIZE PHOTO UPLOAD EVENT LISTENERS
// ========================================
(function() {
    console.log('[INIT] Setting up photo upload event listeners...');

    // Take Photo button
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const cameraInput = document.getElementById('cameraInput');

    if (takePhotoBtn && cameraInput) {
        takePhotoBtn.addEventListener('click', function(e) {
            console.log('[CLICK] Take Photo button clicked');
            e.preventDefault();
            cameraInput.click();
        });

        cameraInput.addEventListener('change', handlePhotoSelect);
        console.log('[INIT] âœ… Camera input event listener attached');
    } else {
        console.error('[INIT] âŒ Take Photo button or camera input not found!');
    }

    // Upload Files button
    const uploadFilesBtn = document.getElementById('uploadFilesBtn');
    const photoInput = document.getElementById('photoInput');

    if (uploadFilesBtn && photoInput) {
        uploadFilesBtn.addEventListener('click', function(e) {
            console.log('[CLICK] Upload Files button clicked');
            e.preventDefault();
            photoInput.click();
        });

        photoInput.addEventListener('change', handlePhotoSelect);
        console.log('[INIT] âœ… Photo input event listener attached');
    } else {
        console.error('[INIT] âŒ Upload Files button or photo input not found!');
    }

    console.log('[INIT] Photo upload initialization complete');
})();
</script>
{% endblock %}
