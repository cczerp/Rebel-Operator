{% extends "base.html" %}

{% block title %}Create Listing{% endblock %}

{% block content %}
{% if not current_user.is_authenticated %}
<div class="alert alert-success mb-4">
    <h5 class="alert-heading"><i class="fas fa-magic"></i> Try ResellGenie AI FREE!</h5>
    <p class="mb-0">Upload a photo and watch AI create your listing instantly. No sign-up required to test!</p>
</div>
{% endif %}

<h2 class="mb-4"><i class="fas fa-plus-circle"></i> Create New Listing</h2>

<form id="listingForm">
    <!-- Photo Upload -->
    <div class="card mb-3">
        <div class="card-header" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">
            <i class="fas fa-camera"></i> Photos
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-6">
                    <button type="button" class="btn btn-utility w-100" id="cameraBtn">
                        <i class="fas fa-camera"></i><br>Take Photo
                    </button>
                    <input type="file" class="d-none" id="cameraInput" name="photos" accept="image/*" capture="environment">
                </div>
                <div class="col-6">
                    <button type="button" class="btn btn-utility w-100" id="uploadBtn">
                        <i class="fas fa-upload"></i><br>Upload Files
                    </button>
                    <input type="file" class="d-none" id="photoInput" name="photos" multiple accept="image/*">
                </div>
            </div>

            <div id="photoPreview" class="mt-3 d-flex flex-wrap"></div>
            <button type="button" class="btn btn-hero-outline mt-2" id="analyzeBtn" disabled title="Upload photos first to enable AI analysis">
                <i class="fas fa-magic"></i> Analyze with AI
            </button>
            <button type="button" class="btn btn-hero-outline mt-2 ms-2" id="enhancedAnalyzerBtn" disabled title="Run AI analysis first to enable this feature">
                <i class="fas fa-gem"></i> Enhanced Analyzer
            </button>
        </div>
    </div>

    <!-- Listing Details -->
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-edit"></i> Details
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Title *</label>
                <input type="text" class="form-control" id="title" name="title" required maxlength="80">
                <small class="text-muted">Max 80 characters</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="description" name="description" rows="4"></textarea>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">Price ($) *</label>
                    <input type="number" class="form-control" id="price" name="price" step="0.01" required>
                </div>
                <div class="col-6">
                    <label class="form-label">Cost ($)</label>
                    <input type="number" class="form-control" id="cost" name="cost" step="0.01">
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-6">
                    <label class="form-label">Condition</label>
                    <select class="form-select" id="condition" name="condition">
                        <option value="new">New</option>
                        <option value="like_new">Like New</option>
                        <option value="excellent" selected>Excellent</option>
                        <option value="good">Good</option>
                        <option value="fair">Fair</option>
                        <option value="poor">Poor</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label">Item Type</label>
                    <select class="form-select" id="item_type" name="item_type">
                        <option value="general" selected>General Item</option>
                        <option value="clothing">Clothing & Accessories</option>
                        <option value="electronics">Electronics</option>
                        <option value="trading_card">Trading Cards (TCG/Sports)</option>
                        <option value="collectible">Collectibles</option>
                        <option value="home_garden">Home & Garden</option>
                        <option value="toys_games">Toys & Games</option>
                        <option value="books_media">Books & Media</option>
                        <option value="jewelry">Jewelry & Watches</option>
                        <option value="antiques">Antiques & Vintage</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-4">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" name="brand">
                </div>
                <div class="col-4">
                    <label class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size">
                </div>
                <div class="col-4">
                    <label class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color">
                </div>
            </div>

            <div class="mb-3 mt-3">
                <label class="form-label">Shipping Cost ($)</label>
                <input type="number" class="form-control" id="shipping_cost" name="shipping_cost" step="0.01" value="0">
                <small class="text-muted">0 for free shipping</small>
            </div>
        </div>
    </div>

    <!-- Inventory Management -->
    <div class="card mb-3">
        <div class="card-header" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">
            <i class="fas fa-box"></i> Inventory Management
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-map-marker-alt"></i> Storage Location *
                </label>
                <input type="text" class="form-control form-control-lg" id="storage_location" name="storage_location" placeholder="B1, C2, Shelf-3, etc." required>
                <small class="text-muted">Where you'll put this item (so you can find it when it sells!)</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Quantity</label>
                <input type="number" class="form-control" id="quantity" name="quantity" value="1" min="1">
                <small class="text-muted">1 for single items, >1 for multiples</small>
            </div>

            <div class="row">
                <div class="col-6">
                    <label class="form-label">SKU / Custom ID</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="sku" name="sku" placeholder="Optional">
                        <button class="btn btn-utility" type="button" onclick="generateSKU()" title="Generate random SKU">
                            <i class="fas fa-random"></i> Generate
                        </button>
                    </div>
                </div>
                <div class="col-6">
                    <label class="form-label">UPC / Barcode</label>
                    <input type="text" class="form-control" id="upc" name="upc" placeholder="Optional">
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Selection -->
    {% if current_user.is_authenticated %}
    <div class="card mb-3">
        <div class="card-header">
            <i class="fas fa-store-alt"></i> Select Platforms to Post
        </div>
        <div class="card-body">
            <p class="text-muted small mb-3">
                Choose where you want to list this item. <span class="badge" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">API</span> platforms post automatically.
                <span class="badge" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span> platforms generate a file for manual upload.
            </p>

            <div class="row">
                <!-- API Platforms -->
                <div class="col-md-6">
                    <h6 class="text-success mb-2"><i class="fas fa-robot"></i> Automated (API)</h6>
                    <div class="platform-checkboxes">
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_etsy" value="etsy">
                            <label class="form-check-label" for="platform_etsy">
                                <i class="fas fa-store text-warning"></i> Etsy
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">API</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_shopify" value="shopify">
                            <label class="form-check-label" for="platform_shopify">
                                <i class="fas fa-shopping-cart text-success"></i> Shopify
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">API</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_woocommerce" value="woocommerce">
                            <label class="form-check-label" for="platform_woocommerce">
                                <i class="fas fa-wordpress text-primary"></i> WooCommerce
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">API</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_facebook" value="facebook">
                            <label class="form-check-label" for="platform_facebook">
                                <i class="fab fa-facebook text-primary"></i> Facebook Shops
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;">API</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- CSV Platforms -->
                <div class="col-md-6">
                    <h6 class="text-info mb-2"><i class="fas fa-file-csv"></i> Manual Upload (CSV)</h6>
                    <div class="platform-checkboxes">
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_poshmark" value="poshmark">
                            <label class="form-check-label" for="platform_poshmark">
                                <i class="fas fa-tshirt text-danger"></i> Poshmark
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_mercari" value="mercari">
                            <label class="form-check-label" for="platform_mercari">
                                <i class="fas fa-shopping-bag text-primary"></i> Mercari
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_ebay" value="ebay">
                            <label class="form-check-label" for="platform_ebay">
                                <i class="fab fa-ebay text-warning"></i> eBay
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_grailed" value="grailed">
                            <label class="form-check-label" for="platform_grailed">
                                <i class="fas fa-tshirt text-dark"></i> Grailed
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_depop" value="depop">
                            <label class="form-check-label" for="platform_depop">
                                <i class="fas fa-store text-danger"></i> Depop
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_bonanza" value="bonanza">
                            <label class="form-check-label" for="platform_bonanza">
                                <i class="fas fa-gem text-warning"></i> Bonanza
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_ecrater" value="ecrater">
                            <label class="form-check-label" for="platform_ecrater">
                                <i class="fas fa-store text-info"></i> Ecrater
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_rubylane" value="ruby_lane">
                            <label class="form-check-label" for="platform_rubylane">
                                <i class="fas fa-gem text-danger"></i> Ruby Lane
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_offerup" value="offerup">
                            <label class="form-check-label" for="platform_offerup">
                                <i class="fas fa-mobile-alt text-success"></i> OfferUp
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_vinted" value="vinted">
                            <label class="form-check-label" for="platform_vinted">
                                <i class="fas fa-tshirt text-primary"></i> Vinted
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_tradesy" value="tradesy">
                            <label class="form-check-label" for="platform_tradesy">
                                <i class="fas fa-hand-holding-usd text-warning"></i> Tradesy
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_thredup" value="thredup">
                            <label class="form-check-label" for="platform_thredup">
                                <i class="fas fa-recycle text-success"></i> ThredUp
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_vestiaire" value="vestiaire">
                            <label class="form-check-label" for="platform_vestiaire">
                                <i class="fas fa-tshirt text-info"></i> Vestiaire Collective
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_rebag" value="rebag">
                            <label class="form-check-label" for="platform_rebag">
                                <i class="fas fa-handbag text-dark"></i> Rebag
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_mercado_libre" value="mercado_libre">
                            <label class="form-check-label" for="platform_mercado_libre">
                                <i class="fas fa-globe-americas text-primary"></i> Mercado Libre
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                        <div class="form-check platform-item">
                            <input class="form-check-input" type="checkbox" id="platform_poshmark_ca" value="poshmark_ca">
                            <label class="form-check-label" for="platform_poshmark_ca">
                                <i class="fas fa-tshirt text-danger"></i> Poshmark CA
                                <span class="badge ms-2" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">CSV</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- Template Platforms -->
                <div class="col-md-12 mt-3">
                    <h6 class="text-secondary mb-2"><i class="fas fa-file-alt"></i> Template Platforms (Copy & Paste)</h6>
                    <div class="platform-checkboxes">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_craigslist" value="craigslist">
                                    <label class="form-check-label" for="platform_craigslist">
                                        <i class="fas fa-list text-success"></i> Craigslist
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_nextdoor" value="nextdoor">
                                    <label class="form-check-label" for="platform_nextdoor">
                                        <i class="fas fa-home text-primary"></i> Nextdoor
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_varagesale" value="varagesale">
                                    <label class="form-check-label" for="platform_varagesale">
                                        <i class="fas fa-users text-info"></i> VarageSale
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_kijiji" value="kijiji">
                                    <label class="form-check-label" for="platform_kijiji">
                                        <i class="fas fa-map-marker-alt text-danger"></i> Kijiji
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_tiktok_shop" value="tiktok_shop">
                                    <label class="form-check-label" for="platform_tiktok_shop">
                                        <i class="fab fa-tiktok text-dark"></i> TikTok Shop
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-check platform-item">
                                    <input class="form-check-input" type="checkbox" id="platform_personal_website" value="personal_website">
                                    <label class="form-check-label" for="platform_personal_website">
                                        <i class="fas fa-globe text-primary"></i> Personal Website
                                        <span class="badge ms-2" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);">Template</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-warning mt-3 mb-0">
                <i class="fas fa-info-circle"></i> <strong>Configure credentials in <a href="{{ url_for('settings') }}">Settings</a></strong> to enable automated posting!
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="d-grid gap-2">
        {% if not current_user.is_authenticated %}
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i> <strong>Try the AI for free!</strong> Sign up (free) to save your listings and track inventory.
        </div>
        <a href="{{ url_for('auth.register') }}" class="btn btn-primary btn-lg">
            <i class="fas fa-user-plus"></i> Sign Up Free to Save Listing
        </a>
        <small class="text-muted text-center mt-2">
            You can test the AI photo analysis above without signing up!
        </small>
        {% else %}
        <button type="button" class="btn btn-success btn-lg" id="postNowBtn">
            <i class="fas fa-rocket"></i> Post Now (Make Active)
        </button>
        <button type="button" class="btn btn-utility btn-lg" id="saveDraftBtn">
            <i class="fas fa-save"></i> Save as Draft
        </button>
        <button type="button" class="btn btn-secondary btn-lg" id="discardListingBtn">
            <i class="fas fa-trash"></i> Discard This Listing
        </button>
        <a href="{{ url_for('drafts') }}" class="btn btn-secondary btn-sm mt-2">
            <i class="fas fa-folder-open"></i> View Drafts
        </a>
        <small class="text-muted text-center mt-2 d-block">
            <strong>Post Now</strong> makes it active for selling. <strong>Save as Draft</strong> saves it for later.
            <br>
            <strong>Discard This Listing</strong> deletes this draft and its images from your workspace.
        </small>
        {% endif %}
    </div>
</form>

<!-- Photo Editor Modal -->
<div id="photoEditorModal" class="photo-editor-modal">
    <div class="photo-editor-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-magic"></i> Edit Photo (FREE!)</h4>
            <button class="btn btn-secondary" onclick="closePhotoEditor()">
                <i class="fas fa-times"></i> Close
            </button>
        </div>

        <div class="text-center mb-3">
            <img id="photoEditorImage" class="photo-editor-image" src="">
        </div>

        <div class="photo-editor-toolbar">
            <button class="btn btn-primary" onclick="enableCrop()">
                <i class="fas fa-crop"></i> Crop
            </button>
            <button class="btn btn-primary" id="cropBtn" onclick="applyCrop()" style="display:none;">
                <i class="fas fa-check"></i> Apply Crop
            </button>
            <button class="btn btn-secondary" id="cancelCropBtn" onclick="cancelCrop()" style="display:none;">
                <i class="fas fa-times"></i> Cancel Crop
            </button>
            <button class="btn btn-hero-outline" onclick="removeBackground()">
                <i class="fas fa-magic"></i> Remove Background
            </button>
            <button class="btn btn-hero-outline" onclick="enlargePhoto()">
                <i class="fas fa-search-plus"></i> Enlarge (2x)
            </button>
            <button class="btn btn-secondary" onclick="resetPhoto()">
                <i class="fas fa-undo"></i> Reset
            </button>
        </div>

        <div class="alert alert-info mt-3">
            <i class="fas fa-gift"></i> <strong>FREE Feature!</strong> Other apps charge $5-20/month for background removal. We give it to you free!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('========================================');
console.log('CREATE.HTML JAVASCRIPT LOADED');
console.log('Current user authenticated:', {{ 'true' if current_user.is_authenticated else 'false' }});
console.log('========================================');

let currentListingId = {{ listing_id if listing_id else 'null' }};
let currentListingUuid = {{ listing_uuid|tojson if listing_uuid else 'null' }};
let uploadedPhotos = {{ listing_photos|tojson if listing_photos else '[]' }};
let editingDraftId = {{ draft_id if draft_id else 'null' }};
let editingListingUuid = currentListingUuid;
let currentSessionId = null;

function ensureSessionId() {
    if (currentSessionId) {
        return currentSessionId;
    }
    try {
        const existing = window.sessionStorage.getItem('createSessionId');
        if (existing) {
            currentSessionId = existing;
            console.log('[SESSION] Reusing existing session_id from sessionStorage:', currentSessionId);
            return currentSessionId;
        }
    } catch (e) {
        console.warn('[SESSION] Unable to access sessionStorage:', e);
    }

    // Simple UUID-like generator for session ID
    const rand = () => Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
    currentSessionId = `sess-${rand()}${rand()}-${rand()}-${rand()}-${rand()}${rand()}${rand()}`;

    try {
        window.sessionStorage.setItem('createSessionId', currentSessionId);
    } catch (e) {
        console.warn('[SESSION] Unable to persist session_id to sessionStorage:', e);
    }

    console.log('[SESSION] Generated new session_id:', currentSessionId);
    return currentSessionId;
}

// Helper function to manage analyze button state
// Safe to call on any page - returns early if button doesn't exist
function updateAnalyzeButtonState() {
    try {
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (!analyzeBtn) return; // Button doesn't exist on this page - that's fine
        
        if (uploadedPhotos && uploadedPhotos.length > 0) {
            analyzeBtn.disabled = false;
            analyzeBtn.title = 'Click to analyze photos with AI';
            analyzeBtn.classList.remove('disabled');
        } else {
            analyzeBtn.disabled = true;
            analyzeBtn.title = 'Upload photos first to enable AI analysis';
            analyzeBtn.classList.add('disabled');
        }
    } catch (e) {
        // Silently fail if called on wrong page
        console.log('[CREATE] updateAnalyzeButtonState: Button not available on this page');
    }
}

// Log initialization values for debugging
console.log('[INIT] currentListingId:', currentListingId, typeof currentListingId);
console.log('[INIT] currentListingUuid:', currentListingUuid);
console.log('[INIT] editingDraftId:', editingDraftId);
console.log('[INIT] uploadedPhotos from database:', uploadedPhotos);

// IMAGE_CONTRACT: Render photos immediately on page load from database
if (uploadedPhotos && uploadedPhotos.length > 0) {
    console.log('[INIT] Rendering', uploadedPhotos.length, 'photos from database');
    // Use DOMContentLoaded or immediate execution depending on when script loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            refreshPhotoPreviews();
            updateAnalyzeButtonState();
        });
    } else {
        refreshPhotoPreviews();
        updateAnalyzeButtonState();
    }
} else {
    // Ensure analyze button starts in correct state
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            updateAnalyzeButtonState();
        });
    } else {
        updateAnalyzeButtonState();
    }
}

// Generic photo handling function for both camera and file upload
async function handlePhotoSelect(e) {
    console.log('[UPLOAD] handlePhotoSelect called', e);

    // Defensive check: ensure event and target exist
    if (!e || !e.target) {
        console.error('[UPLOAD ERROR] Invalid event object:', e);
        showAlert('Error: Invalid file selection event. Please try again.', 'danger');
        return;
    }

    // Defensive check: ensure files property exists
    if (!e.target.files) {
        console.error('[UPLOAD ERROR] No files property on target:', e.target);
        showAlert('Error: Unable to access selected files. Please try again.', 'danger');
        return;
    }

    const files = e.target.files;
    console.log('[UPLOAD] Selected files:', files.length, Array.from(files).map(f => f.name));

    if (files.length === 0) {
        console.log('[UPLOAD] No files selected, returning');
        return;
    }

    const formData = new FormData();
    if (currentListingId) {
        console.log('[UPLOAD] Using listing_id (committed listing mode):', currentListingId);
        formData.append('listing_id', currentListingId);
    } else {
        const sessionId = ensureSessionId();
        console.log('[UPLOAD] Using session_id (temp session mode):', sessionId);
        formData.append('session_id', sessionId);
    }
    for (let file of files) {
        console.log('[UPLOAD] Adding file:', file.name, file.size, 'bytes');
        formData.append('photos', file);
    }

    // Show loading spinner (with error handling)
    try {
        console.log('[UPLOAD] Showing loading spinner');
        showLoading();
    } catch (err) {
        console.warn('[UPLOAD] showLoading error:', err);
    }

    try {
        console.log('[UPLOAD] Sending fetch request to /api/upload-photos');
        const response = await fetch('/api/upload-photos', {
            method: 'POST',
            body: formData,
            credentials: 'include'  // Ensure session cookies are sent
        });

        console.log('[UPLOAD] Response status:', response.status, response.statusText);

        // Check for HTTP error status codes
        if (!response.ok) {
            console.error('[UPLOAD ERROR] HTTP error status:', response.status);
            const data = await response.json().catch(() => ({ error: `HTTP ${response.status}: ${response.statusText}` }));
            console.error('[UPLOAD ERROR] Error response:', data);
            const errorMsg = data.error || `Server returned error ${response.status}`;
            showAlert(`Upload failed: ${errorMsg}`, 'danger');
            return;
        }

        const data = await response.json();
        console.log('[UPLOAD] Response data:', data);

        if (data.success) {
            console.log('[UPLOAD] Upload successful, mode:', data.mode, 'paths:', data.paths);
            
            // For committed listings, prefer all_photos from DB as source of truth
            if (data.mode === 'listing' && data.all_photos && Array.isArray(data.all_photos)) {
                uploadedPhotos = data.all_photos;
            } else {
                const newPaths = data.paths || [];
                uploadedPhotos = uploadedPhotos.concat(newPaths);
            }

            // Refresh photo previews from current uploadedPhotos
            refreshPhotoPreviews();
            updateAnalyzeButtonState();

            console.log('[UPLOAD] Enabled analyze button (if available)');
            showAlert(`${data.count} photo(s) added! Total: ${uploadedPhotos.length}`, 'success');
        } else {
            console.error('[UPLOAD] Upload failed:', data.error);
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        console.error('[UPLOAD] Exception caught:', error);
        const errorMessage = (error && typeof error === 'object' && 'message' in error)
            ? error.message
            : String(error);
        const errorStack = (error && typeof error === 'object' && 'stack' in error)
            ? error.stack
            : undefined;
        console.error('[UPLOAD] Error details:', errorMessage, errorStack);

        // Show detailed error to user
        showAlert('Upload failed: ' + errorMessage + '. Check browser console for details.', 'danger');
    } finally {
        // Hide loading spinner (with error handling)
        try {
            console.log('[UPLOAD] Hiding loading spinner');
            hideLoading();
        } catch (err) {
            console.warn('[UPLOAD] hideLoading error:', err);
        }
    }

    // Reset input so same file can be selected again
    e.target.value = '';
    console.log('[UPLOAD] Reset file input');
}

// Attach upload handlers after DOM is ready and function is defined
document.addEventListener('DOMContentLoaded', function() {
    const cameraBtn = document.getElementById('cameraBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const cameraInput = document.getElementById('cameraInput');
    const photoInput = document.getElementById('photoInput');

    if (cameraBtn && cameraInput) {
        cameraBtn.onclick = function() {
            console.log('[UPLOAD] Camera button clicked');
            cameraInput.click();
        };
    }
    if (uploadBtn && photoInput) {
        uploadBtn.onclick = function() {
            console.log('[UPLOAD] Upload button clicked');
            photoInput.click();
        };
    }
    if (cameraInput) {
        cameraInput.onchange = handlePhotoSelect;
        console.log('[UPLOAD] Attached onchange handler to cameraInput');
    } else {
        console.error('[UPLOAD ERROR] cameraInput element not found!');
    }
    if (photoInput) {
        photoInput.onchange = handlePhotoSelect;
        console.log('[UPLOAD] Attached onchange handler to photoInput');
    } else {
        console.error('[UPLOAD ERROR] photoInput element not found!');
    }
    console.log('[UPLOAD] Handler attachment complete. Elements found:', {
        cameraBtn: !!cameraBtn,
        uploadBtn: !!uploadBtn,
        cameraInput: !!cameraInput,
        photoInput: !!photoInput
    });
});

// ========================================
// PHOTO EDITOR FUNCTIONS (FREE!)
// ========================================
let cropper = null;
let currentEditingPhotoIndex = null;
let currentEditingPhotoSrc = null;
let originalPhotoSrc = null;

async function openPhotoEditor(photoIndex, photoSrc) {
    currentEditingPhotoIndex = photoIndex;
    originalPhotoSrc = photoSrc;

    const modal = document.getElementById('photoEditorModal');
    const img = document.getElementById('photoEditorImage');

    // Convert blob URL to base64 data URL
    try {
        if (photoSrc.startsWith('blob:')) {
            // Fetch the blob and convert to base64
            const response = await fetch(photoSrc);
            const blob = await response.blob();

            // Convert blob to base64 using FileReader
            const reader = new FileReader();
            reader.onloadend = function() {
                currentEditingPhotoSrc = reader.result; // This is the base64 data URL
                img.src = currentEditingPhotoSrc;
            };
            reader.readAsDataURL(blob);
        } else {
            // Already a data URL or regular URL
            currentEditingPhotoSrc = photoSrc;
            img.src = photoSrc;
        }
    } catch (error) {
        console.error('Error converting image:', error);
        currentEditingPhotoSrc = photoSrc;
        img.src = photoSrc;
    }

    modal.classList.add('show');

    // Destroy existing cropper if any
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    // Reset buttons
    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

function closePhotoEditor() {
    const modal = document.getElementById('photoEditorModal');
    modal.classList.remove('show');

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function enableCrop() {
    const img = document.getElementById('photoEditorImage');

    if (cropper) {
        cropper.destroy();
    }

    cropper = new Cropper(img, {
        aspectRatio: NaN, // Free aspect ratio
        viewMode: 1,
        responsive: true,
        autoCropArea: 0.8,
        background: false,
        ready: function() {
            showAlert('Drag to select crop area', 'info');
        }
    });

    // Show crop action buttons
    document.getElementById('cropBtn').style.display = 'inline-block';
    document.getElementById('cancelCropBtn').style.display = 'inline-block';
}

async function applyCrop() {
    if (!cropper) return;

    showLoading();

    try {
        const canvas = cropper.getCroppedCanvas();
        const croppedImage = canvas.toDataURL('image/png');

        // Get crop coordinates for API call
        const cropData = cropper.getData();

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'crop',
                crop: {
                    x: Math.round(cropData.x),
                    y: Math.round(cropData.y),
                    width: Math.round(cropData.width),
                    height: Math.round(cropData.height)
                }
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            // Update the photo
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo cropped successfully!', 'success');

            // Cleanup cropper
            cropper.destroy();
            cropper = null;
            document.getElementById('cropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
        } else {
            showAlert('Crop failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Crop timed out. Please try again.', 'warning');
        } else {
            showAlert('Crop failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function cancelCrop() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    document.getElementById('cropBtn').style.display = 'none';
    document.getElementById('cancelCropBtn').style.display = 'none';
}

async function removeBackground() {
    if (!currentEditingPhotoSrc) return;

    showLoading();
    showAlert('Removing background... This may take 10-15 seconds', 'info');

    try {
        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 30000); // 30 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'remove-bg'
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Background removed! (FREE feature worth $5-20/mo)', 'success');
        } else {
            showAlert('Background removal failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Background removal timed out. The image may be too large. Try a smaller image or crop it first.', 'warning');
        } else {
            showAlert('Background removal failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

async function enlargePhoto() {
    if (!currentEditingPhotoSrc) return;

    showLoading();

    try {
        // Get current image dimensions
        const img = document.getElementById('photoEditorImage');
        const currentWidth = img.naturalWidth;
        const currentHeight = img.naturalHeight;

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 20000); // 20 second timeout

        const response = await fetch('/api/edit-photo', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                image: currentEditingPhotoSrc,
                operation: 'resize',
                width: currentWidth * 2,
                height: currentHeight * 2
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            updatePhotoAfterEdit(data.image, data.filepath);
            showAlert('Photo enlarged to 2x size!', 'success');
        } else {
            showAlert('Enlarge failed: ' + (data.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            showAlert('Enlarge timed out. The image may be too large.', 'warning');
        } else {
            showAlert('Enlarge failed: ' + error.message, 'danger');
        }
    } finally {
        hideLoading();
    }
}

function resetPhoto() {
    if (!originalPhotoSrc) return;

    const img = document.getElementById('photoEditorImage');
    img.src = originalPhotoSrc;
    currentEditingPhotoSrc = originalPhotoSrc;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = originalPhotoSrc;
    }

    if (cropper) {
        cropper.destroy();
        cropper = null;
    }

    showAlert('Photo reset to original', 'info');
}

function updatePhotoAfterEdit(newImageData, newFilepath) {
    // Update the modal image
    const img = document.getElementById('photoEditorImage');
    img.src = newImageData;
    currentEditingPhotoSrc = newImageData;

    // Update the preview thumbnail
    const previews = document.querySelectorAll('.photo-preview');
    if (previews[currentEditingPhotoIndex]) {
        previews[currentEditingPhotoIndex].src = newImageData;
    }

    // Update the uploaded photos array with new filepath
    if (newFilepath) {
        uploadedPhotos[currentEditingPhotoIndex] = newFilepath;
    }
}

// ========================================
// AI Analysis
let detectedCardData = null; // Store card data if detected
let enhancedAnalysisData = null; // Store enhanced collectible analysis
let stage1AnalysisData = null; // Store Stage 1 analysis results (required for Stage 2 prerequisites)
let aiStatus = { gemini: false, claude: false }; // Track AI service availability

// Check AI service status on page load
async function checkAIStatus() {
    try {
        const response = await fetch('/api/ai-status');
        if (response.ok) {
            const data = await response.json();
            aiStatus = {
                gemini: data.status.gemini.configured,
                claude: data.status.claude.configured
            };
            
            // Update button tooltips based on availability
            const analyzeBtn = document.getElementById('analyzeBtn');
            if (analyzeBtn && !aiStatus.gemini) {
                analyzeBtn.title = 'AI service not configured. Please set GEMINI_API_KEY environment variable.';
            }
            
            const enhancedBtn = document.getElementById('enhancedAnalyzerBtn');
            if (enhancedBtn && !aiStatus.claude) {
                enhancedBtn.title = 'Enhanced Analyzer requires Claude API key (ANTHROPIC_API_KEY).';
            }
            
            // Show warning if AI is not configured
            if (!aiStatus.gemini) {
                console.warn('[AI] Gemini API key not configured. Basic AI analysis will not work.');
            }
            if (!aiStatus.claude) {
                console.warn('[AI] Claude API key not configured. Enhanced Analyzer will not work.');
            }
        }
    } catch (error) {
        console.error('[AI] Failed to check AI status:', error);
    }
}

// Check AI status when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAIStatus);
} else {
    checkAIStatus();
}

// Ensure analyze button event listener is attached after DOM is ready
function initializeAnalyzeButton() {
    try {
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (!analyzeBtn) {
            // Button doesn't exist on this page (e.g., login page) - that's fine
            return;
        }
        
        // Remove any existing listeners (in case of multiple initializations)
        const newBtn = analyzeBtn.cloneNode(true);
        analyzeBtn.parentNode.replaceChild(newBtn, analyzeBtn);
        
        newBtn.addEventListener('click', async function() {
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        // Validate prerequisites before starting analysis
        if (!uploadedPhotos || uploadedPhotos.length === 0) {
            showAlert('Please upload photos first before running AI analysis.', 'warning');
            return;
        }
        
        if (!currentListingId) {
            showAlert('Error: Listing ID not found. Please refresh the page.', 'danger');
            return;
        }
        
        // Check if AI service is configured
        if (!aiStatus.gemini) {
            showAlert('AI service is not configured. Please set GEMINI_API_KEY environment variable. See AI_SETUP.md for instructions.', 'danger');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = originalText;
            hideLoading();
            return;
        }
        
        const originalText = analyzeBtn.innerHTML;
        
        // Show loading state
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
        showLoading();

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 60000); // 60 second timeout

        try {
        // Try card analysis first - now returns job_id
        console.log('[AI] Starting card analysis with photos:', uploadedPhotos);
        const cardResponse = await fetch('/api/analyze-card', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                photos: uploadedPhotos
            }),
            signal: controller.signal
        });

            clearTimeout(timeout);

            if (!cardResponse.ok) {
                const errorText = await cardResponse.text();
                console.error('[AI] Card analysis HTTP error:', cardResponse.status, errorText);
                throw new Error(`Card analysis failed: ${cardResponse.statusText} - ${errorText}`);
            }

            const cardJob = await cardResponse.json();
            console.log('[AI] Card analysis job created:', cardJob);
            
            // If job_id is returned, poll for results
            if (cardJob.job_id) {
                try {
                    const cardData = await pollJobStatus('/api/analyze-card-status/' + cardJob.job_id, 60);
                    
                    // Log response for debugging
                    console.log('Card analysis response:', cardData);

                    // Check if it's a card
                    if (cardData.success && cardData.card_data && cardData.card_data.is_card) {
                        // Store card data for later
                        detectedCardData = cardData.card_data;

                        // Store enhanced analysis if available
                        if (cardData.collectible_analysis) {
                            enhancedAnalysisData = cardData.collectible_analysis;
                        }

                        // Show card detection banner
                        showCardDetectionBanner(cardData.card_data);

                        // Fill form with card data
                        fillFormFromCardData(cardData.card_data);

                        // Enable enhanced analyzer button
                        const enhancedBtn = document.getElementById('enhancedAnalyzerBtn');
                        enhancedBtn.disabled = false;
                        enhancedBtn.classList.remove('btn-outline-warning');
                        enhancedBtn.classList.add('btn-hero-outline');
                        enhancedBtn.classList.add('ai-ready');
                        enhancedBtn.title = 'Click for detailed card analysis';

                        showAlert('Card detected and analyzed!', 'success');
                        analyzeBtn.disabled = false;
                        analyzeBtn.innerHTML = originalText;
                        hideLoading();
                        return; // Exit early - card analysis complete
                    }
                    // If not a card, fall through to general analysis below
                    console.log('[AI] Not a card, proceeding to general analysis');
                } catch (cardError) {
                    console.warn('[AI] Card analysis failed or timed out, proceeding to general analysis:', cardError);
                    // Continue to general analysis even if card analysis fails
                }
            }
            
            // Not a card or card analysis didn't work, do regular item analysis
            // Create new abort controller for general analysis
            const generalController = new AbortController();
            const generalTimeout = setTimeout(() => generalController.abort(), 90000); // 90 second timeout for general analysis
            
            // SYSTEM CONTRACT: Stage 1 requires text input with at least 3 distinct key details
            // Collect text details from form fields
            const textDetails = {
                title: document.getElementById('title')?.value?.trim() || '',
                description: document.getElementById('description')?.value?.trim() || '',
                brand: document.getElementById('brand')?.value?.trim() || '',
                category: document.getElementById('category')?.value?.trim() || '',
                size: document.getElementById('size')?.value?.trim() || '',
                color: document.getElementById('color')?.value?.trim() || ''
            };
            
            console.log('[AI] Starting general analysis with photos and text details:', { photos: uploadedPhotos, textDetails });
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    photos: uploadedPhotos,
                    ...textDetails  // Include text details per system contract
                }),
                signal: generalController.signal
            });

            clearTimeout(generalTimeout);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('[AI] General analysis HTTP error:', response.status, errorText);
                throw new Error(`Analysis failed: ${response.statusText} - ${errorText}`);
            }

            const jobResponse = await response.json();
            console.log('[AI] General analysis job created:', jobResponse);
            
            // If job_id is returned, poll for results
            if (jobResponse.job_id) {
                console.log('[AI] Starting to poll for job status:', jobResponse.job_id);
                const data = await pollJobStatus('/api/analyze-status/' + jobResponse.job_id, 90);
                
                // Log response for debugging
                console.log('General analysis response:', data);

                if (data.result && data.result.success) {
                    const analysis = data.result.analysis;
                    
                    // SYSTEM CONTRACT: Store Stage 1 analysis results (required for Stage 2 prerequisites)
                    stage1AnalysisData = analysis;

                    // Store enhanced analysis if available (Stage 2 may have run automatically)
                    if (data.result && data.result.collectible_analysis) {
                        enhancedAnalysisData = data.result.collectible_analysis;
                    }

                // Fill form
                if (analysis.suggested_title) document.getElementById('title').value = analysis.suggested_title;
                if (analysis.description) document.getElementById('description').value = analysis.description;
                if (analysis.brand) document.getElementById('brand').value = analysis.brand;
                if (analysis.size) document.getElementById('size').value = analysis.size;
                if (analysis.color) document.getElementById('color').value = analysis.color;
                if (analysis.suggested_price) document.getElementById('price').value = analysis.suggested_price;
                if (analysis.condition) {
                    const condition = analysis.condition.replace(' ', '_').toLowerCase();
                    document.getElementById('condition').value = condition;
                }

                // Check for collectible items
                if (analysis.collectible) {
                    const confidence = analysis.collectible_confidence || 0;
                    const indicators = analysis.collectible_indicators || [];
                    const franchise = analysis.franchise || '';

                    let collectibleMsg = ` <strong>COLLECTIBLE DETECTED!</strong><br>`;
                    collectibleMsg += `Confidence: ${(confidence * 100).toFixed(0)}%<br>`;

                    if (franchise) {
                        collectibleMsg += `Franchise: ${franchise}<br>`;
                    }

                    if (indicators.length > 0) {
                        collectibleMsg += `Indicators: ${indicators.join(', ')}`;
                    }

                    // Create custom alert div
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
                    alertDiv.style.cssText = 'position: sticky; top: 10px; z-index: 1000; border: 3px solid #ff6b6b;';
                    alertDiv.innerHTML = `
                        ${collectibleMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    // Insert after form
                    document.getElementById('listingForm').insertAdjacentElement('beforebegin', alertDiv);

                    // Auto-set item type to collectible
                    document.getElementById('item_type').value = 'collectible';

                    // Enable enhanced analyzer button (collectible detected)
                    const enhancedBtn = document.getElementById('enhancedAnalyzerBtn');
                    enhancedBtn.disabled = false;
                    enhancedBtn.classList.remove('btn-outline-warning');
                    enhancedBtn.classList.add('btn-hero-outline');
                    enhancedBtn.classList.add('ai-ready');
                    enhancedBtn.title = 'Click for detailed collectible analysis';
                }
                // Don't enable enhanced analyzer if no collectible detected

                // Show market analysis (sell-through rate)
                if (analysis.market_analysis) {
                    const market = analysis.market_analysis;
                    let demandColor = market.demand_level === 'High' ? 'success' :
                                     market.demand_level === 'Low' ? 'danger' : 'warning';

                    let marketMsg = ` <strong>MARKET ANALYSIS</strong><br>`;
                    marketMsg += `<strong>Sell-Through Rate:</strong> ${market.sell_through_rate}% ${getDemandEmoji(market.demand_level)}<br>`;
                    marketMsg += `<strong>Demand:</strong> <span class="badge bg-${demandColor}">${market.demand_level}</span><br>`;
                    marketMsg += `<strong>Est. Days to Sell:</strong> ${market.days_to_sell_estimate} days<br>`;
                    if (market.average_sold_price > 0) {
                        marketMsg += `<strong>Avg Sold Price:</strong> $${market.average_sold_price.toFixed(2)}<br>`;
                    }
                    if (market.market_insights && market.market_insights.length > 0) {
                        marketMsg += `<small class="text-muted">${market.market_insights.join('  ')}</small>`;
                    }

                    const marketAlert = document.createElement('div');
                    marketAlert.className = 'alert alert-info alert-dismissible fade show mt-3';
                    marketAlert.innerHTML = `
                        ${marketMsg}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;

                    document.getElementById('listingForm').insertAdjacentElement('beforebegin', marketAlert);
                }

                    showAlert('AI analysis complete!', 'success');
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = originalText;
                    hideLoading();
                } else {
                    // Show detailed error message
                    const errorMsg = (data.result && data.result.error) || data.error || 'Unknown error occurred';
                    const errorDetails = (data.result && data.result.details) ? ' - ' + data.result.details : '';
                    console.error('Analysis error:', errorMsg, errorDetails);
                    
                    // Check for API key errors and provide helpful message
                    if (errorMsg.includes('API_KEY') || errorMsg.includes('GEMINI') || errorMsg.includes('not configured')) {
                        showAlert('AI service is not configured. Please set GEMINI_API_KEY environment variable. See AI_SETUP.md for instructions.', 'danger');
                    } else {
                        showAlert('AI analysis error: ' + errorMsg + errorDetails, 'danger');
                    }
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = originalText;
                    hideLoading();
                }
            } else {
                // Legacy response format (shouldn't happen with new API)
                const data = jobResponse;
                if (data.success) {
                    const analysis = data.analysis;
                    // ... handle legacy format
                }
            }
        }
    } catch (error) {
        console.error('[AI] Analysis error caught:', error);
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = originalText;
        hideLoading();
        
        if (error.name === 'AbortError') {
            showAlert('Analysis timed out. Please try again with fewer photos or check your connection.', 'warning');
        } else {
            console.error('Analysis error:', error);
            const errorMsg = error.message || error.toString();
            // Don't show error if it's just "Job timed out" from polling - that's handled above
            if (!errorMsg.includes('Job timed out')) {
                showAlert('Analysis failed: ' + errorMsg, 'danger');
            }
        }
    }
});
    } catch (e) {
        // Silently fail if called on wrong page or if button doesn't exist
        console.log('[CREATE] initializeAnalyzeButton: Not available on this page');
    }
}

// Initialize when DOM is ready (only on create page where analyzeBtn exists)
// Wrap in try-catch to prevent errors on other pages
try {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeAnalyzeButton);
    } else {
        initializeAnalyzeButton();
    }
} catch (e) {
    // Silently fail - this script only runs on create.html anyway
}

function getDemandEmoji(demand) {
    if (demand === 'High') return '';
    if (demand === 'Low') return '';
    return '';
}

// Poll job status until complete or failed
async function pollJobStatus(statusUrl, maxSeconds = 60) {
    const startTime = Date.now();
    const maxTime = maxSeconds * 1000;
    const pollInterval = 2000; // Poll every 2 seconds
    
    console.log('[AI] Starting to poll job status:', statusUrl, 'maxSeconds:', maxSeconds);
    
    while (Date.now() - startTime < maxTime) {
        try {
            const response = await fetch(statusUrl);
            if (!response.ok) {
                // If 404, job might not exist yet - wait and retry
                if (response.status === 404) {
                    console.log('[AI] Job not found yet (404), waiting...');
                    await new Promise(resolve => setTimeout(resolve, pollInterval));
                    continue;
                }
                throw new Error(`Status check failed: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('[AI] Poll response:', data.status, data);
            
            if (data.status === 'completed') {
                console.log('[AI] Job completed successfully');
                return data;
            } else if (data.status === 'failed') {
                console.error('[AI] Job failed:', data.error);
                throw new Error(data.error || 'Job failed');
            } else if (data.status === 'processing' || data.status === 'pending') {
                // Still processing, wait and poll again
                console.log('[AI] Job still processing, waiting...');
                await new Promise(resolve => setTimeout(resolve, pollInterval));
                continue;
            } else {
                // Unknown status, wait and retry
                console.log('[AI] Unknown status:', data.status, 'waiting...');
                await new Promise(resolve => setTimeout(resolve, pollInterval));
                continue;
            }
        } catch (error) {
            if (error.message.includes('Job failed') || error.message.includes('failed')) {
                throw error;
            }
            // Network error or other transient error, retry
            console.warn('[AI] Poll error (will retry):', error.message);
            await new Promise(resolve => setTimeout(resolve, pollInterval));
        }
    }
    
    throw new Error('Job timed out after ' + maxSeconds + ' seconds');
}

// ========================================
// ENHANCED ANALYZER FOR COLLECTIBLES
// ========================================

document.getElementById('enhancedAnalyzerBtn').addEventListener('click', async function() {
    const enhancedBtn = document.getElementById('enhancedAnalyzerBtn');
    const originalText = enhancedBtn.innerHTML;
    
    // SYSTEM CONTRACT: Stage 2 Prerequisites Check
    // 1. Regular AI Scanner (Stage 1) has run
    // 2. Regular AI Scanner marked item as collectible
    if (!stage1AnalysisData) {
        showAlert('Please run Stage 1 Regular AI Scanner first before using Enhanced Analyzer.', 'warning');
        return;
    }
    
    if (stage1AnalysisData.collectible !== true) {
        showAlert('Enhanced Analyzer can only run on items marked as collectible by Stage 1. This item was not marked as collectible.', 'warning');
        return;
    }
    
    // If we don't have enhanced data yet, try to get it
    if (!enhancedAnalysisData) {
        enhancedBtn.disabled = true;
        enhancedBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running Deep Analysis...';
        showLoading();
        showAlert('Running enhanced analysis... This may take 10-30 seconds', 'info');

        // Create abort controller for timeout
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 90000); // 90 second timeout for deep analysis

        try {
            // SYSTEM CONTRACT: Stage 2 Enhanced Analyzer inputs are Images only (not text)
            // Stage 1 has already run and verified collectible status
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    photos: uploadedPhotos,  // Images only per Stage 2 contract
                    // No text details - Stage 2 only takes images
                    force_enhanced: true,  // Request Stage 2 Enhanced Analyzer
                    stage1_already_run: true  // SYSTEM CONTRACT: Stage 1 has run and marked as collectible (verified above)
                }),
                signal: controller.signal
            });

            clearTimeout(timeout);

            if (!response.ok) {
                throw new Error(`Enhanced analysis failed: ${response.statusText}`);
            }

            const jobResponse = await response.json();
            
            // If job_id is returned, poll for results
            if (jobResponse.job_id) {
                const data = await pollJobStatus('/api/analyze-status/' + jobResponse.job_id, 120);
                
                if (data.result && data.result.success) {
                    if (data.result.collectible_analysis && !data.result.collectible_analysis.error) {
                        enhancedAnalysisData = data.result.collectible_analysis;
                        showAlert('Enhanced analysis complete!', 'success');
                    } else if (data.result.collectible_analysis && data.result.collectible_analysis.error) {
                        showAlert('Enhanced analysis failed: ' + data.result.collectible_analysis.error, 'danger');
                        return;
                    } else {
                        showAlert('Enhanced analysis not available for this item. This feature works best with collectibles, trading cards, and sports memorabilia.', 'warning');
                        return;
                    }
                } else if (data.error || (data.result && data.result.error)) {
                    const errorMsg = data.error || (data.result && data.result.error) || 'Unknown error';
                    // Check for API key errors
                    if (errorMsg.includes('API_KEY') || errorMsg.includes('ANTHROPIC') || errorMsg.includes('CLAUDE') || errorMsg.includes('not configured')) {
                        showAlert('Enhanced Analyzer requires Claude API key. Please set ANTHROPIC_API_KEY environment variable. See AI_SETUP.md for instructions.', 'danger');
                    } else {
                        showAlert('Enhanced analysis failed: ' + errorMsg, 'danger');
                    }
                    return;
                } else {
                    showAlert('Enhanced analysis not available for this item. This feature works best with collectibles, trading cards, and sports memorabilia.', 'warning');
                    return;
                }
            } else {
                // Legacy format
                const data = jobResponse;
                if (data.success) {
                    if (data.collectible_analysis && !data.collectible_analysis.error) {
                        enhancedAnalysisData = data.collectible_analysis;
                        showAlert('Enhanced analysis complete!', 'success');
                    } else {
                        showAlert('Enhanced analysis not available for this item.', 'warning');
                        return;
                    }
                } else if (data.error) {
                    const errorMsg = data.error || 'Unknown error';
                    // Check for API key errors
                    if (errorMsg.includes('API_KEY') || errorMsg.includes('ANTHROPIC') || errorMsg.includes('CLAUDE') || errorMsg.includes('not configured')) {
                        showAlert('Enhanced Analyzer requires Claude API key. Please set ANTHROPIC_API_KEY environment variable. See AI_SETUP.md for instructions.', 'danger');
                    } else {
                        showAlert('Enhanced analysis failed: ' + errorMsg, 'danger');
                    }
                    enhancedBtn.disabled = false;
                    enhancedBtn.innerHTML = originalText;
                    hideLoading();
                    return;
                } else {
                    showAlert('Enhanced analysis not available for this item. This feature works best with collectibles, trading cards, and sports memorabilia.', 'warning');
                    enhancedBtn.disabled = false;
                    enhancedBtn.innerHTML = originalText;
                    hideLoading();
                    return;
                }
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                showAlert('Enhanced analysis timed out. Please try again or use the basic analysis.', 'warning');
            } else {
                console.error('Enhanced analysis error:', error);
                showAlert('Enhanced analysis failed: ' + (error.message || error), 'danger');
            }
            enhancedBtn.disabled = false;
            enhancedBtn.innerHTML = originalText;
            hideLoading();
            return;
        }
    }

    // Build detailed analysis HTML
    let html = '<div class="enhanced-analysis-details">';

    // Authentication
    if (enhancedAnalysisData.authentication) {
        const auth = enhancedAnalysisData.authentication;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;"><i class="fas fa-certificate"></i> Authentication</div>
            <div class="card-body">
                <p><strong>Authentic:</strong> ${auth.is_authentic ? ' Yes' : ' Questionable'}</p>
                <p><strong>Confidence:</strong> ${auth.confidence_level || 'N/A'}</p>
                ${auth.red_flags ? `<p class="text-danger"><strong>Red Flags:</strong> ${auth.red_flags}</p>` : ''}
            </div>
        </div>`;
    }

    // Grading
    if (enhancedAnalysisData.grading) {
        const grade = enhancedAnalysisData.grading;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;"><i class="fas fa-award"></i> Grading</div>
            <div class="card-body">
                ${grade.overall_grade ? `<p><strong>Grade:</strong> ${grade.overall_grade}</p>` : ''}
                ${grade.centering ? `<p><strong>Centering:</strong> ${grade.centering}</p>` : ''}
                ${grade.corners ? `<p><strong>Corners:</strong> ${grade.corners}</p>` : ''}
                ${grade.edges ? `<p><strong>Edges:</strong> ${grade.edges}</p>` : ''}
                ${grade.surface ? `<p><strong>Surface:</strong> ${grade.surface}</p>` : ''}
            </div>
        </div>`;
    }

    // Rarity
    if (enhancedAnalysisData.rarity) {
        const rarity = enhancedAnalysisData.rarity;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;"><i class="fas fa-star"></i> Rarity</div>
            <div class="card-body">
                ${rarity.rarity_level ? `<p><strong>Rarity:</strong> ${rarity.rarity_level}</p>` : ''}
                ${rarity.print_run ? `<p><strong>Print Run:</strong> ${rarity.print_run}</p>` : ''}
                ${rarity.variants ? `<p><strong>Variants:</strong> ${rarity.variants}</p>` : ''}
            </div>
        </div>`;
    }

    // Market Analysis
    if (enhancedAnalysisData.market_analysis) {
        const market = enhancedAnalysisData.market_analysis;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;"><i class="fas fa-chart-line"></i> Market Analysis</div>
            <div class="card-body">
                ${market.price_range ? `<p><strong>Price Range:</strong> ${market.price_range}</p>` : ''}
                ${market.recent_sales ? `<p><strong>Recent Sales:</strong> ${market.recent_sales}</p>` : ''}
                ${market.market_trend ? `<p><strong>Trend:</strong> ${market.market_trend}</p>` : ''}
                ${market.demand_level ? `<p><strong>Demand:</strong> ${market.demand_level}</p>` : ''}
            </div>
        </div>`;
    }

    // Recommendations
    if (enhancedAnalysisData.recommendations) {
        const rec = enhancedAnalysisData.recommendations;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--charcoal-light) 0%, var(--charcoal) 100%); color: var(--off-white-text);"><i class="fas fa-lightbulb"></i> Recommendations</div>
            <div class="card-body">
                ${rec.suggested_price ? `<p><strong>Suggested Price:</strong> ${rec.suggested_price}</p>` : ''}
                ${rec.best_platforms ? `<p><strong>Best Platforms:</strong> ${rec.best_platforms}</p>` : ''}
                ${rec.target_buyers ? `<p><strong>Target Buyers:</strong> ${rec.target_buyers}</p>` : ''}
                ${rec.selling_tips ? `<p><strong>Tips:</strong> ${rec.selling_tips}</p>` : ''}
            </div>
        </div>`;
    }

    // Fraud Check
    if (enhancedAnalysisData.fraud_check) {
        const fraud = enhancedAnalysisData.fraud_check;
        html += `<div class="card mb-3">
            <div class="card-header" style="background: linear-gradient(180deg, var(--red-primary) 0%, var(--red-primary-dark) 100%); color: white;"><i class="fas fa-shield-alt"></i> Fraud Check</div>
            <div class="card-body">
                ${fraud.authentication_concerns ? `<p><strong>Concerns:</strong> ${fraud.authentication_concerns}</p>` : ''}
                ${fraud.grading_recommended ? `<p><strong>Grading Recommended:</strong> ${fraud.grading_recommended ? 'Yes' : 'No'}</p>` : ''}
            </div>
        </div>`;
    }

    html += '</div>';

    // Create modal
    const modalHtml = `
        <div class="modal fade" id="enhancedAnalysisModal" tabindex="-1">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(180deg, var(--steel-blue-grey) 0%, var(--steel-blue-grey-dark) 100%); color: white;">
                        <h5 class="modal-title"><i class="fas fa-gem"></i> Enhanced Collectible Analysis</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('enhancedAnalysisModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('enhancedAnalysisModal'));
    modal.show();
});

// ========================================
// CARD COLLECTION FUNCTIONS
// ========================================

function showCardDetectionBanner(cardData) {
    // Remove any existing banner
    const existingBanner = document.getElementById('cardDetectionBanner');
    if (existingBanner) {
        existingBanner.remove();
    }

    // Build card info display
    let cardType = cardData.card_type || 'unknown';
    let cardName = cardData.card_name || cardData.player_name || 'Unknown Card';
    let cardDetails = [];

    // Add type-specific details
    if (cardData.player_name) {
        // Sports card
        if (cardData.year) cardDetails.push(`${cardData.year}`);
        if (cardData.brand) cardDetails.push(cardData.brand);
        if (cardData.is_rookie_card) cardDetails.push('RC');
    } else {
        // TCG card
        if (cardData.set_name) cardDetails.push(cardData.set_name);
        if (cardData.card_number) cardDetails.push(`#${cardData.card_number}`);
        if (cardData.rarity) cardDetails.push(cardData.rarity);
    }

    // Grading info
    if (cardData.is_graded && cardData.grading_company) {
        cardDetails.push(`${cardData.grading_company} ${cardData.grading_score || ''}`);
    }

    // Value estimate
    let valueText = '';
    if (cardData.estimated_value_low || cardData.estimated_value_high) {
        const low = cardData.estimated_value_low || 0;
        const high = cardData.estimated_value_high || 0;
        if (low > 0 && high > 0) {
            valueText = `<strong>Est. Value:</strong> $${low} - $${high}`;
        } else if (low > 0) {
            valueText = `<strong>Est. Value:</strong> $${low}+`;
        }
    }

    const cardInfo = cardDetails.join('  ');
    const confidence = cardData.confidence ? `${(cardData.confidence * 100).toFixed(0)}%` : 'N/A';

    const banner = document.createElement('div');
    banner.id = 'cardDetectionBanner';
    banner.className = 'alert alert-success alert-dismissible fade show mt-3';
    banner.style.cssText = 'position: sticky; top: 10px; z-index: 1000; border: 3px solid #28a745; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);';
    banner.innerHTML = `
        <div>
            <h5 class="alert-heading mb-3">
                <i class="fas fa-id-card"></i> <strong>TRADING CARD DETECTED!</strong>
            </h5>
            <div class="row">
                <div class="col-md-7">
                    <p class="mb-2">
                        <strong>${cardName}</strong><br>
                        <small class="text-muted">${cardInfo}</small>
                    </p>
                    ${valueText ? `<p class="mb-2">${valueText}</p>` : ''}
                    <small class="text-muted">Confidence: ${confidence}</small>
                </div>
                <div class="col-md-5">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-primary btn-lg pulse-glow" onclick="storeCardOnly()">
                            <i class="fas fa-box"></i> Store Only
                        </button>
                        <button type="button" class="btn btn-hero-outline" onclick="storeAndList()">
                            <i class="fas fa-plus-circle"></i> Store + Create Listing
                        </button>
                        <small class="text-muted text-center">
                            Or just create a listing below without storing
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.getElementById('listingForm').insertAdjacentElement('beforebegin', banner);
}

function fillFormFromCardData(cardData) {
    // Build title
    let title = '';
    if (cardData.player_name) {
        // Sports card
        title = cardData.player_name;
        if (cardData.year) title = `${cardData.year} ${title}`;
        if (cardData.brand) title = `${title} ${cardData.brand}`;
        if (cardData.series) title = `${title} ${cardData.series}`;
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
        if (cardData.is_rookie_card) title = `${title} RC`;
    } else {
        // TCG card
        title = cardData.card_name || 'Unknown Card';
        if (cardData.card_number) title = `${title} #${cardData.card_number}`;
    }

    document.getElementById('title').value = title;

    // Build description
    let description = '';
    if (cardData.set_name) {
        description += `Set: ${cardData.set_name}\n`;
    }
    if (cardData.rarity) {
        description += `Rarity: ${cardData.rarity}\n`;
    }
    if (cardData.is_graded && cardData.grading_company) {
        description += `Graded: ${cardData.grading_company} ${cardData.grading_score || ''}\n`;
    }
    if (cardData.parallel) {
        description += `Parallel: ${cardData.parallel}\n`;
    }

    document.getElementById('description').value = description;

    // Set brand
    if (cardData.brand) {
        document.getElementById('brand').value = cardData.brand;
    }

    // Set price from estimated value
    if (cardData.estimated_value_low && cardData.estimated_value_high) {
        const avgValue = (cardData.estimated_value_low + cardData.estimated_value_high) / 2;
        document.getElementById('price').value = avgValue.toFixed(2);
    } else if (cardData.estimated_value_low) {
        document.getElementById('price').value = cardData.estimated_value_low.toFixed(2);
    }

    // Set item type to trading card
    document.getElementById('item_type').value = 'trading_card';

    // Set condition based on grading
    if (cardData.is_graded && cardData.grading_score) {
        if (cardData.grading_score >= 9) {
            document.getElementById('condition').value = 'excellent';
        } else if (cardData.grading_score >= 7) {
            document.getElementById('condition').value = 'good';
        } else {
            document.getElementById('condition').value = 'fair';
        }
    }
}

async function storeCardOnly() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card stored in your collection! Redirecting...', 'success');
            // Redirect to cards collection page after 1 second
            setTimeout(() => window.location.href = '/cards', 1000);
        } else {
            showAlert(data.error || 'Failed to add card to collection', 'danger');
            hideLoading();
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
        hideLoading();
    }
}

async function storeAndList() {
    if (!detectedCardData) {
        showAlert('No card data available', 'danger');
        return;
    }

    showLoading();

    try {
        const response = await fetch('/api/cards/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                ai_result: detectedCardData,
                photos: uploadedPhotos,
                storage_location: document.getElementById('storage_location').value || null
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Card added to collection! You can now create a listing below.', 'success');

            // Update the banner to show it's been stored
            const banner = document.getElementById('cardDetectionBanner');
            if (banner) {
                banner.classList.remove('alert-success');
                banner.classList.add('alert-info');
                banner.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="alert-heading mb-0">
                                <i class="fas fa-check-circle"></i> <strong>Card Stored!</strong>
                            </h5>
                            <small class="text-muted">Continue filling out the form below to create a listing.</small>
                        </div>
                        <a href="/cards" class="btn btn-hero-outline">
                            <i class="fas fa-box-open"></i> View Collection
                        </a>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            }
        } else {
            showAlert(data.error || 'Failed to add card to collection', 'danger');
        }
    } catch (error) {
        showAlert('Failed to add card: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Save Listing (common function)
async function saveListing(status = 'draft') {
    if (uploadedPhotos.length === 0) {
        showAlert('Please upload photos first!', 'warning');
        return;
    }

    const formData = collectFormData();
    // include uploaded server photo paths
    formData.photos = uploadedPhotos;
    formData.status = status;
    if (!currentListingId && currentSessionId) {
        formData.session_id = currentSessionId;
    }
    // Include AI analysis data if available
    if (enhancedAnalysisData) {
        formData.enhanced_analysis = enhancedAnalysisData;
    }
    showLoading();

    try {
        const response = await fetch('/api/save-draft', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        });

        // Handle authentication errors
        if (response.status === 401 || response.status === 403) {
            hideLoading();
            showAlert('You must be logged in to save listings. Redirecting to login...', 'warning');
            setTimeout(() => window.location.href = '/login', 2000);
            return;
        }

        const data = await response.json();

        if (data.success) {
            const msg = status === 'active' ? 'Listing posted successfully!' : 'Listing saved as draft!';
            const redirect = status === 'active' ? '/listings' : '/drafts';
            showAlert(msg, 'success');
            setTimeout(() => window.location.href = redirect, 1500);
        } else {
            showAlert(data.error || 'Failed to save listing', 'danger');
        }
    } catch (error) {
        showAlert('Save failed: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Save as Draft button
document.getElementById('saveDraftBtn').addEventListener('click', async function() {
    // If a card was detected, ask if user wants to store it
    if (detectedCardData && detectedCardData.is_card) {
        const shouldStore = confirm('A trading card was detected. Would you like to store this card in your collection when saving as draft?');
        if (shouldStore) {
            // Store the card first
            try {
                showLoading();
                const storeResponse = await fetch('/api/cards/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        ai_result: detectedCardData,
                        photos: uploadedPhotos,
                        storage_location: document.getElementById('storage_location').value || null
                    })
                });
                const storeData = await storeResponse.json();
                if (storeData.success) {
                    showAlert('Card stored in collection!', 'success');
                } else {
                    showAlert('Card storage failed: ' + (storeData.error || 'Unknown error'), 'warning');
                }
            } catch (error) {
                showAlert('Failed to store card: ' + error, 'warning');
            } finally {
                hideLoading();
            }
        }
    }
    await saveListing('draft');
});

// Discard Listing button
document.getElementById('discardListingBtn').addEventListener('click', async function() {
    if (!currentListingId) {
        showAlert('No listing to discard. Please refresh the page.', 'warning');
        return;
    }

    if (!confirm('Discard this listing and all its images? This cannot be undone.')) {
        return;
    }

    showLoading();

    try {
        const response = await fetch(`/api/delete-draft/${currentListingId}`, {
            method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Listing discarded.', 'success');
            // After discard, start fresh with a brand new listing
            setTimeout(() => window.location.href = '/create', 1000);
        } else {
            showAlert(data.error || 'Failed to discard listing', 'danger');
        }
    } catch (error) {
        showAlert('Error discarding listing: ' + error, 'danger');
    } finally {
        hideLoading();
    }
});

// Post Now button
document.getElementById('postNowBtn').addEventListener('click', async function() {
    await saveListing('active');
});

function collectFormData() {
    const data = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        item_type: document.getElementById('item_type').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        storage_location: document.getElementById('storage_location').value,
        quantity: document.getElementById('quantity').value,
        sku: document.getElementById('sku').value,
        upc: document.getElementById('upc').value
    };

    if (currentListingId) {
        data.listing_id = currentListingId;
        data.draft_id = currentListingId;  // For backwards compatibility
    }
    if (currentListingUuid) {
        data.listing_uuid = currentListingUuid;
    }

    return data;
}

// IMAGE_CONTRACT Step 3: "UI reflects database truth"
// Refresh photo previews from DB-backed uploadedPhotos array
function refreshPhotoPreviews() {
    const previewDiv = document.getElementById('photoPreview');
    previewDiv.innerHTML = '';
    
    if (!uploadedPhotos || uploadedPhotos.length === 0) {
        return;
    }
    
    uploadedPhotos.forEach((photoUrl, index) => {
        // Create container for photo + remove button
        const container = document.createElement('div');
        container.className = 'photo-preview-container';
        container.style.position = 'relative';
        container.style.display = 'inline-block';
        container.style.margin = '5px';
        
        const img = document.createElement('img');
        img.src = photoUrl;  // Use URL from Supabase Storage
        img.className = 'photo-preview';
        img.title = 'Click to edit photo';
        img.style.cursor = 'pointer';
        img.onerror = function() {
            console.error('[PREVIEW] Failed to load image:', photoUrl);
            this.style.display = 'none';
        };
        
        // Make photo clickable to open editor
        img.onclick = function() {
            openPhotoEditor(index, photoUrl);
        };
        
        // Create remove button (X)
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '';
        removeBtn.className = 'btn btn-sm';
        removeBtn.style.cssText = 'position: absolute; top: 5px; right: 5px; background: rgba(220, 38, 38, 0.9); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 20px; line-height: 1; cursor: pointer; z-index: 10; display: flex; align-items: center; justify-content: center; padding: 0;';
        removeBtn.title = 'Remove photo';
        removeBtn.onclick = function(e) {
            e.stopPropagation(); // Prevent triggering photo editor
            removePhoto(index);
        };
        
        container.appendChild(img);
        container.appendChild(removeBtn);
        previewDiv.appendChild(container);
    });
    
    // Update analyze button state based on photos
    updateAnalyzeButtonState();
}

// Remove photo from array and optionally delete from storage
async function removePhoto(index) {
    if (index < 0 || index >= uploadedPhotos.length) {
        console.error('[REMOVE] Invalid photo index:', index);
        return;
    }
    
    const photoUrl = uploadedPhotos[index];
    console.log('[REMOVE] Removing photo at index', index, ':', photoUrl);
    
    // Remove from array
    uploadedPhotos.splice(index, 1);
    
    // Update UI immediately
    refreshPhotoPreviews();
    updateAnalyzeButtonState();
    
    // If this is a committed listing, update the database
    if (currentListingId) {
        try {
            console.log('[REMOVE] Updating listing in database...');
            const response = await fetch(`/api/update-listing-photos/${currentListingId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'include',
                body: JSON.stringify({
                    photos: uploadedPhotos  // Send updated array without the removed photo
                })
            });
            
            if (!response.ok) {
                console.error('[REMOVE] Failed to update listing:', response.statusText);
                showAlert('Photo removed from preview, but failed to update database. Please refresh the page.', 'warning');
            } else {
                console.log('[REMOVE]  Listing updated in database');
                showAlert('Photo removed successfully', 'success');
            }
        } catch (error) {
            console.error('[REMOVE] Error updating listing:', error);
            showAlert('Photo removed from preview, but failed to update database. Please refresh the page.', 'warning');
        }
    } else {
        // Temp session - just removed from array, no DB update needed
        console.log('[REMOVE]  Photo removed from temp session');
        showAlert('Photo removed', 'success');
    }
}

// Load draft data for editing
async function loadDraftData() {
    if (!editingDraftId) return;

    showLoading();

    try {
        const response = await fetch(`/api/get-draft/${editingDraftId}`);

        // Check if response is OK before parsing JSON
        if (!response.ok) {
            hideLoading();
            showAlert(`Failed to load draft: Server returned ${response.status}`, 'danger');
            return;
        }

        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            hideLoading();
            showAlert('Failed to load draft: Invalid response format', 'danger');
            return;
        }

        const data = await response.json();

        if (data.success) {
            const listing = data.listing;
            editingListingUuid = listing.listing_uuid;

            // Populate form fields
            document.getElementById('title').value = listing.title || '';
            document.getElementById('description').value = listing.description || '';
            document.getElementById('price').value = listing.price || '';
            document.getElementById('cost').value = listing.cost || '';
            document.getElementById('condition').value = listing.condition || 'good';
            document.getElementById('item_type').value = listing.item_type || 'general';
            document.getElementById('brand').value = listing.brand || '';
            document.getElementById('size').value = listing.size || '';
            document.getElementById('color').value = listing.color || '';
            document.getElementById('shipping_cost').value = listing.shipping_cost || 0;
            document.getElementById('storage_location').value = listing.storage_location || '';
            document.getElementById('quantity').value = listing.quantity || 1;
            document.getElementById('sku').value = listing.sku || '';
            document.getElementById('upc').value = listing.upc || '';

            // IMAGE_CONTRACT: Load photos from database (source of truth)
            if (listing.photos) {
                try {
                    const photos = typeof listing.photos === 'string' ? JSON.parse(listing.photos) : listing.photos;
                    uploadedPhotos = Array.isArray(photos) ? photos : [];
                    refreshPhotoPreviews();  // Render from DB
                } catch (e) {
                    console.error('[LOAD] Failed to parse photos:', e);
                    uploadedPhotos = [];
                }
            } else {
                uploadedPhotos = [];
            }
            
            // Update listing IDs if not already set
            if (!currentListingId && listing.id) {
                currentListingId = listing.id;
            }
            if (!currentListingUuid && listing.listing_uuid) {
                currentListingUuid = listing.listing_uuid;
            }
            
            // Photos already loaded above via IMAGE_CONTRACT code
            // refreshPhotoPreviews() was already called
            if (uploadedPhotos.length > 0) {
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.disabled = false;
                analyzeBtn.title = 'Click to analyze photos with AI';
                analyzeBtn.classList.add('ai-ready');
            }

            showAlert('Draft loaded for editing', 'info');
        } else {
            showAlert(data.error || 'Failed to load draft', 'danger');
        }
    } catch (error) {
        showAlert('Failed to load draft: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Load photos for new listing (if any were uploaded before page refresh)
async function loadListingPhotos() {
    if (!currentListingId) return;
    
    try {
        const response = await fetch(`/api/get-draft/${currentListingId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.listing && data.listing.photos) {
                try {
                    const photos = typeof data.listing.photos === 'string' 
                        ? JSON.parse(data.listing.photos) 
                        : data.listing.photos;
                    uploadedPhotos = Array.isArray(photos) ? photos : [];
                    refreshPhotoPreviews();
                } catch (e) {
                    console.error('[LOAD] Failed to parse photos:', e);
                }
            }
        }
    } catch (error) {
        console.error('[LOAD] Failed to load listing photos:', error);
    }
}

// Initialize button state on page load
document.addEventListener('DOMContentLoaded', function() {
    // Initialize button state (only if analyzeBtn exists - safe for all pages)
    try {
        updateAnalyzeButtonState();
    } catch (e) {
        // Button doesn't exist on this page (e.g., login page) - that's fine
        console.log('[CREATE] Analyze button not found on this page (expected for non-create pages)');
    }
    
    // Only load draft data if we're on the create page
    if (editingDraftId) {
        loadDraftData();
    } else if (currentListingId) {
        // New listing was created - load any existing photos from DB
        loadListingPhotos();
    }
});

// Generate random SKU
function generateSKU() {
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    const sku = `SKU-${timestamp}-${random}`;
    document.getElementById('sku').value = sku;
}

// ============================================================================
// AUTO-SAVE FUNCTIONALITY
// ============================================================================

const AUTOSAVE_KEY = 'draft_autosave';
const AUTOSAVE_INTERVAL = 5000; // Save every 5 seconds
let autoSaveTimer = null;
let hasUnsavedChanges = false;

// Create auto-save indicator
const autoSaveIndicator = document.createElement('div');
autoSaveIndicator.id = 'autoSaveIndicator';
autoSaveIndicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: rgba(40, 167, 69, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    z-index: 9999;
    display: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
`;
autoSaveIndicator.innerHTML = '<i class="fas fa-check-circle"></i> Auto-saved';
document.body.appendChild(autoSaveIndicator);

function showAutoSaveIndicator(text = 'Auto-saved', color = 'rgba(40, 167, 69, 0.9)') {
    autoSaveIndicator.style.background = color;
    autoSaveIndicator.innerHTML = `<i class="fas fa-check-circle"></i> ${text}`;
    autoSaveIndicator.style.display = 'block';
    setTimeout(() => {
        autoSaveIndicator.style.display = 'none';
    }, 2000);
}

function autoSaveToLocalStorage() {
    // Don't auto-save if we're editing an existing draft (use manual save instead)
    if (editingDraftId) return;

    const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        price: document.getElementById('price').value,
        cost: document.getElementById('cost').value,
        condition: document.getElementById('condition').value,
        item_type: document.getElementById('item_type').value,
        brand: document.getElementById('brand').value,
        size: document.getElementById('size').value,
        color: document.getElementById('color').value,
        shipping_cost: document.getElementById('shipping_cost').value,
        storage_location: document.getElementById('storage_location').value,
        quantity: document.getElementById('quantity').value,
        sku: document.getElementById('sku').value,
        upc: document.getElementById('upc').value,
        timestamp: new Date().toISOString()
    };

    // Only save if there's some content
    if (formData.title || formData.description || formData.price) {
        try {
            localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(formData));
            showAutoSaveIndicator('Auto-saved');
            hasUnsavedChanges = false;
        } catch (e) {
            console.error('Auto-save failed:', e);
        }
    }
}

function loadFromLocalStorage() {
    // Don't load from localStorage if we're editing an existing draft
    if (editingDraftId) return;

    try {
        const saved = localStorage.getItem(AUTOSAVE_KEY);
        if (saved) {
            const formData = JSON.parse(saved);

            // Ask user if they want to restore
            const savedDate = new Date(formData.timestamp);
            const message = `Found auto-saved draft from ${savedDate.toLocaleString()}. Would you like to restore it?`;

            if (confirm(message)) {
                // Restore form data
                document.getElementById('title').value = formData.title || '';
                document.getElementById('description').value = formData.description || '';
                document.getElementById('price').value = formData.price || '';
                document.getElementById('cost').value = formData.cost || '';
                document.getElementById('condition').value = formData.condition || 'excellent';
                document.getElementById('item_type').value = formData.item_type || 'general';
                document.getElementById('brand').value = formData.brand || '';
                document.getElementById('size').value = formData.size || '';
                document.getElementById('color').value = formData.color || '';
                document.getElementById('shipping_cost').value = formData.shipping_cost || '0';
                document.getElementById('storage_location').value = formData.storage_location || '';
                document.getElementById('quantity').value = formData.quantity || '1';
                document.getElementById('sku').value = formData.sku || '';
                document.getElementById('upc').value = formData.upc || '';

                showAutoSaveIndicator('Draft restored', 'rgba(13, 110, 253, 0.9)');
            } else {
                // Clear if user doesn't want to restore
                localStorage.removeItem(AUTOSAVE_KEY);
            }
        }
    } catch (e) {
        console.error('Failed to load auto-save:', e);
    }
}

function clearAutoSave() {
    try {
        localStorage.removeItem(AUTOSAVE_KEY);
    } catch (e) {
        console.error('Failed to clear auto-save:', e);
    }
}

// Schedule auto-save when form changes
function scheduleAutoSave() {
    hasUnsavedChanges = true;
    if (autoSaveTimer) {
        clearTimeout(autoSaveTimer);
    }
    autoSaveTimer = setTimeout(autoSaveToLocalStorage, AUTOSAVE_INTERVAL);
}

// Add change listeners to all form fields
document.addEventListener('DOMContentLoaded', function() {
    // Load any saved draft
    loadFromLocalStorage();

    // Photo upload handlers are attached inline (see script after buttons)

    // Add listeners to form fields
    const formFields = [
        'title', 'description', 'price', 'cost', 'condition', 'item_type',
        'brand', 'size', 'color', 'shipping_cost', 'storage_location',
        'quantity', 'sku', 'upc'
    ];

    formFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', scheduleAutoSave);
            field.addEventListener('change', scheduleAutoSave);
        }
    });

    // Warn user about unsaved changes when leaving page
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges && !editingDraftId) {
            e.preventDefault();
            e.returnValue = '';
            return '';
        }
    });
});

// Clear auto-save after successful save to server
const originalSaveListing = saveListing;
saveListing = async function(status = 'draft') {
    await originalSaveListing(status);
    // Clear auto-save after successful save
    clearAutoSave();
};
</script>
{% endblock %}
