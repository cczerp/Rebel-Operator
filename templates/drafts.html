{% extends "base.html" %}

{% block title %}Drafts{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }
    
    .drafts-table {
        border-collapse: collapse;
        width: 100%;
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    
    .drafts-table th {
        background-color: #2d2d2d;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #3d3d3d;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .drafts-table td {
        padding: 10px 12px;
        border: 1px solid #3d3d3d;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .drafts-table tbody tr:hover {
        background-color: #252525;
    }
    
    .editable-cell {
        cursor: text;
        position: relative;
        background-color: rgba(255, 255, 255, 0.02);
        transition: background-color 0.2s;
        padding: 8px;
        border-radius: 3px;
    }
    
    .editable-cell:hover {
        background-color: rgba(100, 200, 255, 0.1);
    }
    
    .editable-cell.editing input,
    .editable-cell.editing select {
        width: 100%;
        padding: 6px;
        border: 2px solid #64c8ff;
        border-radius: 3px;
        background-color: #2d2d2d;
        color: #e0e0e0;
        font-size: 14px;
    }
    
    .editable-cell.editing input:focus,
    .editable-cell.editing select:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(100, 200, 255, 0.5);
    }
    
    .cell-modified {
        background-color: rgba(255, 193, 7, 0.15) !important;
        border-left: 3px solid #ffc107;
    }
    
    .photo-preview {
        max-width: 50px;
        max-height: 50px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .action-buttons {
        white-space: normal;
        padding: 10px !important;
    }
    
    .action-buttons .btn {
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 12px;
        padding: 5px 10px;
    }
    
    .bulk-actions-bar {
        background-color: #2d2d2d;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
        gap: 10px;
    }
    
    .bulk-actions-bar.active {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .bulk-actions-bar > span {
        color: #aaa;
        font-size: 14px;
    }
    
    .changes-indicator {
        position: fixed;
        bottom: 90px; /* Above bottom nav (was 20px) */
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        z-index: 999; /* Below bottom nav */
    }
    
    .changes-indicator.active {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .changes-indicator button {
        padding: 5px 15px;
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 3px;
        color: white;
        cursor: pointer;
        font-weight: 600;
    }
    
    .changes-indicator button:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }
    
    .draft-row.deleted {
        opacity: 0.5;
        background-color: rgba(255, 0, 0, 0.1);
    }
    
    .condition-select, .edit-input {
        width: 100%;
        padding: 6px;
        border: 1px solid #444;
        border-radius: 3px;
        background-color: #2d2d2d;
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-folder"></i> Draft Listings (Excel-Style Editor)</h2>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-success" onclick="exportSelectedToCSV()" title="Export selected drafts as CSV">
            <i class="fas fa-file-export"></i> Export Selected
        </button>
        <a href="{{ url_for('create_listing') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Listing
        </a>
    </div>
</div>

<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i> <strong>How it works:</strong>
    Click on any cell to edit it directly (like Excel). Your changes are highlighted in yellow. Use Tab to move to the next cell. Save all changes at once using the button below.
</div>

<div class="bulk-actions-bar" id="bulkActionsBar">
    <span id="selectedCount">0 selected</span>
    <button class="btn btn-sm btn-danger" onclick="deleteSelectedDrafts()">
        <i class="fas fa-trash"></i> Delete Selected
    </button>
    <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear Selection</button>
</div>

<div id="draftsContainer">
    <div class="text-center py-5">
        <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
        <p class="text-muted">Loading drafts...</p>
    </div>
</div>

<div style="margin-top: 20px; text-align: right;">
    <button class="btn btn-primary btn-lg" onclick="saveAllChanges()" id="saveBtn" style="display: none;">
        <i class="fas fa-save"></i> Save All Changes
    </button>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Photo Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="photoDisplay" src="" style="max-width: 100%; max-height: 500px;">
            </div>
        </div>
    </div>
</div>

<div class="changes-indicator" id="changesIndicator">
    <span><i class="fas fa-exclamation-circle"></i> You have unsaved changes</span>
    <button onclick="saveAllChanges()">Save Now</button>
    <button onclick="discardChanges()">Discard</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store for tracking changes
let draftChanges = {};
let currentEditingCell = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadDrafts();
    setupSelectAll();
    setupCheckboxListeners();
});

// ===== LOAD DRAFTS =====
async function loadDrafts() {
    try {
        const response = await fetch('/api/drafts');
        if (!response.ok) {
            throw new Error('Failed to load drafts');
        }

        const data = await response.json();
        const drafts = data.drafts || [];

        const container = document.getElementById('draftsContainer');

        if (drafts.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No drafts found. Create a listing and save it as a draft to see it here.</p>
                </div>
            `;
            return;
        }

        // Build table
        let html = `
            <div class="table-responsive">
                <table class="drafts-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllCheckbox"></th>
                            <th>Photo</th>
                            <th>Title</th>
                            <th>Price</th>
                            <th>Cost</th>
                            <th>Condition</th>
                            <th>Brand</th>
                            <th>Size</th>
                            <th>Color</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        drafts.forEach(draft => {
            const attrs = draft.attributes ? (typeof draft.attributes === 'string' ? JSON.parse(draft.attributes) : draft.attributes) : {};
            const photoUrl = draft.photo_url || '/static/placeholder.png';

            html += `
                <tr class="draft-row" data-draft-id="${draft.id}">
                    <td><input type="checkbox" class="draft-checkbox" value="${draft.id}"></td>
                    <td><img src="${photoUrl}" class="photo-preview" onclick="showPhotoModal('${photoUrl}')"></td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="title" onclick="editCell(this)">${draft.title || ''}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="price" onclick="editCell(this)">$${(draft.price || 0).toFixed(2)}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="cost" onclick="editCell(this)">$${(draft.cost || 0).toFixed(2)}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="condition" onclick="editCell(this)">${draft.condition || ''}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="brand" onclick="editCell(this)">${attrs.brand || ''}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="size" onclick="editCell(this)">${attrs.size || ''}</td>
                    <td class="editable-cell" data-row-id="${draft.id}" data-field="color" onclick="editCell(this)">${attrs.color || ''}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-danger" onclick="deleteDraft(${draft.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
        setupSelectAll();
        setupCheckboxListeners();

    } catch (error) {
        console.error('Error loading drafts:', error);
        document.getElementById('draftsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> Error loading drafts: ${error.message}
            </div>
        `;
    }
}

// ===== SELECTION & CHECKBOX LOGIC =====
function setupSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(e) {
            document.querySelectorAll('.draft-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionBar();
        });
    }
}

function setupCheckboxListeners() {
    document.querySelectorAll('.draft-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionBar);
    });
}

function updateBulkActionBar() {
    const checked = document.querySelectorAll('.draft-checkbox:checked').length;
    const bar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');
    
    countSpan.textContent = `${checked} selected`;
    
    if (checked > 0) {
        bar.classList.add('active');
    } else {
        bar.classList.remove('active');
    }
}

function clearSelection() {
    document.getElementById('selectAllCheckbox').checked = false;
    document.querySelectorAll('.draft-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkActionBar();
}

function getSelectedDraftIds() {
    const selectedIds = [];
    document.querySelectorAll('.draft-checkbox:checked').forEach(checkbox => {
        selectedIds.push(parseInt(checkbox.value));
    });
    return selectedIds;
}

// ===== INLINE EDITING LOGIC =====
function editCell(cell) {
    // Don't edit if already editing
    if (currentEditingCell) return;
    
    const rowId = cell.dataset.rowId;
    const field = cell.dataset.field;
    const currentValue = cell.innerText.replace('$', '').trim();
    
    cell.classList.add('editing');
    currentEditingCell = cell;
    
    let input;
    
    if (field === 'condition') {
        // Condition is a select dropdown
        input = document.createElement('select');
        input.className = 'condition-select';
        const conditions = ['New', 'Like New', 'Good', 'Fair', 'Poor'];
        conditions.forEach(cond => {
            const option = document.createElement('option');
            option.value = cond;
            option.textContent = cond;
            if (cond === currentValue) option.selected = true;
            input.appendChild(option);
        });
    } else {
        // Regular text input
        input = document.createElement('input');
        input.type = field === 'price' || field === 'cost' ? 'number' : 'text';
        input.value = currentValue;
        input.className = 'edit-input';
        if (field === 'price' || field === 'cost') {
            input.step = '0.01';
            input.min = '0';
        }
    }
    
    input.style.width = '100%';
    
    cell.innerText = '';
    cell.appendChild(input);
    input.focus();
    if (input.type === 'text') input.select();
    
    // Save on blur or Enter
    function saveEdit() {
        const newValue = input.value || currentValue;
        recordChange(rowId, field, newValue);
        finishEdit(cell, field, newValue);
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveEdit();
        } else if (e.key === 'Escape') {
            cancelEdit(cell, currentValue, field);
        } else if (e.key === 'Tab') {
            e.preventDefault();
            saveEdit();
            // Move to next editable cell
            const nextCell = getNextEditableCell(cell);
            if (nextCell) {
                setTimeout(() => editCell(nextCell), 100);
            }
        }
    });
}

function recordChange(rowId, field, newValue) {
    if (!draftChanges[rowId]) {
        draftChanges[rowId] = {};
    }
    draftChanges[rowId][field] = newValue;
    showChangesIndicator();
}

function finishEdit(cell, field, newValue) {
    cell.classList.remove('editing');
    cell.classList.add('cell-modified');
    
    // Format display value
    let displayValue = newValue;
    if (field === 'price' || field === 'cost') {
        displayValue = '$' + parseFloat(newValue || 0).toFixed(2);
    }
    
    cell.innerText = displayValue;
    currentEditingCell = null;
}

function cancelEdit(cell, originalValue, field) {
    let displayValue = originalValue;
    if (field === 'price' || field === 'cost') {
        displayValue = '$' + parseFloat(originalValue || 0).toFixed(2);
    }
    
    cell.classList.remove('editing');
    cell.innerText = displayValue;
    currentEditingCell = null;
}

function getNextEditableCell(currentCell) {
    const row = currentCell.closest('tr');
    const editableCells = Array.from(row.querySelectorAll('.editable-cell'));
    const currentIndex = editableCells.indexOf(currentCell);
    
    if (currentIndex < editableCells.length - 1) {
        return editableCells[currentIndex + 1];
    }
    return null;
}

// ===== SAVE & DISCARD =====
function showChangesIndicator() {
    const indicator = document.getElementById('changesIndicator');
    const saveBtn = document.getElementById('saveBtn');
    indicator.classList.add('active');
    saveBtn.style.display = 'block';
}

function hideChangesIndicator() {
    const indicator = document.getElementById('changesIndicator');
    const saveBtn = document.getElementById('saveBtn');
    indicator.classList.remove('active');
    saveBtn.style.display = 'none';
    // Remove highlight from modified cells
    document.querySelectorAll('.cell-modified').forEach(cell => {
        cell.classList.remove('cell-modified');
    });
}

async function saveAllChanges() {
    if (Object.keys(draftChanges).length === 0) {
        showAlert('No changes to save.', 'info');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/api/update-drafts', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ changes: draftChanges })
        });
        
        if (response.ok) {
            const data = await response.json();
            draftChanges = {};
            hideChangesIndicator();
            showAlert('All changes saved successfully!', 'success');
            setTimeout(() => loadDrafts(), 1500);
        } else {
            const error = await response.json();
            showAlert('Save failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Error saving changes: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

function discardChanges() {
    if (confirm('Discard all unsaved changes?')) {
        draftChanges = {};
        hideChangesIndicator();
        loadDrafts();
    }
}

// ===== EXPORT & DELETE =====
async function deleteSelectedDrafts() {
    const selectedIds = getSelectedDraftIds();
    if (selectedIds.length === 0) {
        showAlert('Please select at least one draft to delete.', 'warning');
        return;
    }
    
    if (!confirm(`Delete ${selectedIds.length} draft(s)? This cannot be undone.`)) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/api/drafts/bulk-delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ row_ids: selectedIds })
        });
        
        if (response.ok) {
            const data = await response.json();
            hideLoading();
            showAlert('Drafts deleted successfully!', 'success');
            setTimeout(() => loadDrafts(), 1500);
        } else {
            const error = await response.json();
            hideLoading();
            showAlert('Delete failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error deleting drafts: ' + error.message, 'danger');
    }
}

function exportSelectedToCSV() {
    const selectedIds = getSelectedDraftIds();
    if (selectedIds.length === 0) {
        showAlert('Please select at least one draft to export.', 'warning');
        return;
    }

    let html = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content bg-dark">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-file-export"></i> Select Export Platform</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Choose the platform to format the CSV for:</p>
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('poshmark'); return false;">Poshmark</a>
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('mercari'); return false;">Mercari</a>
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('ebay'); return false;">eBay</a>
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('grailed'); return false;">Grailed</a>
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('depop'); return false;">Depop</a>
                            <a href="#" class="list-group-item list-group-item-action list-group-item-dark" onclick="confirmExport('generic'); return false;">Generic CSV</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById('exportModal');
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML('beforeend', html);
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

async function confirmExport(platform) {
    const selectedIds = getSelectedDraftIds();
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    showLoading();

    try {
        const response = await fetch(`/api/export/csv/${platform}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ listing_ids: selectedIds })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${platform}_export.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            hideLoading();
            showAlert('CSV exported successfully!', 'success');
        } else {
            const error = await response.json();
            hideLoading();
            showAlert('Export failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error exporting CSV: ' + error.message, 'danger');
    }
}

async function deleteDraft(rowId) {
    if (!confirm('Are you sure you want to delete this draft?')) return;

    showLoading();
    try {
        const response = await fetch('/api/drafts/bulk-delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ row_ids: [rowId] })
        });
        
        if (response.ok) {
            const data = await response.json();
            showAlert('Draft deleted successfully.', 'success');
            setTimeout(() => loadDrafts(), 1500);
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to delete draft', 'danger');
        }
    } catch (error) {
        showAlert('An error occurred: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

function showPhotoModal(photoUrl) {
    document.getElementById('photoDisplay').src = photoUrl;
    new bootstrap.Modal(document.getElementById('photoModal')).show();
}
</script>
{% endblock %}