{% extends "base.html" %}

{% block title %}Drafts{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }
    .table th, .table td {
        white-space: nowrap;
        vertical-align: middle;
    }
    .photo-preview {
        max-width: 50px;
        max-height: 50px;
        object-fit: cover;
        border-radius: 4px;
    }
    .action-buttons .btn {
        margin-right: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-folder"></i> Draft Listings</h2>
    <div>
        <button class="btn btn-success" onclick="exportSelectedToCSV()">
            <i class="fas fa-file-export"></i> Export Selected
        </button>
        <a href="{{ url_for('main.create_listing') }}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Create Listing
        </a>
    </div>
</div>

<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i> <strong>How it works:</strong>
    Select the drafts you want to export using the checkboxes, then click "Export Selected". A menu will appear to choose the platform, and a formatted CSV will be downloaded.
</div>

{% if drafts %}
<div class="table-responsive">
    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th><input class="form-check-input" type="checkbox" id="selectAllCheckbox"></th>
                <th>Photo</th>
                <th>Title</th>
                <th>Price</th>
                <th>Cost</th>
                <th>Condition</th>
                <th>Brand</th>
                <th>Size</th>
                <th>Color</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for draft in drafts %}
            <tr>
                <td><input class="form-check-input draft-checkbox" type="checkbox" value="{{ draft.id }}"></td>
                <td>
                    {% if draft.photos and draft.photos|fromjson|length > 0 %}
                    <img src="{{ (draft.photos|fromjson)[0] }}" alt="Photo of {{ draft.title }}" class="photo-preview">
                    {% endif %}
                </td>
                <td>{{ draft.title }}</td>
                <td>${{ "%.2f"|format(draft.price) }}</td>
                <td>${{ "%.2f"|format(draft.cost) if draft.cost else 'N/A' }}</td>
                <td>{{ draft.condition }}</td>
                <td>{{ (draft.attributes|fromjson).brand if draft.attributes else '' }}</td>
                <td>{{ (draft.attributes|fromjson).size if draft.attributes else '' }}</td>
                <td>{{ (draft.attributes|fromjson).color if draft.attributes else '' }}</td>
                <td>{{ draft.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                <td class="action-buttons">
                    <a href="{{ url_for('main.create_listing', draft_id=draft.id) }}" class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i> Edit</a>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDraft({{ draft.id }})"><i class="fas fa-trash"></i> Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center py-5">
    <i class="fas fa-table fa-4x text-muted mb-3"></i>
    <h5>No Drafts Yet</h5>
    <p class="text-muted">Your saved drafts will appear here in a spreadsheet format.</p>
    <a href="{{ url_for('main.create_listing') }}" class="btn btn-primary">
        <i class="fas fa-plus"></i> Create Listing
    </a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('selectAllCheckbox').addEventListener('change', function(e) {
    document.querySelectorAll('.draft-checkbox').forEach(checkbox => {
        checkbox.checked = e.target.checked;
    });
});

function getSelectedDraftIds() {
    const selectedIds = [];
    document.querySelectorAll('.draft-checkbox:checked').forEach(checkbox => {
        selectedIds.push(checkbox.value);
    });
    return selectedIds;
}

function exportSelectedToCSV() {
    const selectedIds = getSelectedDraftIds();
    if (selectedIds.length === 0) {
        showAlert('Please select at least one draft to export.', 'warning');
        return;
    }

    // Show platform selection modal
    let html = `
        <div class="modal fade" id="exportModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title"><i class="fas fa-file-export"></i> Select Export Platform</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Choose the platform to format the CSV for:</p>
                        <div class="list-group">
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('poshmark')">Poshmark</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('mercari')">Mercari</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('ebay')">eBay</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('grailed')">Grailed</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('depop')">Depop</a>
                            <a href="#" class="list-group-item list-group-item-action" onclick="confirmExport('generic')">Generic CSV</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    const existingModal = document.getElementById('exportModal');
    if (existingModal) existingModal.remove();

    document.body.insertAdjacentHTML('beforeend', html);
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

async function confirmExport(platform) {
    const selectedIds = getSelectedDraftIds();
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    showLoading();

    try {
        const response = await fetch(`/api/export/csv/${platform}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ listing_ids: selectedIds })
        });

        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${platform}_export.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            hideLoading();
            showAlert('CSV exported successfully!', 'success');
        } else {
            const error = await response.json();
            hideLoading();
            showAlert('Export failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error exporting CSV: ' + error.message, 'danger');
    }
}

async function deleteDraft(id) {
    if (!confirm('Are you sure you want to delete this draft?')) return;

    showLoading();
    try {
        const response = await fetch(`/api/delete-draft/${id}`, {
            method: 'DELETE'
        });
        const data = await response.json();

        if (data.success) {
            showAlert('Draft deleted successfully.', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert(data.error, 'danger');
        }
    } catch (error) {
        showAlert('An error occurred: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// Helper to parse JSON strings safely in templates
// This needs to be registered in Flask, but for JS, we handle it in the template
// Here is a Jinja2 filter that should be registered in python:
// @app.template_filter('fromjson')
// def fromjson_filter(json_string):
//     if not json_string:
//         return None
//     try:
//         return json.loads(json_string)
//     except (json.JSONDecodeError, TypeError):
//         return None

</script>
{% endblock %}