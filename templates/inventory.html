{% extends "base.html" %}

{% block title %}Inventory{% endblock %}

{% block extra_css %}
<style>
    .table-responsive {
        max-width: 100%;
        overflow-x: auto;
    }
    
    .inventory-table {
        border-collapse: collapse;
        width: 100%;
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    
    .inventory-table th {
        background-color: #2d2d2d;
        padding: 12px;
        text-align: left;
        font-weight: 600;
        border: 1px solid #3d3d3d;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .inventory-table td {
        padding: 10px 12px;
        border: 1px solid #3d3d3d;
        vertical-align: middle;
        white-space: nowrap;
    }
    
    .inventory-table tbody tr:hover {
        background-color: #252525;
    }
    
    .editable-cell {
        cursor: text;
        position: relative;
        background-color: rgba(255, 255, 255, 0.02);
        transition: background-color 0.2s;
        padding: 8px;
        border-radius: 3px;
    }
    
    .editable-cell:hover {
        background-color: rgba(100, 200, 255, 0.1);
    }
    
    .editable-cell.editing input,
    .editable-cell.editing select {
        width: 100%;
        padding: 6px;
        border: 2px solid #64c8ff;
        border-radius: 3px;
        background-color: #2d2d2d;
        color: #e0e0e0;
        font-size: 14px;
    }
    
    .editable-cell.editing input:focus,
    .editable-cell.editing select:focus {
        outline: none;
        box-shadow: 0 0 5px rgba(100, 200, 255, 0.5);
    }
    
    .cell-modified {
        background-color: rgba(255, 193, 7, 0.15) !important;
        border-left: 3px solid #ffc107;
    }
    
    .photo-preview {
        max-width: 50px;
        max-height: 50px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .action-buttons {
        white-space: normal;
        padding: 10px !important;
    }
    
    .action-buttons .btn {
        margin-right: 5px;
        margin-bottom: 5px;
        font-size: 12px;
        padding: 5px 10px;
    }
    
    .bulk-actions-bar {
        background-color: #2d2d2d;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: none;
        gap: 10px;
    }
    
    .bulk-actions-bar.active {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .bulk-actions-bar > span {
        color: #aaa;
        font-size: 14px;
    }
    
    .changes-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #28a745;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        display: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        z-index: 1000;
    }
    
    .changes-indicator.active {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .changes-indicator button {
        padding: 5px 15px;
        background-color: rgba(255, 255, 255, 0.2);
        border: none;
        border-radius: 3px;
        color: white;
        cursor: pointer;
        font-weight: 600;
    }
    
    .changes-indicator button:hover {
        background-color: rgba(255, 255, 255, 0.3);
    }
    
    .inventory-row.deleted {
        opacity: 0.5;
        background-color: rgba(255, 0, 0, 0.1);
    }
    
    .condition-select, .edit-input {
        width: 100%;
        padding: 6px;
        border: 1px solid #444;
        border-radius: 3px;
        background-color: #2d2d2d;
        color: #e0e0e0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-boxes"></i> Inventory (CSV)</h2>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn btn-success" onclick="exportSelectedToCSV()" title="Export selected items as CSV">
            <i class="fas fa-file-export"></i> Export Selected
        </button>
        <button class="btn btn-primary" onclick="addNewItem()">
            <i class="fas fa-plus"></i> Add Item
        </button>
    </div>
</div>

<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i> <strong>How it works:</strong>
    Click on any cell to edit it directly (like Excel). Your changes are highlighted in yellow. Use Tab to move to the next cell. Save all changes at once using the button below.
</div>

<div class="bulk-actions-bar" id="bulkActionsBar">
    <span id="selectedCount">0 selected</span>
    <button class="btn btn-sm btn-danger" onclick="deleteSelectedItems()">
        <i class="fas fa-trash"></i> Delete Selected
    </button>
    <button class="btn btn-sm btn-secondary" onclick="clearSelection()">Clear Selection</button>
</div>

<div id="inventoryContainer">
    <div class="text-center py-5">
        <i class="fas fa-spinner fa-spin fa-3x text-muted mb-3"></i>
        <p class="text-muted">Loading inventory...</p>
    </div>
</div>

<div style="margin-top: 20px; text-align: right;">
    <button class="btn btn-primary btn-lg" onclick="saveAllChanges()" id="saveBtn" style="display: none;">
        <i class="fas fa-save"></i> Save All Changes
    </button>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title">Photo Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="photoDisplay" src="" style="max-width: 100%; max-height: 500px;">
            </div>
        </div>
    </div>
</div>

<div class="changes-indicator" id="changesIndicator">
    <span><i class="fas fa-exclamation-circle"></i> You have unsaved changes</span>
    <button onclick="saveAllChanges()">Save Now</button>
    <button onclick="discardChanges()">Discard</button>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store for tracking changes
let inventoryChanges = {};
let currentEditingCell = null;
let inventoryItems = [];

// Initialize - load inventory from CSV
document.addEventListener('DOMContentLoaded', function() {
    loadInventory();
});

// ===== LOAD INVENTORY FROM CSV =====
async function loadInventory() {
    try {
        const response = await fetch('/api/inventory-csv');
        const data = await response.json();
        
        if (data.success) {
            inventoryItems = data.items;
            renderInventory();
        } else {
            showAlert('Failed to load inventory: ' + (data.error || 'Unknown error'), 'danger');
            document.getElementById('inventoryContainer').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <h5>Error Loading Inventory</h5>
                    <p class="text-muted">${data.error || 'Unknown error'}</p>
                </div>
            `;
        }
    } catch (error) {
        showAlert('Error loading inventory: ' + error.message, 'danger');
        document.getElementById('inventoryContainer').innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5>Error Loading Inventory</h5>
                <p class="text-muted">${error.message}</p>
            </div>
        `;
    }
}

function renderInventory() {
    const container = document.getElementById('inventoryContainer');
    
    if (!inventoryItems || inventoryItems.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-table fa-4x text-muted mb-3"></i>
                <h5>No Inventory Yet</h5>
                <p class="text-muted">Your inventory items will appear here in an editable spreadsheet format.</p>
                <button class="btn btn-primary" onclick="addNewItem()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
        `;
        return;
    }
    
    // Parse photos from comma-separated string
    function parsePhotos(photosStr) {
        if (!photosStr) return [];
        return photosStr.split(',').filter(p => p.trim());
    }
    
    // Format date
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        } catch {
            return dateStr;
        }
    }
    
    let html = `
        <div class="table-responsive">
            <table class="inventory-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input class="form-check-input" type="checkbox" id="selectAllCheckbox" title="Select all"></th>
                        <th style="width: 60px;">Photo</th>
                        <th style="min-width: 150px;">Title</th>
                        <th style="min-width: 80px;">Price</th>
                        <th style="min-width: 80px;">Cost</th>
                        <th style="min-width: 100px;">Condition</th>
                        <th style="min-width: 100px;">Brand</th>
                        <th style="min-width: 80px;">Size</th>
                        <th style="min-width: 80px;">Color</th>
                        <th style="min-width: 120px;">Created At</th>
                        <th style="min-width: 100px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    inventoryItems.forEach((item, idx) => {
        const photos = parsePhotos(item.photos);
        const rowId = item._id !== undefined ? item._id : idx;
        
        html += `
            <tr class="inventory-row" data-row-id="${rowId}">
                <td><input class="form-check-input inventory-checkbox" type="checkbox" value="${rowId}"></td>
                <td>
                    ${photos.length > 0 ? `<img src="${photos[0]}" alt="Photo" class="photo-preview" onclick="showPhotoModal('${photos[0]}')">` : ''}
                </td>
                <td class="editable-cell" data-field="title" data-row-id="${rowId}" onclick="editCell(this)">${item.title || ''}</td>
                <td class="editable-cell" data-field="price" data-row-id="${rowId}" onclick="editCell(this)">$${parseFloat(item.price || 0).toFixed(2)}</td>
                <td class="editable-cell" data-field="cost" data-row-id="${rowId}" onclick="editCell(this)">$${parseFloat(item.cost || 0).toFixed(2)}</td>
                <td class="editable-cell" data-field="condition" data-row-id="${rowId}" onclick="editCell(this)">${item.condition || ''}</td>
                <td class="editable-cell" data-field="brand" data-row-id="${rowId}" onclick="editCell(this)">${item.brand || ''}</td>
                <td class="editable-cell" data-field="size" data-row-id="${rowId}" onclick="editCell(this)">${item.size || ''}</td>
                <td class="editable-cell" data-field="color" data-row-id="${rowId}" onclick="editCell(this)">${item.color || ''}</td>
                <td>${formatDate(item.created_at)}</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${rowId})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
    
    // Setup event listeners
    setupSelectAll();
    setupCheckboxListeners();
}

// ===== SELECTION & CHECKBOX LOGIC =====
function setupSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function(e) {
            document.querySelectorAll('.inventory-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
            updateBulkActionBar();
        });
    }
}

function setupCheckboxListeners() {
    document.querySelectorAll('.inventory-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionBar);
    });
}

function updateBulkActionBar() {
    const checked = document.querySelectorAll('.inventory-checkbox:checked').length;
    const bar = document.getElementById('bulkActionsBar');
    const countSpan = document.getElementById('selectedCount');
    
    if (countSpan) countSpan.textContent = `${checked} selected`;
    
    if (checked > 0) {
        bar.classList.add('active');
    } else {
        bar.classList.remove('active');
    }
}

function clearSelection() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) selectAllCheckbox.checked = false;
    document.querySelectorAll('.inventory-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateBulkActionBar();
}

function getSelectedRowIds() {
    const selectedIds = [];
    document.querySelectorAll('.inventory-checkbox:checked').forEach(checkbox => {
        selectedIds.push(parseInt(checkbox.value));
    });
    return selectedIds;
}

// ===== INLINE EDITING LOGIC =====
function editCell(cell) {
    // Don't edit if already editing
    if (currentEditingCell) return;
    
    const rowId = cell.dataset.rowId;
    const field = cell.dataset.field;
    const currentValue = cell.innerText.replace('$', '').trim();
    
    cell.classList.add('editing');
    currentEditingCell = cell;
    
    let input;
    
    if (field === 'condition') {
        // Condition is a select dropdown
        input = document.createElement('select');
        input.className = 'condition-select';
        const conditions = ['New', 'Like New', 'Good', 'Fair', 'Poor'];
        conditions.forEach(cond => {
            const option = document.createElement('option');
            option.value = cond;
            option.textContent = cond;
            if (cond === currentValue) option.selected = true;
            input.appendChild(option);
        });
    } else {
        // Regular text input
        input = document.createElement('input');
        input.type = field === 'price' || field === 'cost' ? 'number' : 'text';
        input.value = currentValue;
        input.className = 'edit-input';
        if (field === 'price' || field === 'cost') {
            input.step = '0.01';
            input.min = '0';
        }
    }
    
    input.style.width = '100%';
    
    cell.innerText = '';
    cell.appendChild(input);
    input.focus();
    if (input.type === 'text') input.select();
    
    // Save on blur or Enter
    function saveEdit() {
        const newValue = input.value || currentValue;
        recordChange(rowId, field, newValue);
        finishEdit(cell, field, newValue);
    }
    
    input.addEventListener('blur', saveEdit);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            saveEdit();
        } else if (e.key === 'Escape') {
            cancelEdit(cell, currentValue, field);
        } else if (e.key === 'Tab') {
            e.preventDefault();
            saveEdit();
            // Move to next editable cell
            const nextCell = getNextEditableCell(cell);
            if (nextCell) {
                setTimeout(() => editCell(nextCell), 100);
            }
        }
    });
}

function recordChange(rowId, field, newValue) {
    if (!inventoryChanges[rowId]) {
        inventoryChanges[rowId] = {};
    }
    inventoryChanges[rowId][field] = newValue;
    showChangesIndicator();
}

function finishEdit(cell, field, newValue) {
    cell.classList.remove('editing');
    cell.classList.add('cell-modified');
    
    // Format display value
    let displayValue = newValue;
    if (field === 'price' || field === 'cost') {
        displayValue = '$' + parseFloat(newValue || 0).toFixed(2);
    }
    
    cell.innerText = displayValue;
    currentEditingCell = null;
}

function cancelEdit(cell, originalValue, field) {
    let displayValue = originalValue;
    if (field === 'price' || field === 'cost') {
        displayValue = '$' + parseFloat(originalValue || 0).toFixed(2);
    }
    
    cell.classList.remove('editing');
    cell.innerText = displayValue;
    currentEditingCell = null;
}

function getNextEditableCell(currentCell) {
    const row = currentCell.closest('tr');
    const editableCells = Array.from(row.querySelectorAll('.editable-cell'));
    const currentIndex = editableCells.indexOf(currentCell);
    
    if (currentIndex < editableCells.length - 1) {
        return editableCells[currentIndex + 1];
    }
    return null;
}

// ===== SAVE & DISCARD =====
function showChangesIndicator() {
    const indicator = document.getElementById('changesIndicator');
    const saveBtn = document.getElementById('saveBtn');
    indicator.classList.add('active');
    saveBtn.style.display = 'block';
}

function hideChangesIndicator() {
    const indicator = document.getElementById('changesIndicator');
    const saveBtn = document.getElementById('saveBtn');
    indicator.classList.remove('active');
    saveBtn.style.display = 'none';
    // Remove highlight from modified cells
    document.querySelectorAll('.cell-modified').forEach(cell => {
        cell.classList.remove('cell-modified');
    });
}

async function saveAllChanges() {
    if (Object.keys(inventoryChanges).length === 0) {
        showAlert('No changes to save.', 'info');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/api/inventory-csv/update', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ changes: inventoryChanges })
        });
        
        if (response.ok) {
            const data = await response.json();
            inventoryChanges = {};
            hideChangesIndicator();
            showAlert('All changes saved successfully!', 'success');
            setTimeout(() => loadInventory(), 1500);
        } else {
            const error = await response.json();
            showAlert('Save failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        showAlert('Error saving changes: ' + error.message, 'danger');
    } finally {
        hideLoading();
    }
}

function discardChanges() {
    if (confirm('Discard all unsaved changes?')) {
        inventoryChanges = {};
        hideChangesIndicator();
        loadInventory();
    }
}

// ===== DELETE =====
async function deleteSelectedItems() {
    const selectedIds = getSelectedRowIds();
    if (selectedIds.length === 0) {
        showAlert('Please select at least one item to delete.', 'warning');
        return;
    }
    
    if (!confirm(`Delete ${selectedIds.length} item(s)? This cannot be undone.`)) {
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/api/inventory-csv/delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ row_ids: selectedIds })
        });
        
        if (response.ok) {
            const data = await response.json();
            hideLoading();
            showAlert('Items deleted successfully!', 'success');
            setTimeout(() => loadInventory(), 1500);
        } else {
            const error = await response.json();
            hideLoading();
            showAlert('Delete failed: ' + (error.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        hideLoading();
        showAlert('Error deleting items: ' + error.message, 'danger');
    }
}

async function deleteItem(rowId) {
    if (!confirm('Are you sure you want to delete this item?')) return;

    showLoading();
    try {
        const response = await fetch('/api/inventory-csv/delete', {
            method: 'DELETE',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ row_ids: [rowId] })
        });
        
        if (response.ok) {
            const data = await response.json();
            showAlert('Item deleted successfully.', 'success');
            setTimeout(() => loadInventory(), 1500);
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to delete item', 'danger');
        }
    } catch (error) {
        showAlert('An error occurred: ' + error, 'danger');
    } finally {
        hideLoading();
    }
}

// ===== EXPORT =====
function exportSelectedToCSV() {
    const selectedIds = getSelectedRowIds();
    if (selectedIds.length === 0) {
        showAlert('Please select at least one item to export.', 'warning');
        return;
    }
    
    // Simple CSV export
    const selectedItems = inventoryItems.filter((item, idx) => {
        const rowId = item._id !== undefined ? item._id : idx;
        return selectedIds.includes(rowId);
    });
    
    // Convert to CSV
    const headers = ['title', 'description', 'price', 'cost', 'condition', 'item_type', 'brand', 'size', 'color', 'shipping_cost', 'photos', 'created_at', 'updated_at'];
    const csvRows = [headers.join(',')];
    
    selectedItems.forEach(item => {
        const row = headers.map(header => {
            const value = item[header] || '';
            // Escape commas and quotes
            if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                return '"' + value.replace(/"/g, '""') + '"';
            }
            return value;
        });
        csvRows.push(row.join(','));
    });
    
    const csvContent = csvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `inventory_export_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);
    
    showAlert('CSV exported successfully!', 'success');
}

// ===== ADD NEW ITEM =====
function addNewItem() {
    const title = prompt('Enter item title:');
    if (!title) return;
    
    showLoading();
    fetch('/api/inventory-csv/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            title: title,
            description: '',
            price: '0',
            cost: '0',
            condition: 'New',
            item_type: '',
            brand: '',
            size: '',
            color: '',
            shipping_cost: '0',
            photos: ''
        })
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success) {
            showAlert('Item added successfully!', 'success');
            loadInventory();
        } else {
            showAlert('Failed to add item: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        hideLoading();
        showAlert('Error adding item: ' + error.message, 'danger');
    });
}

function showPhotoModal(photoUrl) {
    document.getElementById('photoDisplay').src = photoUrl;
    new bootstrap.Modal(document.getElementById('photoModal')).show();
}
</script>
{% endblock %}
