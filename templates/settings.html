{% extends "base.html" %}

{% block title %}Settings - Rebel Operator{% endblock %}

{% block content %}
<div class="mb-3">
    <h2><i class="fas fa-cog"></i> Platform Settings</h2>
    <p class="text-muted">Configure API credentials for automated posting to platforms</p>
</div>

<div class="alert alert-info mb-3">
    <i class="fas fa-info-circle"></i> <strong>Note:</strong>
    These platforms support <strong>API automation</strong>. For CSV platforms (Poshmark, Ruby Lane, etc.), just use the "Export CSV as" button on the Drafts page - no credentials needed!
</div>

<!-- API Key Platforms -->
<div class="card mb-3">
    <div class="card-header" style="background: var(--alert-crimson);">
        <h5 class="mb-0" style="color: white;"><i class="fas fa-key"></i> API Key Platforms</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small">
            These platforms use API keys for automated posting. <strong>Your credentials are stored securely.</strong>
        </p>

        <!-- Mercari -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-store text-info"></i> Mercari Shops</span>
                <span class="badge bg-secondary" id="mercari-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Requires Mercari Shops account. Get API key from: <a href="https://developer.mercari.com" target="_blank">Mercari Developer Portal</a>
            </p>
            <form class="platform-form" data-platform="mercari" data-type="api_key">
                <div class="mb-2">
                    <label class="form-label small">API Key</label>
                    <input type="password" class="form-control form-control-sm" name="api_key" placeholder="Your Mercari API Key">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Mercari
                </button>
            </form>
        </div>

        <!-- Depop -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tshirt text-danger"></i> Depop</span>
                <span class="badge bg-secondary" id="depop-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Requires API approval. Apply at: <a href="https://api.depop.com" target="_blank">Depop API</a>
            </p>
            <form class="platform-form" data-platform="depop" data-type="api_key">
                <div class="mb-2">
                    <label class="form-label small">API Key</label>
                    <input type="password" class="form-control form-control-sm" name="api_key" placeholder="Your Depop API Key">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Depop
                </button>
            </form>
        </div>

        <!-- Etsy -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shopping-bag text-warning"></i> Etsy</span>
                <span class="badge bg-secondary" id="etsy-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get your API key from: <a href="https://www.etsy.com/developers" target="_blank">Etsy Developer Portal</a>
            </p>
            <form class="platform-form" data-platform="etsy" data-type="api_key">
                <div class="mb-2">
                    <label class="form-label small">API Key</label>
                    <input type="password" class="form-control form-control-sm" name="api_key" placeholder="Your Etsy API Key">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Shop ID</label>
                    <input type="text" class="form-control form-control-sm" name="shop_id" placeholder="Your Etsy Shop ID">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Etsy
                </button>
            </form>
        </div>
    </div>
</div>

<!-- OAuth / Token Platforms -->
<div class="card mb-3">
    <div class="card-header" style="background: var(--cold-steel);">
        <h5 class="mb-0" style="color: white;"><i class="fas fa-lock"></i> OAuth / Token Platforms</h5>
    </div>
    <div class="card-body">
        <p class="text-muted small">
            These platforms use OAuth tokens or access tokens for automated API posting.
        </p>

        <!-- eBay -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-gavel text-primary"></i> eBay</span>
                <span class="badge bg-secondary" id="ebay-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get OAuth token from: <a href="https://developer.ebay.com" target="_blank">eBay Developers</a>
            </p>
            <form class="platform-form" data-platform="ebay" data-type="oauth">
                <div class="mb-2">
                    <label class="form-label small">OAuth Token</label>
                    <input type="password" class="form-control form-control-sm" name="oauth_token" placeholder="Your eBay OAuth Token">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save eBay
                </button>
            </form>
        </div>

        <!-- Shopify -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-shopping-cart text-success"></i> Shopify</span>
                <span class="badge bg-secondary" id="shopify-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get access token from: Shopify Admin → Apps → Develop Apps
            </p>
            <form class="platform-form" data-platform="shopify" data-type="token">
                <div class="mb-2">
                    <label class="form-label small">Store URL</label>
                    <input type="text" class="form-control form-control-sm" name="store_url" placeholder="yourstore.myshopify.com">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Access Token</label>
                    <input type="password" class="form-control form-control-sm" name="access_token" placeholder="Your Shopify Access Token">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Shopify
                </button>
            </form>
        </div>

        <!-- WooCommerce -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-wordpress text-primary"></i> WooCommerce</span>
                <span class="badge bg-secondary" id="woocommerce-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get API keys from: WordPress Admin → WooCommerce → Settings → Advanced → REST API
            </p>
            <form class="platform-form" data-platform="woocommerce" data-type="api_secret">
                <div class="mb-2">
                    <label class="form-label small">Store URL</label>
                    <input type="text" class="form-control form-control-sm" name="store_url" placeholder="https://yoursite.com">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Consumer Key</label>
                    <input type="text" class="form-control form-control-sm" name="consumer_key" placeholder="ck_...">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Consumer Secret</label>
                    <input type="password" class="form-control form-control-sm" name="consumer_secret" placeholder="cs_...">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save WooCommerce
                </button>
            </form>
        </div>

        <!-- Facebook Shops -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fab fa-facebook text-primary"></i> Facebook Shops</span>
                <span class="badge bg-secondary" id="facebook-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get access token from: <a href="https://developers.facebook.com/" target="_blank">Facebook for Developers</a>
            </p>
            <form class="platform-form" data-platform="facebook" data-type="oauth">
                <div class="mb-2">
                    <label class="form-label small">Page Access Token</label>
                    <input type="password" class="form-control form-control-sm" name="access_token" placeholder="Your Facebook Page Access Token">
                </div>
                <div class="mb-2">
                    <label class="form-label small">Catalog ID</label>
                    <input type="text" class="form-control form-control-sm" name="catalog_id" placeholder="Your Facebook Catalog ID">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Facebook
                </button>
            </form>
        </div>

        <!-- Pinterest -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fab fa-pinterest text-danger"></i> Pinterest</span>
                <span class="badge bg-secondary" id="pinterest-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get OAuth token from: <a href="https://developers.pinterest.com/" target="_blank">Pinterest Developers</a>
            </p>
            <form class="platform-form" data-platform="pinterest" data-type="oauth">
                <div class="mb-2">
                    <label class="form-label small">OAuth Token</label>
                    <input type="password" class="form-control form-control-sm" name="oauth_token" placeholder="Your Pinterest OAuth Token">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Pinterest
                </button>
            </form>
        </div>

        <!-- Square -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-square text-info"></i> Square</span>
                <span class="badge bg-secondary" id="square-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get OAuth token from: <a href="https://developer.squareup.com/" target="_blank">Square Developer Portal</a>
            </p>
            <form class="platform-form" data-platform="square" data-type="oauth">
                <div class="mb-2">
                    <label class="form-label small">Access Token</label>
                    <input type="password" class="form-control form-control-sm" name="access_token" placeholder="Your Square Access Token">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Square
                </button>
            </form>
        </div>

        <!-- Bonanza -->
        <div class="border rounded p-3 mb-3" style="border-color: var(--cold-steel-dark);">
            <h6 class="d-flex justify-content-between align-items-center">
                <span><i class="fas fa-gem text-warning"></i> Bonanza</span>
                <span class="badge bg-secondary" id="bonanza-status">Not Configured</span>
            </h6>
            <p class="small text-muted">
                Get API credentials from: <a href="https://www.bonanza.com/developer_api" target="_blank">Bonanza Developer</a>
            </p>
            <form class="platform-form" data-platform="bonanza" data-type="api_secret">
                <div class="mb-2">
                    <label class="form-label small">API Key</label>
                    <input type="text" class="form-control form-control-sm" name="api_key" placeholder="Your Bonanza API Key">
                </div>
                <div class="mb-2">
                    <label class="form-label small">API Secret</label>
                    <input type="password" class="form-control form-control-sm" name="api_secret" placeholder="Your Bonanza API Secret">
                </div>
                <button type="submit" class="btn btn-sm btn-primary">
                    <i class="fas fa-save"></i> Save Bonanza
                </button>
            </form>
        </div>
    </div>
</div>

<div class="alert alert-success">
    <i class="fas fa-check-circle"></i> <strong>CSV Platforms (Poshmark, Ruby Lane, etc.):</strong>
    No credentials needed! Just go to your <a href="{{ url_for('drafts') }}" class="alert-link">Drafts page</a> and use "Export CSV as" to download platform-specific files.
</div>

{% endblock %}

{% block extra_js %}
<script>
// Handle all platform forms
document.querySelectorAll('.platform-form').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        showLoading();

        const platform = this.dataset.platform;
        const type = this.dataset.type;
        const formData = new FormData(this);
        const credentials = {};

        // Collect all form fields
        for (const [key, value] of formData.entries()) {
            if (value.trim()) {
                credentials[key] = value;
            }
        }

        // Validate required fields
        if (Object.keys(credentials).length === 0) {
            hideLoading();
            showAlert('Please fill in at least one field', 'warning');
            return;
        }

        try {
            const response = await fetch('/api/settings/platform-credentials', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    platform,
                    type,
                    credentials
                })
            });

            const data = await response.json();
            hideLoading();

            if (data.success) {
                showAlert(`${platform.charAt(0).toUpperCase() + platform.slice(1)} credentials saved successfully!`, 'success');
                // Update status badge
                const statusBadge = document.getElementById(`${platform}-status`);
                if (statusBadge) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Configured';
                }
            } else {
                showAlert(data.error || 'Failed to save credentials', 'danger');
            }
        } catch (error) {
            hideLoading();
            showAlert('Error: ' + error.message, 'danger');
        }
    });
});

// Load existing credentials on page load
window.addEventListener('load', async function() {
    try {
        const response = await fetch('/api/settings/platform-credentials');
        const data = await response.json();

        if (data.success && data.credentials) {
            // Update status badges for configured platforms
            Object.keys(data.credentials).forEach(platform => {
                const statusBadge = document.getElementById(`${platform}-status`);
                if (statusBadge) {
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Configured';
                }
            });
        }
    } catch (error) {
        console.error('Error loading credentials:', error);
    }
});
</script>
{% endblock %}
